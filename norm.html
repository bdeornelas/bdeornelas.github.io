<!DOCTYPE html>
<html lang="it">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilazione Rapida Visita Cardiologica</title>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-gray: #f4f4f4;
            --border-color: #dee2e6;
            --text-color: #333;
            --text-muted: #6c757d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .container {
            max-width: 1800px;
            margin: 10px auto;
            padding: 0;
            background-color: #fff;
            box-shadow: var(--shadow-lg);
            border-radius: 8px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
        }

        .main-layout {
            display: flex;
            gap: 0;
            align-items: flex-start;
        }

        .form-column {
            flex: 0 0 68%;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-column {
            flex: 0 0 32%;
            position: sticky;
            top: 10px;
            max-height: calc(100vh - 20px);
            overflow-y: auto;
            padding-bottom: 10px;
        }

        .output-section-wrapper {
            width: 100%;
            background-color: #fff;
            border-top: 3px solid var(--primary-color);
            padding: 20px;
        }

        .output-section-wrapper h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        #output-visita {
            width: 100%;
            max-width: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            font-size: 0.9em;
            line-height: 1.6;
            min-height: 200px;
            resize: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-color);
        }

        .section {
            margin: 0;
            border: none;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
            transition: background-color 0.2s ease;
        }

        .section:last-child { border-bottom: none; }

        .section:hover { background-color: #fafbfc; }

        h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 400;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.05em;
            font-weight: 600;
            margin: 0 0 10px 0;
            padding: 0 0 6px 0;
            border-bottom: 2px solid var(--accent-color);
            position: relative;
        }

        h3 { color: var(--accent-color); font-size: 0.95em; margin: 8px 0 6px 0; font-weight: 500; }

        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-color); font-size: 0.85em; }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 7px 10px;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85em;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }
        input[readonly] { background-color: #e9ecef !important; cursor: not-allowed; }

        textarea { resize: vertical; font-family: inherit; min-height: 40px; }

        .form-group { margin-bottom: 10px; }

        .form-row { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 8px; flex-wrap: wrap; }
        .form-row>div { flex: 1; min-width: 160px; }

        input[type="checkbox"], input[type="radio"] { margin-right: 8px; transform: scale(1.2); accent-color: var(--accent-color); }

        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 8px 15px; margin: 8px 0; }

        .checkbox-item, .radio-item { display: flex; align-items: center; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s ease; }
        .checkbox-item:hover, .radio-item:hover { background-color: rgba(0, 123, 255, 0.05); }

        .label-inline { margin: 0; font-weight: 500; cursor: pointer; user-select: none; font-size: 0.85em; }

        .checkbox-notification {
            display: none; font-size: 0.8em; font-weight: 600; margin-left: 6px;
            padding: 2px 6px; border-radius: 10px; color: white;
        }
        .checkbox-notification.success { background-color: var(--success-color); }
        .checkbox-notification.info { background-color: var(--info-color); }
        .checkbox-notification.warning { background-color: var(--warning-color); color: var(--text-color); }
        .checkbox-notification.contact { background-color: var(--info-color); }

        .terapia-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px 15px;
        }
        .terapia-grid > div {
            display: flex;
            gap: 8px;
        }
        .terapia-grid > div > input:first-child { flex: 2; }
        .terapia-grid > div > input:last-child { flex: 1; }

        .score-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px; padding: 10px; margin: 8px 0; border: 1px solid var(--border-color);
        }
        .score-result { background: white; padding: 10px; border-radius: 4px; text-align: center; margin: 8px 0; border: 2px solid var(--danger-color); }

        button.main-action {
            width: 100%; padding: 12px 16px; font-size: 0.95em; font-weight: 600; cursor: pointer;
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white; border: none; border-radius: 6px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: var(--shadow);
        }
        button.main-action:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); background: linear-gradient(135deg, #218838 0%, #1e7e34 100%); }
        button.main-action:active { transform: translateY(0); }

        .copy-notification {
            display: none; color: var(--success-color); margin-top: 15px; font-weight: 600; text-align: center;
            padding: 10px; background-color: rgba(40, 167, 69, 0.1); border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);
        }

        #score2-result-display {
            font-weight: bold; color: var(--danger-color); font-size: 1.25em;
            padding: 6px 12px; background-color: rgba(220, 53, 69, 0.1); border-radius: 6px; display: inline-block;
        }

        .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 8px; padding: 10px; background-color: rgba(220, 53, 69, 0.1); border-radius: 6px; border-left: 4px solid var(--danger-color); }

        .info-message { color: var(--info-color); background-color: rgba(23, 162, 184, 0.1); border-left: 4px solid var(--info-color); padding: 10px; border-radius: 6px; margin: 10px 0; }

        /* (AI review non presente su /normale) */

        .note { font-size: 0.75em; color: var(--text-muted); display: block; margin-top: -3px; margin-bottom: 5px; font-style: italic; }

        .card { background: white; border-radius: 4px; padding: 10px; margin: 8px 0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid var(--border-color); }

        .anamnesi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .anamnesi-grid > div {
            min-height: 0;
        }

        .anamnesi-grid label {
            margin-bottom: 4px;
            font-size: 0.85em;
        }

        .anamnesi-grid textarea {
            min-height: 40px;
            rows: 1;
        }

        .esame-obiettivo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .conclusioni-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px 10px;
        }

        .radio-inline-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 8px 0;
        }

        @media (min-width: 1600px) {
            .container { max-width: 1850px; }
            .form-column { flex: 0 0 70%; }
            .sidebar-column { flex: 0 0 30%; }
            .anamnesi-grid { gap: 20px; }
            .terapia-grid { gap: 12px 20px; }
        }

        @media (max-width: 1400px) {
            .form-column { flex: 0 0 65%; }
            .sidebar-column { flex: 0 0 35%; }
            .terapia-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 8px; }
            .section { padding: 20px; }
            .form-row { flex-direction: column; gap: 0; }
            .checkbox-group, .radio-group { flex-direction: column; gap: 10px; }
            .terapia-row { flex-direction: column; gap: 0; }
            .anamnesi-grid, .terapia-grid { grid-template-columns: 1fr; }
            .main-layout { flex-direction: column; }
            .form-column, .sidebar-column { flex: 1; border: none; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.2em; }
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .options-row { display:flex; gap:20px; align-items:center; flex-wrap:wrap; }

        /* Scenario tree menu - fully cascading with solid backgrounds */
        .scenario-tree-menu { position: relative; margin-top: 8px; }
        .scenario-tree-menu ul { list-style: none; margin: 0; padding: 0; }
        .scenario-menu-root {
            display: flex; flex-direction: column; gap: 2px;
            background: #ffffff; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 6px; max-width: 320px;
        }
        .scenario-tree-menu li { position: relative; }
        .scenario-tree-menu a, .menu-parent {
            display: block; padding: 10px 14px; background: #f8f9fa;
            border-radius: 6px; color: var(--text-color); text-decoration: none;
            font-size: 0.9em; cursor: pointer; transition: all 0.15s;
        }
        .scenario-tree-menu a:hover, .menu-parent:hover {
            background: var(--primary-color); color: #ffffff;
        }
        .submenu {
            display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;
            background: #ffffff; border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            min-width: 200px; z-index: 1000; padding: 6px;
        }
        .has-submenu:hover > .submenu { display: block; }
        .scenario-selected-badge {
            margin-top: 10px; padding: 10px 14px; background: #198754;
            color: #ffffff; border-radius: 6px; font-size: 0.9em;
        }

        /* Editor Scenari - Full Modal */
        #scenari-editor-toggle {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            background: #0d6efd; color: white; border: none; padding: 12px 20px;
            border-radius: 50px; cursor: pointer; font-size: 14px; font-weight: 600;
            box-shadow: 0 4px 15px rgba(13,110,253,0.4);
        }
        #scenari-editor-toggle:hover { background: #0b5ed7; transform: scale(1.05); }
        #scenari-editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.5); z-index: 1000;
        }
        #scenari-editor-overlay.open { display: block; }
        #scenari-editor-panel {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95vw; max-width: 1400px; height: 90vh;
            background: white; box-shadow: 0 25px 80px rgba(0,0,0,0.3); z-index: 1001;
            border-radius: 16px; overflow: hidden;
        }
        #scenari-editor-panel.open { display: flex; flex-direction: column; }
        .editor-header {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .editor-header h2 { margin: 0; font-size: 1.5em; font-weight: 600; }
        .editor-header .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        .editor-header .close-btn:hover { background: rgba(255,255,255,0.3); }
        .editor-body { flex: 1; display: flex; overflow: hidden; }
        .editor-sidebar { width: 280px; background: #f8f9fa; border-right: 1px solid #dee2e6; padding: 20px; overflow-y: auto; }
        .editor-main { flex: 1; padding: 25px; overflow-y: auto; }
        .editor-tabs { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .editor-tab { padding: 14px 18px; background: white; border: 1px solid #dee2e6; border-radius: 10px; cursor: pointer; font-size: 14px; text-align: left; transition: all 0.2s; }
        .editor-tab:hover { border-color: #0d6efd; background: #f0f7ff; }
        .editor-tab.active { background: #0d6efd; color: white; border-color: #0d6efd; font-weight: 600; }
        .editor-tab-content { display: none; }
        .editor-tab-content.active { display: block; }
        .scenario-item { border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 15px; background: white; overflow: hidden; }
        .scenario-item.expanded { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .scenario-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fafbfc; border-bottom: 1px solid transparent; }
        .scenario-item.expanded .scenario-header { border-bottom-color: #e0e0e0; background: #f0f7ff; }
        .scenario-header h4 { margin: 0; font-size: 15px; font-weight: 600; }
        .scenario-content { display: none; padding: 20px; }
        .scenario-item.expanded .scenario-content { display: block; }
        .scenario-content label { display: block; font-size: 13px; font-weight: 600; margin: 12px 0 6px; color: #495057; }
        .scenario-content input, .scenario-content textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        .scenario-content input:focus, .scenario-content textarea:focus { border-color: #0d6efd; outline: none; box-shadow: 0 0 0 3px rgba(13,110,253,0.15); }
        .scenario-content textarea { min-height: 120px; resize: vertical; font-family: inherit; }
        .editor-actions { padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; gap: 12px; justify-content: flex-end; }
        .editor-actions button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn-save { background: #198754; color: white; }
        .btn-save:hover { background: #157347; }
        .btn-add { background: #0d6efd; color: white; }
        .btn-add:hover { background: #0b5ed7; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .github-token-section { background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .github-token-section input { margin-top: 8px; padding: 12px; border-radius: 8px; }
        .status-msg { padding: 12px 16px; border-radius: 8px; margin-top: 15px; font-size: 14px; }
        .status-msg.success { background: #d1e7dd; color: #0f5132; }
        .status-msg.error { background: #f8d7da; color: #842029; }
        /* Tree Builder for Cascading Scenarios */
        .tree-builder { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 15px; }
        .tree-node { margin-left: 24px; border-left: 2px solid #dee2e6; padding-left: 16px; margin-top: 8px; }
        .tree-node-root { margin-left: 0; border-left: none; padding-left: 0; }
        .tree-node-item { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .tree-node-item.branch { background: #e8f4fd; border-color: #b6d4fe; }
        .tree-node-item.leaf { background: #d1e7dd; border-color: #a3cfbb; }
        .tree-node-label { flex: 1; font-weight: 500; }
        .tree-node-type { font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #6c757d; color: white; }
        .tree-node-item.branch .tree-node-type { background: #0d6efd; }
        .tree-node-item.leaf .tree-node-type { background: #198754; }
        .tree-node-actions { display: flex; gap: 6px; }
        .tree-node-actions button { padding: 4px 8px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; }
        .tree-add-btn { background: #0d6efd; color: white; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 10px; }
        .tree-add-btn:hover { background: #0b5ed7; }
        .cascading-scenario { border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .cascading-header { padding: 16px 20px; background: linear-gradient(135deg, #e8f4fd 0%, #cfe2ff 100%); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .cascading-header h4 { margin: 0; color: #0d47a1; font-size: 16px; }
        .cascading-body { display: none; padding: 20px; }
        .cascading-scenario.expanded .cascading-body { display: block; }
        .cascading-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .cascading-info input { padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; }
        /* Unified Scenario Styles */
        .unified-scenario { background: white; border: 1px solid #dee2e6; border-radius: 10px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .unified-scenario.cascading { border-left: 4px solid #1976d2; }
        .unified-scenario.simple { border-left: 4px solid #4caf50; }
        .unified-scenario-header { display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: #f8f9fa; cursor: pointer; transition: background 0.2s; }
        .unified-scenario-header:hover { background: #e9ecef; }
        .unified-scenario-header h4 { flex: 1; margin: 0; font-size: 15px; color: #212529; }
        .unified-scenario-header .expand-icon { color: #6c757d; font-size: 12px; transition: transform 0.2s; }
        .unified-scenario.expanded .expand-icon { transform: rotate(180deg); }
        .unified-scenario-body { display: none; padding: 20px; border-top: 1px solid #dee2e6; }
        .unified-scenario.expanded .unified-scenario-body { display: block; }
        .badge-simple, .badge-cascading { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        .badge-simple { background: #d4edda; color: #155724; }
        .badge-cascading { background: #cce5ff; color: #004085; }
        .scenario-field { margin-bottom: 16px; }
        .scenario-field label { display: block; font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 6px; }
        .scenario-field input, .scenario-field textarea { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; transition: border-color 0.2s, box-shadow 0.2s; }
        .scenario-field input:focus, .scenario-field textarea:focus { border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.12); outline: none; }
        .scenario-field textarea { resize: vertical; min-height: 100px; }
        .levels-section, .texts-section { background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-header strong { font-size: 13px; color: #495057; }
        .btn-small { background: #1976d2; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
        .btn-small:hover { background: #1565c0; }
        .level-item { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .level-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .level-num { background: #1976d2; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }
        .level-header strong { flex: 1; font-size: 13px; }
        .level-header code { background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #495057; }
        .level-options { font-size: 12px; color: #6c757d; }
        .level-condition { font-size: 11px; color: #6c757d; margin-top: 6px; }
        .level-condition code { background: #fff3cd; padding: 2px 6px; border-radius: 3px; }
        .btn-delete-small { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1; }
        .btn-delete-small:hover { color: #a71d2a; }
        .text-item { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .text-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .text-header code { background: #e2e3e5; padding: 3px 10px; border-radius: 4px; font-size: 12px; color: #383d41; }
        .text-item textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; resize: vertical; min-height: 80px; }
        .no-items { color: #6c757d; font-size: 13px; font-style: italic; margin: 0; }
        .scenario-actions { display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid #dee2e6; margin-top: 16px; }
        .btn-convert { background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: background 0.2s; }
        .btn-convert:hover { background: #5a32a3; }
    </style>
    <script>
        let aggiungereConsigliLipidi = false;

        const consigliLipidiText = `Profilo lipidico non ottimale.
Per favorire la riduzione del colesterolo LDL (valori desiderati < 116 mg/dL), √® consigliabile seguire alcune semplici indicazioni nutrizionali:

Alimenti da Privilegiare nella Dieta Quotidiana:
Verdura: Consumare porzioni abbondanti ad ogni pasto, variando i tipi e i colori. Sia fresca che surgelata al naturale sono valide scelte.
Frutta: Includere regolarmente frutta fresca di stagione, importante fonte di vitamine, minerali e fibre.
Cereali Integrali: Preferire sistematicamente le versioni integrali di pane, pasta, riso. Includere anche avena, orzo, farro per massimizzare l'apporto di fibre benefiche.
Legumi: Inserire frequentemente lenticchie, ceci, fagioli, piselli. Sono un'ottima fonte di proteine vegetali e fibre che aiutano a controllare il colesterolo.
Pesce: Consumare pesce 2-3 volte a settimana, privilegiando variet√† ricche di Omega-3 (come salmone, sgombro, sardine, acciughe).
Frutta Secca e Semi Oleosi: Una piccola quantit√† giornaliera (es. 30g) di noci, mandorle, nocciole o semi (lino, chia, zucca) apporta grassi sani e fibre (attenzione alle calorie).
Grassi Sani: Utilizzare Olio Extravergine d'Oliva come condimento principale, preferibilmente a crudo. Altri oli vegetali (es. canola) possono essere usati con moderazione per cucinare. Avocado e olive sono altre buone fonti.
Fonti Proteiche Magre: Alternare il pesce con pollame senza pelle (pollo, tacchino) e le gi√† citate proteine vegetali (legumi).
Latticini (con Moderazione): Se consumati, scegliere versioni a basso contenuto di grassi come yogurt bianco naturale non zuccherato o latte parzialmente scremato.
Bevande: L'acqua √® la bevanda principale. T√® verde e tisane non zuccherate sono valide alternative.

Alimenti da Limitare Significativamente o Evitare:
Grassi Saturi: Ridurre il consumo di burro, panna, strutto, formaggi grassi e stagionati, oli tropicali (palma, cocco).
Grassi Trans: Evitare prodotti contenenti "grassi (parzialmente) idrogenati" (controllare attentamente le etichette di prodotti da forno industriali, snack, margarine).
Carni Rosse: Limitarne il consumo (manzo, maiale) a non pi√π di 1-2 volte a settimana.
Carni Lavorate: Evitare o consumare solo eccezionalmente insaccati, salumi, wurstel, bacon.
Alimenti Ultra-Processati: Ridurre al minimo cibi pronti, snack confezionati, patatine, merendine, fast food. Sono spesso ricchi di grassi non sani, zuccheri aggiunti e sale.
Zuccheri Aggiunti: Limitarne fortemente dolci, dessert, biscotti. Eliminare bevande zuccherate (bibite gassate, succhi di frutta industriali, t√® freddi zuccherati). Preferire sempre il frutto intero ai succhi, anche se 100% frutta.
Cibi Fritti: Evitare la frittura come metodo di cottura abituale.
Alcol: Limitarne fortemente il consumo o, preferibilmente, evitarlo.

Consigli Pratici Quotidiani:
Metodi di Cottura: Privilegiare cotture semplici (vapore, griglia, forno, bollitura) che richiedono pochi grassi aggiunti.
Apporto di Fibre: Assicurare un adeguato consumo di fibre attraverso verdura, frutta, legumi e cereali integrali in ogni pasto.
Leggere le Etichette: Prendere l'abitudine di controllare le informazioni nutrizionali, in particolare il contenuto di grassi saturi, zuccheri e sodio (sale).
Controllo delle Porzioni: Prestare attenzione alle quantit√† consumate, anche per gli alimenti sani.
Stile di Vita Completo: Ricordare che la dieta √® pi√π efficace se inserita in uno stile di vita che comprende attivit√† fisica regolare e il mantenimento di un peso corporeo sano.`;

        function formatText(text, indent, trim = true) {
            if (!text) return "";
            const cleanedText = trim ? text.trim() : text;
            if (!cleanedText) return "";
            return cleanedText
                .split('\n')
                .map(line => line.trim() ? `${indent}${line.trim()}` : '')
                .filter(line => line)
                .join('\n');
        }

        function toBold(text) {
            const boldMap = {
                'A': 'ùóî', 'B': 'ùóï', 'C': 'ùóñ', 'D': 'ùóó', 'E': 'ùóò', 'F': 'ùóô', 'G': 'ùóö', 'H': 'ùóõ', 'I': 'ùóú',
                'J': 'ùóù', 'K': 'ùóû', 'L': 'ùóü', 'M': 'ùó†', 'N': 'ùó°', 'O': 'ùó¢', 'P': 'ùó£', 'Q': 'ùó§', 'R': 'ùó•',
                'S': 'ùó¶', 'T': 'ùóß', 'U': 'ùó®', 'V': 'ùó©', 'W': 'ùó™', 'X': 'ùó´', 'Y': 'ùó¨', 'Z': 'ùó≠',
                'a': 'ùóÆ', 'b': 'ùóØ', 'c': 'ùó∞', 'd': 'ùó±', 'e': 'ùó≤', 'f': 'ùó≥', 'g': 'ùó¥', 'h': 'ùóµ', 'i': 'ùó∂',
                'j': 'ùó∑', 'k': 'ùó∏', 'l': 'ùóπ', 'm': 'ùó∫', 'n': 'ùóª', 'o': 'ùóº', 'p': 'ùóΩ', 'q': 'ùóæ', 'r': 'ùóø',
                's': 'ùòÄ', 't': 'ùòÅ', 'u': 'ùòÇ', 'v': 'ùòÉ', 'w': 'ùòÑ', 'x': 'ùòÖ', 'y': 'ùòÜ', 'z': 'ùòá',
                '0': 'ùü¨', '1': 'ùü≠', '2': 'ùüÆ', '3': 'ùüØ', '4': 'ùü∞', '5': 'ùü±', '6': 'ùü≤', '7': 'ùü≥', '8': 'ùü¥', '9': 'ùüµ'
            };
            return text.split('').map(c => boldMap[c] || c).join('');
        }

        function formatSection(title, content, indent, separator) {
            if (!content || !content.trim()) return "";
            if (!title) return `${content}\n${separator}`;
            return `${toBold(title)}\n${content}\n${separator}`;
        }

        // --- Sanitizzazione per stampa ---
        function removeEmojis(str) {
            // Rimuove la maggior parte degli emoji/simboli piktografici
            return str.replace(/[\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{27BF}]/gu, '');
        }
        function toLatin1Safe(str) {
            // Sostituzioni tipografiche "sicure"
            const map = {
                '‚Äú':'"', '‚Äù':'"', '‚Äû':'"', '¬´':'"', '¬ª':'"',
                '‚Äò':"'", '‚Äô':"'", '‚Äö':"'", '¬¥':"'", '¬∏':',',
                '‚Äî':'-', '‚Äì':'-', '-':'-', '‚àí':'-', '‚Ä¢':'-',
                '‚Ä¶':'...', '‚Üí':'->', '‚Üê':'<-', '‚Üî':'<->',
                '√ó':'x', '√∑':'/', '¬∞':' deg ', '¬∫':' deg ', '¬™':'a',
                '‚â•':'>=', '‚â§':'<=', '¬±':'+/-', '-':'-',
                '\u00A0':' ' // NBSP
            };
            return removeEmojis(str).replace(/["‚Äú‚Äù‚Äû¬´¬ª‚Äò‚Äô‚Äö¬¥¬∏‚Äî‚Äì-‚àí‚Ä¢‚Ä¶‚Üí‚Üê‚Üî√ó√∑¬∞¬∫¬™‚â•‚â§¬±\u00A0]/g, ch => map[ch] || ch);
        }
        function stripAccents(str) {
            // Rimuove i segni diacritici (accenti) dopo normalizzazione
            return str.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
        }
        function sanitizeForPrint(text, mode) {
            let t = toLatin1Safe(text);
            if (mode === 'ascii') {
                t = stripAccents(t);
                // Elimina qualunque carattere non-ASCII rimasto
                t = t.replace(/[^\x00-\x7F]/g, '');
            }
            return t;
        }
        function normalizeLineEndings(text, useCRLF) {
            const t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            return useCRLF ? t.replace(/\n/g, '\r\n') : t;
        }
        // --- Fine sanitizzazione ---
        
        function calculateAndDisplayLdl() {
            const colTotInput = document.getElementById("col-tot");
            const colHdlInput = document.getElementById("col-hdl");
            const trigliceridiInput = document.getElementById("trigliceridi-score");
            const ldlResultInput = document.getElementById("ldl-calculated");
            const ldlNote = document.getElementById("ldl-calculation-note");

            const colTot = parseFloat(colTotInput.value);
            const hdl = parseFloat(colHdlInput.value);
            const trig = parseFloat(trigliceridiInput.value);

            ldlResultInput.value = "";
            ldlNote.textContent = "Calcolato con formula di Friedewald (valido per Trigliceridi < 400 mg/dL).";
            ldlNote.style.color = "var(--text-muted)";

            if (!colTot || !hdl || !trig || colTot <= 0 || hdl <= 0 || trig <= 0) return;

            if (trig >= 400) {
                ldlResultInput.value = "N/A";
                ldlNote.textContent = "Non calcolabile: i trigliceridi devono essere < 400 mg/dL.";
                ldlNote.style.color = "var(--danger-color)";
                return;
            }

            if ((hdl + (trig / 5)) >= colTot) {
                ldlResultInput.value = "N/A";
                ldlNote.textContent = "Dati incoerenti (Totale <= HDL + VLDL).";
                ldlNote.style.color = "var(--danger-color)";
                return;
            }

            const ldl = colTot - hdl - (trig / 5);
            ldlResultInput.value = ldl.toFixed(0);
        }

        function calculateScore2() {
            const ageInput = document.getElementById("age");
            const sexRadio = document.querySelector('input[name="sex"]:checked');
            const sbpInput = document.getElementById("sbp");
            const colTotInput = document.getElementById("col-tot");
            const colHdlInput = document.getElementById("col-hdl");
            const smokerCheckbox = document.getElementById("fumo");
            const regionRadio = document.querySelector('input[name="risk_region"]:checked');
            const resultDisplay = document.getElementById("score2-result-display");
            const errorDisplay = document.getElementById("score2-error");
            resultDisplay.textContent = "-";
            errorDisplay.textContent = "";
            const age = parseInt(ageInput.value, 10);
            if (isNaN(age) || age < 40 || age > 69) {
                errorDisplay.textContent = "Et√† non valida o fuori range (SCORE2 √® per 40-69 anni).";
                return null;
            }
            if (!sexRadio) { errorDisplay.textContent = "Selezionare il sesso."; return null; }
            const sex = sexRadio.value;
            const sbp = parseInt(sbpInput.value, 10);
            if (isNaN(sbp)) { errorDisplay.textContent = "Inserire SBP valida (es. dal campo PAO)."; return null; }
            if (sbp < 100 || sbp > 200) {
                if (!errorDisplay.textContent) errorDisplay.textContent = "Warning: SBP inserita fuori range suggerito (100-200 mmHg).";
            }
            if (sbp <= 0) { errorDisplay.textContent = "Inserire SBP valida (positiva)."; return null; }
            const colTotMgDl = parseFloat(colTotInput.value);
            const colHdlMgDl = parseFloat(colHdlInput.value);
            if (isNaN(colTotMgDl) || colTotMgDl <= 0 || isNaN(colHdlMgDl) || colHdlMgDl <= 0) {
                errorDisplay.textContent = "Inserire valori validi (mg/dL, positivi) per Colesterolo Totale e HDL.";
                return null;
            }
            if (colHdlMgDl >= colTotMgDl) { errorDisplay.textContent = "Colesterolo HDL deve essere minore del Totale."; return null; }
            const isSmoker = smokerCheckbox.checked;
            if (!regionRadio) { errorDisplay.textContent = "Selezionare la regione di rischio."; return null; }
            const region = parseInt(regionRadio.value, 10);
            const conversionFactor = 38.67;
            const coeffs = {
                male: { cage: 0.3742, smoking: 0.6012, csbp: 0.2777, ctchol: 0.1458, chdl: -0.2698, smoking_cage: -0.0755, csbp_cage: -0.0255, ctchol_cage: -0.0281, chdl_cage: 0.0426 },
                female: { cage: 0.4648, smoking: 0.7744, csbp: 0.3131, ctchol: 0.1002, chdl: -0.2606, smoking_cage: -0.1088, csbp_cage: -0.0277, ctchol_cage: -0.0226, chdl_cage: 0.0613 }
            };
            const baseline_survival = { male: 0.9605, female: 0.9776 };
            const calibration_scales = {
                male: { 1: { scale1: -0.5699, scale2: 0.7476 }, 2: { scale1: -0.1565, scale2: 0.8009 }, 3: { scale1: 0.3207, scale2: 0.9360 }, 4: { scale1: 0.5836, scale2: 0.8294 } },
                female: { 1: { scale1: -0.7380, scale2: 0.7019 }, 2: { scale1: -0.3143, scale2: 0.7701 }, 3: { scale1: 0.5710, scale2: 0.9369 }, 4: { scale1: 0.9412, scale2: 0.8329 } }
            };
            const colTotMmolL = colTotMgDl / conversionFactor;
            const colHdlMmolL = colHdlMgDl / conversionFactor;
            const nonHdlMmolL = colTotMmolL - colHdlMmolL;
            if (nonHdlMmolL < 3.0 || nonHdlMmolL > 6.9) {
                if (!errorDisplay.textContent) errorDisplay.textContent = `Warning: Colesterolo non-HDL (${(nonHdlMmolL * conversionFactor).toFixed(0)} mg/dL) fuori range SCORE2 (115-266 mg/dL).`;
            }
            const cage = (age - 60) / 5;
            const smoking_val = isSmoker ? 1 : 0;
            const csbp = (sbp - 120) / 20;
            const ctchol = colTotMmolL - 6;
            const chdl = (colHdlMmolL - 1.3) / 0.5;
            const cf = coeffs[sex];
            let x = cf.cage * cage + cf.smoking * smoking_val + cf.csbp * csbp + cf.ctchol * ctchol + cf.chdl * chdl
                + cf.smoking_cage * smoking_val * cage + cf.csbp_cage * csbp * cage + cf.ctchol_cage * ctchol * cage + cf.chdl_cage * chdl * cage;
            const s0 = baseline_survival[sex];
            let uncalibrated_risk = 1 - Math.pow(s0, Math.exp(x));
            const epsilon = 1e-10;
            uncalibrated_risk = Math.max(epsilon, Math.min(1 - epsilon, uncalibrated_risk));
            const cal = calibration_scales[sex][region];
            if (!cal) { errorDisplay.textContent = "Scale di calibrazione non trovate."; return null; }
            let calibrated_risk_percent;
            try {
                const inner_log = -Math.log(1 - uncalibrated_risk);
                if (inner_log <= 0 || !isFinite(inner_log)) throw new Error("Intermediate log error.");
                const log_inner_log = Math.log(inner_log);
                if (!isFinite(log_inner_log)) throw new Error("Final log error.");
                const calibrated_risk = 1 - Math.exp(-Math.exp(cal.scale1 + cal.scale2 * log_inner_log));
                calibrated_risk_percent = (calibrated_risk * 100).toFixed(1);
            } catch (e) {
                calibrated_risk_percent = uncalibrated_risk < 0.5 ? "0.0" : ">99.9";
                if (!errorDisplay.textContent) errorDisplay.textContent = "Rischio estremo, calcolo al limite.";
                resultDisplay.textContent = `${calibrated_risk_percent}%`;
                return calibrated_risk_percent === ">99.9" ? 99.9 : (calibrated_risk_percent === "0.0" ? 0.0 : null);
            }
            resultDisplay.textContent = `${calibrated_risk_percent}%`;
            return parseFloat(calibrated_risk_percent);
        }

        // Converte percentuale SCORE2 in categoria di rischio CV secondo ESC 2021
        function getRiskCategoryFromScore2(score, age) {
            if (score === null || isNaN(score)) return null;

            if (age < 50) {
                if (score < 2.5) return 'basso';
                if (score < 7.5) return 'moderato';
                if (score < 10) return 'alto';
                return 'molto-alto';
            } else {
                // et√† 50-69 (SCORE2) o ‚â•70 (SCORE2-OP con stesse soglie semplificate)
                if (score < 5) return 'basso';
                if (score < 10) return 'moderato';
                if (score < 15) return 'alto';
                return 'molto-alto';
            }
        }

        // Restituisce il target LDL in base alla categoria di rischio e presenza di diabete
        function getLdlTarget(riskCategory, hasDiabetes) {
            if (hasDiabetes) return 55; // Diabete con danno d'organo = molto alto rischio
            switch (riskCategory) {
                case 'molto-alto': return 55;
                case 'alto': return 70;
                case 'moderato': return 100;
                case 'basso':
                default: return 116;
            }
        }

        // === Parsing PAO e commento SOLO per ipertensione (grado 1‚Äì3 o ISH) ===
        function parseBPString(paoStr) {
            if (!paoStr) return { sbp: NaN, dbp: NaN };
            const cleaned = String(paoStr).replace(/[^\d\/\-\‚Äì\‚Äî\s]/g, '').trim();
            let parts = cleaned.split(/[\/\-\‚Äì\‚Äî]/).map(s => s.trim()).filter(Boolean);
            if (parts.length < 2) {
                const nums = cleaned.match(/\d+/g);
                if (nums && nums.length >= 2) parts = [nums[0], nums[1]];
            }
            const sbp = parts[0] ? parseInt(parts[0], 10) : NaN;
            const dbp = parts[1] ? parseInt(parts[1], 10) : NaN;
            return { sbp, dbp };
        }
        function classifyOfficeBP(sbp, dbp) {
            if (isNaN(sbp) || isNaN(dbp)) return null;
            if (sbp >= 140 && dbp < 90) {
                let grade = 1;
                if (sbp >= 180) grade = 3;
                else if (sbp >= 160) grade = 2;
                return "Ipertensione sistolica isolata - grado " + grade;
            }
            if (sbp >= 140 || dbp >= 90) {
                const gradeFromSBP = sbp >= 180 ? 3 : (sbp >= 160 ? 2 : 1);
                const gradeFromDBP = dbp >= 110 ? 3 : (dbp >= 100 ? 2 : (dbp >= 90 ? 1 : 0));
                const grade = Math.max(gradeFromSBP, gradeFromDBP);
                return "Ipertensione arteriosa - grado " + grade;
            }
            return null;
        }
        // === END ===

        // Robust clipboard copy with fallback
        function copyToClipboard(text) {
            // Try modern Clipboard API first (requires HTTPS)
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                // Fallback for HTTP or older browsers
                return new Promise((resolve, reject) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error("execCommand('copy') failed"));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }

        // Auto-resize textarea to fit content
        function autoResizeTextarea(textarea) {
            if (!textarea) return;
            // Reset height to auto to get correct scrollHeight
            textarea.style.height = 'auto';
            // Set height to scrollHeight to fit all content
            const newHeight = Math.max(150, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
        }

        function compilaVisita() {
            const indent = " ";
            const sectionSeparator = "\n\n";
            const ageInput = document.getElementById("age");
            const age = ageInput.value.trim();
            const ageNum = age ? parseInt(age, 10) : NaN;
            const sexRadioChecked = document.querySelector('input[name="sex"]:checked');
            const sexValue = sexRadioChecked ? sexRadioChecked.value : null;

            // Costruisci la riga introduttiva solo se et√† o sesso sono presenti
            let patientIntroLine = "";
            if (age && sexValue) {
                patientIntroLine = (sexValue === "male") ? `Paziente uomo di ${age} anni` : `Paziente donna di ${age} anni`;
            } else if (age) {
                patientIntroLine = `Paziente di ${age} anni`;
            } else if (sexValue) {
                patientIntroLine = (sexValue === "male") ? `Paziente uomo` : `Paziente donna`;
            }
            let score2Result = null;
            const score2ErrorDiv = document.getElementById("score2-error");
            const score2ResultDisplay = document.getElementById("score2-result-display");
            score2ErrorDiv.textContent = ""; score2ResultDisplay.textContent = "-";
            if (ageNum >= 40 && ageNum <= 69) score2Result = calculateScore2();
            else score2ErrorDiv.textContent = "Calcolo SCORE2 non applicabile (et√† fuori range 40-69 anni).";
            let score2OutputText = "";
            if (score2Result !== null && !isNaN(score2Result)) {
                const regionTextMap = { 1: "Basso", 2: "Moderato", 3: "Alto", 4: "Molto Alto" };
                const regionRadio = document.querySelector('input[name="risk_region"]:checked');
                const regionVal = regionRadio ? regionRadio.value : '2';
                const regionName = regionTextMap[regionVal] || "Non specificata";
                score2OutputText = `Rischio CVD a 10 anni (SCORE2 - Regione ${regionName}): ${score2Result}%`;
            }
            const fattoriRischio = [];
            if (document.getElementById("fumo").checked) fattoriRischio.push("Fumo Attuale");
            if (document.getElementById("pregresso-fumo").checked) fattoriRischio.push("Pregresso fumo di sigaretta");
            if (document.getElementById("diabete").checked) fattoriRischio.push("Diabete");
            if (document.getElementById("ipertensione").checked) fattoriRischio.push("Ipertensione");
            if (document.getElementById("ipercolesterolemia").checked) fattoriRischio.push("Ipercolesterolemia");
            if (document.getElementById("obesita").checked) fattoriRischio.push("Obesit√†");
            if (document.getElementById("familiarita").checked) fattoriRischio.push("Familiarit√† positiva per MCV");
            const fattoriRischioRaw = fattoriRischio.length > 0 ? fattoriRischio.join("; ") : "Nessuno";
            const fattoriRischioText = formatText(fattoriRischioRaw + (score2OutputText ? `\n${score2OutputText}` : ""), indent);
            const anamnesiFamiliareRaw = document.getElementById("anamnesi-familiare").value;
            const anamnesiFamiliareDefault = "Nessuna familiarit√† riferita per malattia coronarica precoce (M <55, F <65), morte improvvisa o cardiomiopatie ereditarie.";
            const anamnesiFamiliareText = formatText(anamnesiFamiliareRaw || anamnesiFamiliareDefault, indent);
            const anamnesiRemotaRaw = document.getElementById("anamnesi-remota").value;
            const anamnesiRemotaText = formatText(anamnesiRemotaRaw || "Priva di rilievi significativi", indent);
            const anamnesiCvRaw = document.getElementById("anamnesi-cv").value;
            const anamnesiCvText = formatText(anamnesiCvRaw || "Non riferisce precedenti eventi cardiovascolari", indent);
            const anamnesiProssimaRaw = document.getElementById("anamnesi-prossima").value.trim();
            const anamnesiProssimaDefault = "Paziente giunto alla nostra osservazione per controllo cardiologico di routine. Non riferisce dolore toracico, dispnea, cardiopalmo, lipotimie n√© sincopi.";
            const anamnesiProssimaText = formatText(anamnesiProssimaRaw || anamnesiProssimaDefault, indent);
            let terapia = [];
            for (let i = 1; i <= 7; i++) {
                const farmaco = document.getElementById(`farmaco${i}`).value.trim();
                const dose = document.getElementById(`dose${i}`).value.trim();
                if (farmaco) terapia.push(`${farmaco}${dose ? ` ${dose} mg` : ""}`);
            }
            const terapiaRaw = terapia.length > 0 ? terapia.join("; ") : "Nessuna";
            const terapiaText = formatText(terapiaRaw, indent);
            const esamePolmonareRaw = document.getElementById("esame-polmonare").value;
            const esamePolmonareDefault = "Murmure vescicolare normotrasmesso, non rumori patologici aggiunti, non stasi";
            const esamePolmonareText = formatText(`TORACE: ${esamePolmonareRaw || esamePolmonareDefault}`, indent);
            const esameCardiacoRaw = document.getElementById("esame-cardiaco").value;
            const esameCardiacoDefault = "Toni cardiaci netti in successione ritmica, pause libere. Buono il compenso emodinamico";
            const esameCardiacoText = formatText(`CUORE: ${esameCardiacoRaw || esameCardiacoDefault}`, indent);

            // PAO + commento SOLO in caso di ipertensione (grado 1‚Äì3 o ISH) con dash semplice
            const paoRaw = document.getElementById("pao").value.trim();
            const paoVal = paoRaw || "Non rilevata";
            let paoLine = `PAO: ${paoVal}`;
            if (paoRaw) {
                const { sbp: sbpOut, dbp: dbpOut } = parseBPString(paoRaw);
                const catOut = classifyOfficeBP(sbpOut, dbpOut);
                if (catOut) paoLine += ` - ${catOut}`;
            }
            const paoText = formatText(paoLine, indent);

            const eoText = [esamePolmonareText, esameCardiacoText, paoText].filter(text => text).join('\n');
            const ecgInputText = document.getElementById("ecg");
            const ecgRaw = ecgInputText.value.trim();
            const ecgText = formatText(ecgRaw, indent);
            const ecoRaw = document.getElementById("eco-text").value.trim();
            const ecoContent = ecoRaw ? formatText(ecoRaw, indent) : "";
            const ecoSectionOutput = ecoContent ? formatSection("ECOCARDIOGRAMMA COLOR DOPPLER", ecoContent, indent, sectionSeparator) : "";
            const sforzoRaw = document.getElementById("sforzo-text").value.trim();
            const sforzoContent = sforzoRaw ? formatText(sforzoRaw, indent) : "";
            const sforzoSectionOutput = sforzoContent ? formatSection("TEST DA SFORZO", sforzoContent, indent, sectionSeparator) : "";
            let ematochimiciRaw = "Non disponibili.";
            const ematoRadio = document.querySelector('input[name="emato-tipo"]:checked');
            if (ematoRadio) {
                const ematoTextVal = document.getElementById("emato-text").value.trim();
                if (ematoTextVal && ematoTextVal !== "Nei limiti di norma") ematochimiciRaw = ematoTextVal;
                else if (ematoRadio.id === "emato-nei-limiti") ematochimiciRaw = "Nei limiti di norma";
            }
            const formattedEmato = formatText(ematochimiciRaw, indent);
            const ematochimiciText = formattedEmato || formatText("Non disponibili.", indent);
            const consigliCheckboxes = [
                { id: "consiglio-terapia", text: "Continuare la terapia in atto praticata." },
                { id: "consiglio-angio-tc", text: "Utile eseguire angio-TC coronarica." },
                { id: "consiglio-holter", text: "Utile eseguire ECG-Holter delle 24h." },
                { id: "consiglio-eco", text: "Utile eseguire EcocolorDoppler cardiaco." },
                { id: "consiglio-imaging", text: "Utile eseguire test di imaging non invasivo (ecocardiogramma da stress, scintigrafia miocardica, risonanza magnetica cardiaca da stress)." },
                { id: "consiglio-no-accertamenti", text: "In atto non necessari ulteriori accertamenti." },
                { id: "consiglio-ematochimici", text: "Utile eseguire esami ematochimici completi." }
            ];
            const consigliSelezionati = consigliCheckboxes
                .filter(item => document.getElementById(item.id).checked)
                .map(item => item.text.replace(/\.$/, ""));

            let conclusioniRaw = "";
            // Check if "Primo riscontro ipertensione" scenario with generated text
            const scenarioSelect = document.getElementById('scenario-select');
            if (scenarioSelect.value === 'primo-riscontro-ht' && htGeneratedText) {
                conclusioniRaw = htGeneratedText;
            } else if ((scenarioSelect.value === 'primo-riscontro-ldl' || scenarioSelect.value === 'ldl-elevato-auto' || scenarioSelect.value === 'ldl-normale') && ldlGeneratedText) {
                conclusioniRaw = ldlGeneratedText;
            } else if (scenarioSelect.value === 'primo-riscontro-pvc' && pvcGeneratedText) {
                conclusioniRaw = pvcGeneratedText;
            } else if (consigliSelezionati.length > 0) {
                conclusioniRaw = consigliSelezionati.join(". ") + ".";
            } else {
                // Default text when no scenario is selected
                conclusioniRaw = "Esame obiettivo e strumentale nei limiti della norma. Non evidenza di patologia cardiovascolare in atto.";
            }
            if (aggiungereConsigliLipidi) conclusioniRaw += "\n" + consigliLipidiText.trim();

            console.log('Consigli selezionati:', consigliSelezionati.length, consigliSelezionati);
            console.log('Conclusioni raw:', conclusioniRaw);

            const conclusioniText = formatText(conclusioniRaw, indent);

            const includeContactInfo = document.getElementById("include-contact-info-cb").checked;
            const contattiContent = includeContactInfo ? formatText("Per qualsiasi informazione, domanda o chiarimento scrivere a:\nbenjamin.deornelas@santagostino.it", indent) : "";
            const contattiSectionOutput = contattiContent ? formatSection("", contattiContent, indent, "") : "";
            let output = [
                formatSection("", formatText(patientIntroLine, ""), "", sectionSeparator),
                formatSection("FATTORI DI RISCHIO CARDIOVASCOLARE", fattoriRischioText, indent, sectionSeparator),
                formatSection("ANAMNESI FAMILIARE", anamnesiFamiliareText, indent, sectionSeparator),
                formatSection("ANAMNESI PATOLOGICA REMOTA", anamnesiRemotaText, indent, sectionSeparator),
                formatSection("ANAMNESI CARDIOVASCOLARE", anamnesiCvText, indent, sectionSeparator),
                formatSection("ANAMNESI PATOLOGICA PROSSIMA", anamnesiProssimaText, indent, sectionSeparator),
                formatSection("TERAPIA IN ATTO", terapiaText, indent, sectionSeparator),
                formatSection("ESAME OBIETTIVO", eoText, indent, sectionSeparator),
                formatSection("ECG", ecgText, indent, sectionSeparator),
                ecoSectionOutput,
                sforzoSectionOutput,
                formatSection("ESAMI EMATOCHIMICI", ematochimiciText, indent, sectionSeparator),
                formatSection("CONCLUSIONI E RACCOMANDAZIONI TERAPEUTICHE", conclusioniText, indent, sectionSeparator),
                contattiSectionOutput
            ].filter(section => section && section.trim()).join("");

            // Opzioni compatibilit√† stampa (rimossi controlli compat-ascii e compat-crlf)
            output = sanitizeForPrint(output, 'latin1');
            output = normalizeLineEndings(output, false);

            const outputTextarea = document.getElementById("output-visita");
            outputTextarea.value = output.trim();

            // Auto-resize textarea to fit content
            autoResizeTextarea(outputTextarea);

            // Try modern clipboard API first, fallback to execCommand
            copyToClipboard(output.trim())
                .then(() => {
                    showAndHideNotification('copy-notification', true);
                    aggiungereConsigliLipidi = false;

                    const consigliLipidiCb = document.getElementById('aggiungi-consigli-lipidi-cb');
                    const templateSforzoCb = document.getElementById('copia-template-sforzo-cb');
                    const testSecondariaCb = document.getElementById('copia-test-secondaria-cb');
                    const lipidiNotif = document.getElementById('aggiungi-lipidi-notification-cb');
                    const contactNotif = document.getElementById('include-contact-info-notification-cb');

                    if (consigliLipidiCb) consigliLipidiCb.checked = aggiungereConsigliLipidi;
                    if (templateSforzoCb) templateSforzoCb.checked = false;
                    if (testSecondariaCb) testSecondariaCb.checked = false;
                    if (lipidiNotif) lipidiNotif.style.display = 'none';
                    if (contactNotif) contactNotif.style.display = 'none';
                })
                .catch(err => {
                    console.error('Copy failed:', err);
                    alert("Non √® stato possibile copiare il testo automaticamente. Errore: " + err.message);

                    const consigliLipidiCb = document.getElementById('aggiungi-consigli-lipidi-cb');
                    const templateSforzoCb = document.getElementById('copia-template-sforzo-cb');
                    const testSecondariaCb = document.getElementById('copia-test-secondaria-cb');
                    const lipidiNotif = document.getElementById('aggiungi-lipidi-notification-cb');
                    const contactNotif = document.getElementById('include-contact-info-notification-cb');

                    if (consigliLipidiCb) consigliLipidiCb.checked = aggiungereConsigliLipidi;
                    if (templateSforzoCb) templateSforzoCb.checked = false;
                    if (testSecondariaCb) testSecondariaCb.checked = false;
                    if (lipidiNotif) lipidiNotif.style.display = 'none';
                    if (contactNotif) contactNotif.style.display = 'none';
                });
        }

        function showAndHideNotification(notificationId, isMainNotification = false) {
            const notification = document.getElementById(notificationId);
            if (!notification) return;
            notification.style.display = isMainNotification ? "block" : "inline";
            setTimeout(() => notification.style.display = "none", 3000);
        }

        function copiaTestSecondaria(notificationId) {
            const testoDaCopiare = "Si richiedono esami ematochimici comprensivi di Creatinina, Potassio, Sodio, TSH, rapporto Aldosterone/Renina (ARR). Esame urine completo con rapporto Albumina/Creatinina (ACR). EcoDoppler delle Arterie Renali.";
            copyToClipboard(testoDaCopiare).then(() => {
                showAndHideNotification(notificationId);
                setTimeout(() => { document.getElementById('copia-test-secondaria-cb').checked = false; }, 100);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert("Non √® stato possibile copiare il testo negli appunti. Errore: " + err.message);
            });
        }

        function copiaTemplateSforzo(notificationId) {
            const templateText = `Indicazione al test: valutazione riserva coronarica e capacit√† funzionale.
Terapia in corso: nessuna.
ECG basale: ritmo sinusale. Normale conduzione AV e IV. Ripolarizzazione ventricolare normale.
Test eseguito al cicloergometro mediante incremento di carico di watt ogni minuto; interrotto per esaurimento muscolare.
Carico max tollerato: watt, pari al % del teorico max atteso.
Potenza aerobica max: METS.
Risposta cronotropa ai carichi nei limiti; FC max raggiunta pari al % della FC max teorica.
Normale risposta pressoria allo sforzo.
Modificazioni ECG significative: no.
Aritmie: no.
Sintomi: no.
CONCLUSIONI:
Test negativo per ridotta riserva coronarica.
Capacit√† funzionale normale.`;
            copyToClipboard(templateText).then(() => {
                showAndHideNotification(notificationId);
                setTimeout(() => { document.getElementById('copia-template-sforzo-cb').checked = false; }, 100);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert("Non √® stato possibile copiare il template negli appunti. Errore: " + err.message);
            });
        }

        function updateSbpFromPao() {
            const paoInput = document.getElementById("pao");
            const sbpInput = document.getElementById("sbp");
            const ageInput = document.getElementById("age");
            const bpBadge = document.getElementById("bp-category-display");

            const paoValue = paoInput.value.trim();
            const { sbp, dbp } = parseBPString(paoValue);

            sbpInput.value = (!isNaN(sbp)) ? sbp : '';

            const category = classifyOfficeBP(sbp, dbp);
            if (category) { bpBadge.style.display = "block"; bpBadge.textContent = category; }
            else { bpBadge.style.display = "none"; bpBadge.textContent = ""; }

            const ageVal = parseInt(ageInput.value, 10);
            if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) calculateScore2();
            else {
                document.getElementById("score2-result-display").textContent = "-";
                const score2ErrorDiv = document.getElementById("score2-error");
                if (isNaN(ageVal) || ageVal < 1) score2ErrorDiv.textContent = "Inserire et√† valida.";
                else if (ageVal < 40 || ageVal > 69) score2ErrorDiv.textContent = "Et√† fuori range 40-69 per SCORE2.";
                else score2ErrorDiv.textContent = "";
                if (!isNaN(ageVal) && (ageVal >= 40 && ageVal <= 69) && sbpInput.value === '') {
                    score2ErrorDiv.textContent = "Inserire SBP valida (es. dal campo PAO).";
                }
            }
        }

        function aggiornaEco() {
            const ecoNormale = document.getElementById("eco-normale").checked;
            const ecoAnziano = document.getElementById("eco-anziano").checked;
            const ecoText = document.getElementById("eco-text");
            if (ecoNormale) {
                ecoText.value = `Diametri e volumi del ventricolo sinistro nella norma.
Spessori settali e parietali nella norma.
Non si evidenziano alterazioni della cinesi segmentaria.
Conservati gli indici di contrattilit√† globale.
Normali dimensioni dell'atrio sinistro.
Morfologia e dinamica dei lembi mitralici nei limiti della norma.
Presenza di minimo jet da rigurgito valvolare mitralico.
Flussimetria transvalvolare indicativa di normali pressioni di riempimento del ventricolo sinistro.
Morfologia e dinamica delle semilunari aortiche nei limiti della norma.
Non jet da insufficienza valvolare ecograficamente visualizzabili.
Nei limiti della norma le velocit√† del flusso transvalvolare aortico.
Nei limiti della norma il diametro della radice aortica e dell'aorta ascendente.
Normali morfologia e dimensioni delle camere destre.
Lieve jet da insufficienza tricuspidalica parafisiologico da cui si stima una pressione polmonare nei limiti della norma.
Setto interatriale apparentemente integro.
Non versamento pericardico in atto.`;
            } else if (ecoAnziano) {
                ecoText.value = `Ventricolo sinistro di normali dimensioni con spessori di parete nei limiti.
Buona la funzione ventricolare sinistra: FE 60%.
Non evidenti difetti di cinesi segmentaria.
Atrio sinistro nei limiti, lembi mitralici lievemente ispessiti.
Bulbo aortico di normali dimensioni, valvola aortica tricuspide, semilunari aortiche lievemente ispessite, apertura valvolare conservata, aorta ascendente nei limiti.
Sezioni destre nei limiti con funzione conservata.
VCI di normali dimensioni con escursioni respiratorie conservate.
Pericardio indenne.
Doppler: Pattern transmitralico da alterato rilasciamento.
Insufficienza mitralica lieve.
Insufficienza tricuspidalica lieve con PAPs nei limiti.`;
            }
        }

        function aggiornaEmatochimici() {
            const ematoNeiLimiti = document.getElementById("emato-nei-limiti").checked;
            const ematoColesterolo = document.getElementById("emato-colesterolo").checked;
            const ematoText = document.getElementById("emato-text");
            if (ematoNeiLimiti) {
                ematoText.value = "Nei limiti di norma";
                ematoText.readOnly = true;
            } else if (ematoColesterolo) {
                ematoText.readOnly = false;
                if (!ematoText.value || ematoText.value === "Nei limiti di norma") {
                    ematoText.value = `Col tot: 
Col HDL: 
Col LDL: 
Trigliceridi: `;
                }
            } else { 
                const defaultCholesterolText = `Col tot: 
Col HDL: 
Col LDL: 
Trigliceridi: `;
                if (ematoText.value.trim() === defaultCholesterolText.trim() || ematoText.value === "Nei limiti di norma") {
                    ematoText.value = "";
                }
                ematoText.readOnly = false;
            }
        }
        
        function updateEmatochimiciFromScore() {
            const colTot = document.getElementById("col-tot").value.trim();
            const colHdl = document.getElementById("col-hdl").value.trim();
            const ldlCalculated = document.getElementById("ldl-calculated").value.trim();
            const trigliceridi = document.getElementById("trigliceridi-score").value.trim();
            
            if (!colTot && !colHdl && !trigliceridi) return;
            const ematoColesteroloRadio = document.getElementById("emato-colesterolo");
            const ematoText = document.getElementById("emato-text");
            ematoColesteroloRadio.checked = true;
            aggiornaEmatochimici();
            
            const textLines = [
                `Col tot: ${colTot ? colTot + " mg/dL" : ""}`,
                `Col HDL: ${colHdl ? colHdl + " mg/dL" : ""}`,
                `Col LDL: ${ldlCalculated && ldlCalculated !== "N/A" ? ldlCalculated + " mg/dL" : ""}`,
                `Trigliceridi: ${trigliceridi ? trigliceridi + " mg/dL" : ""}`
            ];
            ematoText.value = textLines.join("\n");
        }

        function aggiornaSforzo() {
            const sforzoNormale = document.getElementById("sforzo-normale");
            const sforzoText = document.getElementById("sforzo-text");
            if (!sforzoNormale || !sforzoText) return;
            if (sforzoNormale.checked) {
                sforzoText.value = "Test ergometrico massimale nei limiti della norma, senza evidenza di rilevanti anomalie cliniche o elettrocardiografiche (vedasi referto).";
            }
        }

        // ===== SCENARIO SELECTION LOGIC =====
        function handleScenarioChange() {
            const select = document.getElementById('scenario-select');
            const selectedValue = select.value;

            // Deselect all checkboxes first
            const allCheckboxes = [
                'consiglio-terapia', 'consiglio-angio-tc', 'consiglio-holter',
                'consiglio-eco', 'consiglio-imaging', 'consiglio-ematochimici',
                'consiglio-no-accertamenti', 'aggiungi-consigli-lipidi-cb',
                'copia-test-secondaria-cb', 'include-contact-info-cb'
            ];
            allCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });

            // Map scenario to checkbox
            const scenarioMap = {
                'terapia': 'consiglio-terapia',
                'angio-tc': 'consiglio-angio-tc',
                'holter': 'consiglio-holter',
                'eco': 'consiglio-eco',
                'imaging': 'consiglio-imaging',
                'ematochimici': 'consiglio-ematochimici',
                'no-accertamenti': 'consiglio-no-accertamenti',
                'lipidi': 'aggiungi-consigli-lipidi-cb',
                'ipertensione': 'copia-test-secondaria-cb',
                'contatto': 'include-contact-info-cb'
            };

            // Check the selected scenario checkbox
            if (selectedValue && scenarioMap[selectedValue]) {
                const checkboxId = scenarioMap[selectedValue];
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = true;

                    // Handle special scenarios
                    if (selectedValue === 'lipidi') {
                        aggiungereConsigliLipidi = true;
                    } else if (selectedValue === 'ipertensione') {
                        copiaTestSecondaria('copia-secondaria-notification-cb');
                    }
                }
            } else {
                // Reset special flags
                aggiungereConsigliLipidi = false;
            }

            // Show/hide cascading dropdown for "Primo riscontro ipertensione"
            const htCascade = document.getElementById('primo-ht-cascade');
            if (selectedValue === 'primo-riscontro-ht') {
                htCascade.style.display = 'block';
            } else {
                htCascade.style.display = 'none';
                // Reset cascading selections
                resetHtCascade();
            }
        }

        // Current selected scenario
        let selectedScenarioValue = '';
        let selectedScenarioLabel = '';

        // Select simple scenario from tree menu
        function selectScenario(value) {
            selectedScenarioValue = value;
            htGeneratedText = ''; // Reset HT text
            pvcGeneratedText = ''; // Reset PVC text

            const labels = {
                'terapia': 'Confermare terapia in atto',
                'angio-tc': 'Angio-TC coronarica',
                'holter': 'ECG-Holter 24h',
                'eco': 'EcocolorDoppler cardiaco',
                'imaging': 'Test imaging da stress',
                'ematochimici': 'Esami ematochimici',
                'no-accertamenti': 'Nessun ulteriore accertamento',
                'lipidi': 'Consigli Lipidi',
                'ipertensione': 'Ipertensione secondaria',
                'contatto': 'Info Contatto'
            };
            selectedScenarioLabel = labels[value] || value;

            // Update hidden select for compatibility
            document.getElementById('scenario-select').value = value;

            // Trigger checkbox logic
            const checkboxMap = {
                'terapia': 'consiglio-terapia',
                'angio-tc': 'consiglio-angio-tc',
                'holter': 'consiglio-holter',
                'eco': 'consiglio-eco',
                'imaging': 'consiglio-imaging',
                'ematochimici': 'consiglio-ematochimici',
                'no-accertamenti': 'consiglio-no-accertamenti',
                'lipidi': 'aggiungi-consigli-lipidi-cb',
                'ipertensione': 'copia-test-secondaria-cb',
                'contatto': 'include-contact-info-cb'
            };

            // Reset all checkboxes
            Object.values(checkboxMap).forEach(id => {
                const cb = document.getElementById(id);
                if (cb) cb.checked = false;
            });
            aggiungereConsigliLipidi = false;

            // Check the selected one
            if (checkboxMap[value]) {
                const cb = document.getElementById(checkboxMap[value]);
                if (cb) cb.checked = true;
                if (value === 'lipidi') aggiungereConsigliLipidi = true;
                if (value === 'ipertensione') copiaTestSecondaria('copia-secondaria-notification-cb');
            }

            // Show badge
            const badge = document.getElementById('scenario-selected');
            badge.innerHTML = '<strong>Selezionato:</strong> ' + selectedScenarioLabel;
            badge.style.display = 'block';
        }

        // Select HT scenario from tree menu
        function selectHtScenario(esami, ldl, diabete, rischio) {
            selectedScenarioValue = 'primo-riscontro-ht';
            document.getElementById('scenario-select').value = 'primo-riscontro-ht';

            // Reset checkboxes
            aggiungereConsigliLipidi = false;

            // Generate text and store
            const testo = generateHtTextByScenario(esami, ldl, diabete, rischio);
            htGeneratedText = testo;

            // Build path
            const esamiLabel = esami === 'disponibili' ? 'Esami disponibili' : (esami === 'da-richiedere' ? 'Esami da richiedere' : 'Esami in attesa di esito');
            const ldlLabel = ldl ? (ldl === 'normale' ? 'LDL < 116' : ldl === 'elevato' ? 'LDL 116-190' : 'LDL > 190') : '';
            const diabeteLabel = diabete === 'si' ? 'Diabete' : 'No diabete';

            const pathParts = ['Primo riscontro HT', esamiLabel];
            if (ldlLabel) pathParts.push(ldlLabel);
            pathParts.push(diabeteLabel);
            if (rischio) {
                const rischioLabel = 'Rischio ' + rischio.charAt(0).toUpperCase() + rischio.slice(1).replace('-', ' ');
                pathParts.push(rischioLabel);
            }

            // Show badge
            const badge = document.getElementById('scenario-selected');
            badge.innerHTML = '<strong>Selezionato:</strong> ' + pathParts.join(' > ');
            badge.style.display = 'block';

            selectedScenarioLabel = pathParts.join(' > ');
        }

        // Reset scenario
        function resetHtCascade() {
            htGeneratedText = '';
            pvcGeneratedText = '';
            ldlGeneratedText = '';
            selectedScenarioValue = '';
            selectedScenarioLabel = '';
            document.getElementById('scenario-selected').style.display = 'none';
        }

        // LDL Scenario Functions
        let ldlGeneratedText = '';

        function selectLdlScenario(ldlLevel, rischio) {
            selectedScenarioValue = 'primo-riscontro-ldl';
            document.getElementById('scenario-select').value = 'primo-riscontro-ldl';

            // Reset checkboxes
            aggiungereConsigliLipidi = false;

            // Generate text and store
            const testo = generateLdlScenarioText(ldlLevel, rischio);
            ldlGeneratedText = testo;

            // Build path
            const ldlLabel = ldlLevel === 'elevato' ? 'LDL 116-190 mg/dL' : 'LDL > 190 mg/dL';
            const rischioLabel = 'Rischio ' + rischio.charAt(0).toUpperCase() + rischio.slice(1).replace('-', ' ');
            const pathParts = ['Primo riscontro LDL elevato', ldlLabel, rischioLabel];

            // Show badge
            const badge = document.getElementById('scenario-selected');
            badge.innerHTML = '<strong>Selezionato:</strong> ' + pathParts.join(' > ');
            badge.style.display = 'block';

            selectedScenarioLabel = pathParts.join(' > ');
        }

        function generateLdlScenarioText(ldlLevel, rischio) {
            let testo = '';

            if (ldlLevel === 'molto-elevato') {
                // LDL > 190 mg/dL - automatic high risk, screen for FH
                testo = `Primo riscontro di colesterolo LDL significativamente elevato (superiore a 190 mg/dL). Valori cos√¨ elevati richiedono un approfondimento per escludere l'ipercolesterolemia familiare, una condizione genetica che causa colesterolo alto e aumenta il rischio di malattie cardiovascolari.`;
                testo += `\n\nSi consiglia:\n- Visita specialistica per valutazione dell'ipercolesterolemia familiare\n- Anamnesi familiare per eventi cardiovascolari precoci (infarto o ictus prima dei 55 anni negli uomini, prima dei 65 anni nelle donne)\n- Ricerca di segni clinici (xantomi tendinei, arco corneale)`;

                if (rischio === 'molto-alto') {
                    testo += `\n\nL'obiettivo √® raggiungere un valore di colesterolo LDL inferiore a 55 mg/dL, con una riduzione di almeno il 50% rispetto al valore attuale.`;
                } else {
                    testo += `\n\nL'obiettivo √® raggiungere un valore di colesterolo LDL inferiore a 70 mg/dL, con una riduzione di almeno il 50% rispetto al valore attuale.`;
                }

                testo += `\n\nSi consiglia controllo del profilo lipidico dopo 4-6 settimane per verificare il raggiungimento dell'obiettivo.`;
                testo += generateLdlLifestyleAdvice();

            } else {
                // LDL 116-190 mg/dL
                testo = `Primo riscontro di colesterolo LDL (colesterolo "cattivo") elevato.`;

                if (rischio === 'basso') {
                    testo += `\n\nIn considerazione del basso rischio cardiovascolare, si consiglia l'adozione di modifiche dello stile di vita, con particolare attenzione all'alimentazione. L'obiettivo √® raggiungere un valore di LDL inferiore a 116 mg/dL.`;
                    testo += `\n\nSi consiglia un controllo del profilo lipidico dopo 4-6 settimane per valutare l'efficacia delle modifiche dello stile di vita.`;
                } else if (rischio === 'moderato') {
                    testo += `\n\nIn considerazione del profilo di rischio cardiovascolare moderato, si consiglia l'adozione di modifiche dello stile di vita, con particolare attenzione all'alimentazione. L'obiettivo √® raggiungere un valore di LDL inferiore a 100 mg/dL.`;
                    testo += `\n\nSi consiglia un controllo del profilo lipidico dopo 4-6 settimane per valutare i risultati e decidere se sia necessario un ulteriore intervento.`;
                } else if (rischio === 'alto') {
                    testo += `\n\nIn considerazione del profilo di rischio cardiovascolare alto, l'obiettivo √® raggiungere un valore di LDL inferiore a 70 mg/dL, con una riduzione di almeno il 50% rispetto al valore attuale. √à importante adottare anche un'alimentazione cardioprotettiva.`;
                    testo += `\n\nSi consiglia un controllo del profilo lipidico dopo 4-6 settimane per verificare il raggiungimento dell'obiettivo.`;
                } else if (rischio === 'molto-alto') {
                    testo += `\n\nIn considerazione del profilo di rischio cardiovascolare molto alto, l'obiettivo √® raggiungere un valore di LDL inferiore a 55 mg/dL, con una riduzione di almeno il 50% rispetto al valore attuale. √à importante adottare anche un'alimentazione cardioprotettiva.`;
                    testo += `\n\nSi consiglia un controllo del profilo lipidico dopo 4-6 settimane per verificare il raggiungimento dell'obiettivo.`;
                }

                testo += generateLdlLifestyleAdvice();
            }

            return testo;
        }

        function generateLdlLifestyleAdvice() {
            let testo = `\n\nPer ridurre il colesterolo, si raccomandano le seguenti indicazioni:\n`;
            testo += `- Limitare i grassi saturi (burro, formaggi grassi, carni rosse, insaccati, fritture) a meno del 10% delle calorie totali, preferendo olio extravergine d'oliva.\n`;
            testo += `- Evitare i grassi trans (margarine, prodotti da forno industriali, snack confezionati).\n`;
            testo += `- Aumentare il consumo di fibre solubili (avena, orzo, legumi, frutta con buccia) che aiutano a ridurre l'assorbimento del colesterolo.\n`;
            testo += `- Consumare pesce ricco di omega-3 (salmone, sgombro, sardine) almeno 2 volte a settimana.\n`;
            testo += `- Includere una porzione giornaliera di frutta secca (30g di noci, mandorle).\n`;
            testo += `- Consumare almeno 200g di verdura e 200g di frutta fresca al giorno.\n`;
            testo += `- Preferire cereali integrali a quelli raffinati.\n`;
            testo += `- Attivit√† fisica aerobica regolare: almeno 150-300 minuti alla settimana di intensit√† moderata (camminata veloce, nuoto, bicicletta).\n`;
            testo += `- In caso di sovrappeso, anche una riduzione del 5-10% del peso corporeo pu√≤ migliorare significativamente il profilo lipidico.\n`;
            testo += `- Evitare il fumo di sigaretta, che peggiora il profilo lipidico e aumenta il rischio cardiovascolare.`;

            return testo;
        }

        // Scenario LDL con calcolo automatico del rischio da SCORE2
        function selectLdlAutoScenario() {
            // Leggi LDL calcolato
            const ldlInput = document.getElementById('ldl-calculated');
            const ldlValue = parseFloat(ldlInput.value);

            if (isNaN(ldlValue) || ldlValue <= 0) {
                alert('Inserire prima i valori del profilo lipidico (Colesterolo Totale, HDL, Trigliceridi) per calcolare il LDL.');
                return;
            }

            // Determina livello LDL
            let ldlLevel;
            if (ldlValue < 116) {
                // LDL normale - nessuna raccomandazione specifica necessaria
                ldlGeneratedText = `Il colesterolo LDL (colesterolo "cattivo") risulta nei limiti della norma (${ldlValue.toFixed(0)} mg/dL). Si consiglia di mantenere uno stile di vita sano e controlli periodici del profilo lipidico.`;
                selectedScenarioValue = 'ldl-normale';
                document.getElementById('scenario-select').value = 'ldl-normale';

                const badge = document.getElementById('scenario-selected');
                badge.innerHTML = '<strong>Selezionato:</strong> LDL nella norma';
                badge.style.display = 'block';
                selectedScenarioLabel = 'LDL nella norma';
                return;
            } else if (ldlValue <= 190) {
                ldlLevel = 'elevato';
            } else {
                ldlLevel = 'molto-elevato';
            }

            // Leggi et√† per SCORE2
            const ageInput = document.getElementById('age');
            const age = parseInt(ageInput.value, 10);

            // Controlla diabete
            const diabeteCheckbox = document.getElementById('diabete');
            const hasDiabetes = diabeteCheckbox && diabeteCheckbox.checked;

            // Calcola SCORE2 se possibile (et√† 40-69)
            let riskCategory = null;
            if (age >= 40 && age <= 69) {
                const score2Result = calculateScore2();
                if (score2Result !== null && !isNaN(score2Result)) {
                    riskCategory = getRiskCategoryFromScore2(score2Result, age);
                }
            }

            // Se diabete, automaticamente alto/molto alto rischio
            if (hasDiabetes) {
                riskCategory = 'molto-alto';
            }

            // Se non si pu√≤ calcolare il rischio, chiedi selezione manuale
            if (!riskCategory) {
                alert('Non √® possibile calcolare automaticamente il rischio cardiovascolare (SCORE2 richiede et√† 40-69 e profilo lipidico completo). Selezionare manualmente il profilo di rischio dal menu.');
                return;
            }

            // Genera testo usando la funzione esistente
            const testo = generateLdlScenarioText(ldlLevel, riskCategory);
            ldlGeneratedText = testo;

            selectedScenarioValue = 'ldl-elevato-auto';
            document.getElementById('scenario-select').value = 'ldl-elevato-auto';

            // Build path
            const ldlLabel = ldlLevel === 'elevato' ? `LDL ${ldlValue.toFixed(0)} mg/dL (116-190)` : `LDL ${ldlValue.toFixed(0)} mg/dL (>190)`;
            const rischioLabel = 'Rischio ' + riskCategory.charAt(0).toUpperCase() + riskCategory.slice(1).replace('-', ' ');
            const pathParts = ['LDL elevato', ldlLabel, rischioLabel];

            // Show badge
            const badge = document.getElementById('scenario-selected');
            badge.innerHTML = '<strong>Selezionato:</strong> ' + pathParts.join(' > ');
            badge.style.display = 'block';

            selectedScenarioLabel = pathParts.join(' > ');
        }

        function generateHtTextByScenario(esami, ldl, diabete, rischio) {
            let testo = '';

            // Base text for first-time elevated BP finding - MINIMAL, just request confirmation
            const baseHt = `Primo riscontro di valori pressori elevati. Si consiglia monitoraggio pressorio domiciliare per 7 giorni (2 misurazioni mattina e sera) oppure monitoraggio pressorio delle 24 ore (ABPM). I risultati del monitoraggio potranno essere inviati all'indirizzo email benjamin.deornelas@santagostino.it per la valutazione.`;

            // Text for labs to be ordered
            if (esami === 'da-richiedere') {
                testo = baseHt;
                testo += `\n\nSi richiede l'esecuzione di esami ematochimici comprensivi di: creatinina con calcolo del filtrato glomerulare (eGFR), rapporto albumina/creatinina urinaria (UACR), profilo lipidico completo (colesterolo totale, HDL, LDL, trigliceridi), glicemia a digiuno, emoglobina glicata (HbA1c), sodio, potassio e TSH.`;
                return testo;
            }

            // Text for labs already done but waiting for results
            if (esami === 'in-attesa') {
                testo = baseHt;
                testo += `\n\nSi resta in attesa dell'esito degli esami ematochimici gi√† eseguiti.`;
                return testo;
            }

            // Text for labs available - still need BP confirmation first
            testo = baseHt;

            return testo;
        }

        function generateLdlElevatoText(diabete, rischio) {
            let testo = '';

            if (diabete === 'si' || rischio === 'alto' || rischio === 'molto-alto') {
                // High/very high risk or diabetic: drug + lifestyle together
                const target = (rischio === 'molto-alto' || diabete === 'si') ? '55' : '70';
                testo = `\n\nIl colesterolo LDL (colesterolo "cattivo") risulta al di sopra dei valori desiderabili per il profilo di rischio cardiovascolare. L'obiettivo √® raggiungere un valore di LDL inferiore a ${target} mg/dL e una riduzione di almeno il 50% rispetto al valore attuale. √à importante anche adottare un'alimentazione cardioprotettiva. Si consiglia un controllo del profilo lipidico dopo 4-6 settimane per verificare il raggiungimento dell'obiettivo.`;
            } else if (rischio === 'moderato') {
                // Moderate risk: lifestyle first, consider drug if uncontrolled
                testo = `\n\nIl colesterolo LDL (colesterolo "cattivo") risulta lievemente elevato. In considerazione del profilo di rischio cardiovascolare, si consiglia in prima istanza l'adozione di modifiche dello stile di vita, con particolare attenzione all'alimentazione. L'obiettivo √® raggiungere un valore di LDL inferiore a 100 mg/dL. Si consiglia un controllo del profilo lipidico dopo 4-6 settimane per valutare i risultati.`;
            } else {
                // Low risk: lifestyle only
                testo = `\n\nIl colesterolo LDL (colesterolo "cattivo") risulta lievemente elevato. In considerazione del basso rischio cardiovascolare, si consiglia l'adozione di modifiche dello stile di vita con particolare attenzione all'alimentazione. L'obiettivo √® mantenere un valore di LDL inferiore a 116 mg/dL. Si consiglia un controllo periodico del profilo lipidico.`;
            }

            return testo;
        }

        function generateLdlMoltoElevatoText(diabete, rischio) {
            let testo = '';
            const target = (rischio === 'molto-alto' || diabete === 'si') ? '55' : (rischio === 'alto' ? '70' : '100');

            testo = `\n\nIl colesterolo LDL (colesterolo "cattivo") risulta significativamente elevato (superiore a 190 mg/dL). Valori cos√¨ elevati richiedono un approfondimento diagnostico per escludere forme di ipercolesterolemia familiare (una condizione genetica che causa colesterolo alto). L'obiettivo terapeutico √® raggiungere un valore di LDL inferiore a ${target} mg/dL. √à importante anche adottare un'alimentazione cardioprotettiva. Si consiglia un controllo del profilo lipidico dopo 4-6 settimane.`;

            return testo;
        }

        function generateLifestyleAdvice(diabete, rischio) {
            let testo = `\n\nSi raccomandano le seguenti indicazioni sullo stile di vita:\n`;
            testo += `- Alimentazione di tipo mediterraneo con consumo quotidiano di verdura (almeno 200g), frutta fresca (almeno 200g), cereali integrali e legumi. Limitare i grassi saturi a meno del 10% delle calorie totali, preferendo olio extravergine d'oliva come condimento principale.\n`;
            testo += `- Consumare pesce ricco di omega-3 (salmone, sgombro, sardine) almeno 1-2 volte a settimana.\n`;
            testo += `- Limitare la carne rossa a massimo 350-500g alla settimana ed evitare carni lavorate (insaccati, salumi).\n`;
            testo += `- Includere una porzione giornaliera di frutta secca (30g di noci, mandorle).\n`;
            testo += `- Apporto di fibre di 30-45g al giorno.\n`;
            testo += `- Limitare il consumo di sale a meno di 5g al giorno (circa un cucchiaino raso). Evitare di aggiungere sale a tavola e limitare alimenti confezionati ricchi di sodio.\n`;
            testo += `- Attivit√† fisica aerobica regolare: almeno 150-300 minuti alla settimana di intensit√† moderata (camminata veloce, nuoto, bicicletta), distribuiti su almeno 5 giorni. Se possibile, aggiungere 2-3 sessioni settimanali di esercizi di rinforzo muscolare leggero.\n`;
            testo += `- Mantenere un peso corporeo sano (indice di massa corporea 20-25 kg/m2). In caso di sovrappeso, anche una riduzione del 5-10% del peso corporeo pu√≤ portare benefici significativi sulla pressione arteriosa.\n`;
            testo += `- Evitare completamente il fumo di sigaretta. Il fumo √® uno dei principali fattori di rischio cardiovascolare.\n`;
            testo += `- Limitare il consumo di alcol (massimo 1-2 bicchieri di vino al giorno per gli uomini, 1 per le donne). L'ideale sarebbe evitare del tutto le bevande alcoliche.\n`;
            testo += `- Evitare bevande zuccherate e energy drink.\n`;
            testo += `- Gestire lo stress attraverso tecniche di rilassamento, sonno regolare (7-8 ore per notte) e attivit√† piacevoli.`;

            return testo;
        }

        // Apply the generated text to the conclusions textarea
        let htGeneratedText = '';
        function applicaTestoHt() {
            const testoPreview = document.getElementById('ht-testo-preview');
            htGeneratedText = testoPreview.textContent;

            // Store for use in compilaVisita
            const notification = document.createElement('div');
            notification.textContent = 'Testo applicato alle conclusioni!';
            notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success-color); color: white; padding: 12px 20px; border-radius: 6px; z-index: 1000;';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // ===== PVC (EXTRASISTOLE VENTRICOLARI) SCENARIO FUNCTIONS =====
        // Based on ESC 2022 Guidelines for Ventricular Arrhythmias and SCD Prevention
        let pvcGeneratedText = '';

        function selectPvcScenario(esamiDisponibili) {
            selectedScenarioValue = 'primo-riscontro-pvc';
            document.getElementById('scenario-select').value = 'primo-riscontro-pvc';

            // Generate text based on available tests
            const testo = generatePvcScenarioText(esamiDisponibili);
            pvcGeneratedText = testo;

            // Build path for badge
            let esamiLabel;
            if (esamiDisponibili === 'holter-eco') {
                esamiLabel = 'Holter + Eco disponibili';
            } else if (esamiDisponibili === 'solo-holter') {
                esamiLabel = 'Solo Holter disponibile';
            } else {
                esamiLabel = 'Nessun esame disponibile';
            }

            const pathParts = ['Primo riscontro extrasistole ventricolari', esamiLabel];

            // Show badge
            const badge = document.getElementById('scenario-selected');
            badge.innerHTML = '<strong>Selezionato:</strong> ' + pathParts.join(' > ');
            badge.style.display = 'block';

            selectedScenarioLabel = pathParts.join(' > ');
        }

        function generatePvcScenarioText(esamiDisponibili) {
            let testo = '';

            // Common lifestyle advice based on ESC guidelines (triggers for arrhythmias)
            const lifestyleAdvice = `- Limitare il consumo di caffeina (caff√®, t√®, energy drink)\n- Moderare il consumo di alcol (evitare il binge drinking)\n- Gestire lo stress (sonno regolare, attivit√† fisica moderata, tecniche di rilassamento)\n- Evitare sostanze stimolanti`;

            if (esamiDisponibili === 'holter-eco') {
                // Both Holter and Echo available
                testo = `Riscontro di extrasistole ventricolari in assenza di cardiopatia strutturale, a prognosi benigna.`;
                testo += `\n\nSi consiglia:\n`;
                testo += `- ECG da sforzo\n`;
                testo += lifestyleAdvice + `\n`;
                testo += `- In caso di carico extrasistolico >10%: controllo ecocardiografico a 6-12 mesi\n`;
                testo += `- In caso di sintomi significativi: rivalutazione cardiologica`;

            } else if (esamiDisponibili === 'solo-holter') {
                // Only Holter available
                testo = `Riscontro di extrasistole ventricolari.`;
                testo += `\n\nSi consiglia:\n`;
                testo += `- Ecocardiogramma transtoracico\n`;
                testo += `- ECG da sforzo\n`;
                testo += lifestyleAdvice + `\n`;
                testo += `- Rivalutazione cardiologica con esito degli accertamenti`;

            } else {
                // No tests available
                testo = `Riscontro di extrasistole ventricolari.`;
                testo += `\n\nSi consiglia:\n`;
                testo += `- Ecocardiogramma transtoracico\n`;
                testo += `- ECG-Holter 24 ore\n`;
                testo += `- ECG da sforzo\n`;
                testo += lifestyleAdvice + `\n`;
                testo += `- Rivalutazione cardiologica con esito degli accertamenti`;
            }

            return testo;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const ageInput = document.getElementById("age");
            const paoInput = document.getElementById("pao");

            aggiornaEco();
            aggiornaEmatochimici();
            aggiornaSforzo();

            document.querySelectorAll('input[name="eco-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaEco));
            document.querySelectorAll('input[name="emato-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaEmatochimici));
            document.querySelectorAll('input[name="sforzo-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaSforzo));
            
            document.getElementById('copia-template-sforzo-cb').addEventListener('change', (e) => { if (e.target.checked) copiaTemplateSforzo('copia-sforzo-notification-cb'); });
            document.getElementById('copia-test-secondaria-cb').addEventListener('change', (e) => { if (e.target.checked) copiaTestSecondaria('copia-secondaria-notification-cb'); });

            const aggiungiLipidiCb = document.getElementById('aggiungi-consigli-lipidi-cb');
            const lipidiNotif = document.getElementById('aggiungi-lipidi-notification-cb');
            if (aggiungiLipidiCb && lipidiNotif) {
                aggiungiLipidiCb.addEventListener('change', () => {
                    aggiungereConsigliLipidi = aggiungiLipidiCb.checked;
                    lipidiNotif.style.display = aggiungereConsigliLipidi ? 'inline' : 'none';
                    if (aggiungereConsigliLipidi) setTimeout(() => { lipidiNotif.style.display = 'none'; }, 3000);
                });
            }

            const includeContactCb = document.getElementById('include-contact-info-cb');
            const contactNotif = document.getElementById('include-contact-info-notification-cb');
            if (includeContactCb && contactNotif) {
                includeContactCb.addEventListener('change', () => {
                    contactNotif.style.display = includeContactCb.checked ? 'inline' : 'none';
                    if (includeContactCb.checked) setTimeout(() => { contactNotif.style.display = 'none'; }, 3000);
                });
            }
            
            paoInput.addEventListener('input', updateSbpFromPao);

            // Auto-resize output textarea when user edits manually
            const outputVisitaTextarea = document.getElementById('output-visita');
            if (outputVisitaTextarea) {
                outputVisitaTextarea.addEventListener('input', () => autoResizeTextarea(outputVisitaTextarea));
            }

            const scoreInputsIds = ["age", "sbp", "col-tot", "col-hdl", "fumo"];
            scoreInputsIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("input", () => {
                        const ageVal = parseInt(ageInput.value, 10);
                        if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) {
                            calculateScore2();
                        } else {
                            document.getElementById("score2-result-display").textContent = "-";
                            const score2ErrorDiv = document.getElementById("score2-error");
                            if (isNaN(ageVal) || ageVal < 1) score2ErrorDiv.textContent = "Inserire et√† valida.";
                            else if (ageVal < 40 || ageVal > 69) score2ErrorDiv.textContent = "Et√† fuori range 40-69 per SCORE2.";
                            else score2ErrorDiv.textContent = "";
                        }
                    });
                }
            });
            
            const scoreLipidInputsIds = ["col-tot", "col-hdl", "trigliceridi-score"];
            scoreLipidInputsIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("input", () => {
                        calculateAndDisplayLdl();
                        updateEmatochimiciFromScore();
                    });
                }
            });

            document.querySelectorAll('input[name="sex"], input[name="risk_region"]').forEach(radio => {
                radio.addEventListener("change", () => {
                    const ageVal = parseInt(ageInput.value, 10);
                    if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) {
                        calculateScore2();
                    }
                });
            });

            // Aggiorna testo anamnesi prossima in base al sesso
            const anamnesiProssimaTextarea = document.getElementById("anamnesi-prossima");
            const anamnesiProssimaMale = "Paziente giunto alla nostra osservazione per controllo cardiologico di routine. Non riferisce dolore toracico, dispnea, cardiopalmo, lipotimie n√© sincopi.";
            const anamnesiProssimaFemale = "Paziente giunta alla nostra osservazione per controllo cardiologico di routine. Non riferisce dolore toracico, dispnea, cardiopalmo, lipotimie n√© sincopi.";

            document.querySelectorAll('input[name="sex"]').forEach(radio => {
                radio.addEventListener("change", (e) => {
                    const currentText = anamnesiProssimaTextarea.value.trim();
                    // Aggiorna solo se il testo √® uno dei due default
                    if (currentText === anamnesiProssimaMale || currentText === anamnesiProssimaFemale) {
                        anamnesiProssimaTextarea.value = (e.target.value === "male") ? anamnesiProssimaMale : anamnesiProssimaFemale;
                    }
                });
            });
            
            updateSbpFromPao();
            calculateAndDisplayLdl();
            
            const initialAge = parseInt(ageInput.value, 10);
            if (!isNaN(initialAge) && (initialAge < 40 || initialAge > 69)) {
                document.getElementById("score2-error").textContent = "Et√† fuori range 40-69 per SCORE2.";
                document.getElementById("score2-result-display").textContent = "-";
            } else if (!isNaN(initialAge)) {
                if (initialAge >= 40 && initialAge <= 69) calculateScore2();
            }
        });

    </script>
</head>

<body>
    <div class="container fade-in">
        <div class="header">
            <h1>ü´Ä Compilazione Rapida Visita Cardiologica</h1>
        </div>

        <div class="main-layout">
        <div class="form-column">

        <div class="section">
            <h2>üë§ Informazioni Paziente</h2>
            <div class="form-row">
                <div>
                    <label for="age">Et√† (opzionale)</label>
                    <input type="number" id="age" name="age" min="1" placeholder="Anni (40-69 per SCORE2)">
                </div>
                <div>
                    <label>Sesso (opzionale)</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="sex-male" name="sex" value="male">
                            <label for="sex-male" class="label-inline">üë® Uomo</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="sex-female" name="sex" value="female">
                            <label for="sex-female" class="label-inline">üë© Donna</label>
                        </div>
                    </div>
                </div>
            </div>
            <span class="note">Se non inseriti, et√† e sesso non verranno stampati nell'output della visita.</span>
        </div>

        <div class="section">
            <h2>‚ö†Ô∏è Fattori di Rischio Cardiovascolare</h2>
            <div class="card">
                <div class="checkbox-group" style="grid-template-columns: repeat(4, 1fr); display: grid; gap: 8px 12px;">
                    <div class="checkbox-item"><input type="checkbox" id="fumo" name="fumo"><label for="fumo" class="label-inline">Fumo Attuale</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pregresso-fumo" name="pregresso-fumo"><label for="pregresso-fumo" class="label-inline">Pregresso fumo</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="diabete" name="diabete"><label for="diabete" class="label-inline">Diabete</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipertensione" name="ipertensione"><label for="ipertensione" class="label-inline">Ipertensione</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipercolesterolemia" name="ipercolesterolemia"><label for="ipercolesterolemia" class="label-inline">Ipercolesterolemia</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="obesita" name="obesita"><label for="obesita" class="label-inline">Obesit√†</label></div>
                    <div class="checkbox-item" style="grid-column: span 2;"><input type="checkbox" id="familiarita" name="familiarita"><label for="familiarita" class="label-inline">Familiarit√† positiva per MCV</label></div>
                </div>
            </div>
        </div>

        <!-- SCORE2 Section moved to sidebar -->

        <div class="section">
            <h2>üìã Anamnesi</h2>
            <div class="anamnesi-grid">
                <div>
                    <label for="anamnesi-familiare">Familiare</label>
                    <textarea id="anamnesi-familiare" name="anamnesi-familiare" rows="1" placeholder="Anamnesi familiare...">Nessuna familiarit√† riferita per malattia coronarica precoce (M <55, F <65), morte improvvisa o cardiomiopatie ereditarie.</textarea>
                </div>
                <div>
                    <label for="anamnesi-remota">Patologica Remota</label>
                    <textarea id="anamnesi-remota" name="anamnesi-remota" rows="1" placeholder="Anamnesi patologica remota">Priva di rilievi significativi</textarea>
                </div>
                <div>
                    <label for="anamnesi-cv">Cardiovascolare</label>
                    <textarea id="anamnesi-cv" name="anamnesi-cv" rows="1" placeholder="Anamnesi cardiovascolare">Non riferisce precedenti eventi cardiovascolari</textarea>
                </div>
                <div>
                    <label for="anamnesi-prossima">Patologica Prossima</label>
                    <textarea id="anamnesi-prossima" name="anamnesi-prossima" rows="2" placeholder="Anamnesi patologica prossima">Paziente giunto alla nostra osservazione per controllo cardiologico di routine. Non riferisce dolore toracico, dispnea, cardiopalmo, lipotimie n√© sincopi.</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üíä Terapia in Atto</h2>
            <div class="terapia-grid">
                <div><input type="text" id="farmaco1" placeholder="Farmaco 1"><input type="text" id="dose1" placeholder="mg"></div>
                <div><input type="text" id="farmaco2" placeholder="Farmaco 2"><input type="text" id="dose2" placeholder="mg"></div>
                <div><input type="text" id="farmaco3" placeholder="Farmaco 3"><input type="text" id="dose3" placeholder="mg"></div>
                <div><input type="text" id="farmaco4" placeholder="Farmaco 4"><input type="text" id="dose4" placeholder="mg"></div>
                <div><input type="text" id="farmaco5" placeholder="Farmaco 5"><input type="text" id="dose5" placeholder="mg"></div>
                <div><input type="text" id="farmaco6" placeholder="Farmaco 6"><input type="text" id="dose6" placeholder="mg"></div>
            </div>
            <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="farmaco7" placeholder="Farmaco 7" style="flex: 2;">
                    <input type="text" id="dose7" placeholder="mg" style="flex: 1;">
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ü©∫ Esame Obiettivo</h2>
            <div class="esame-obiettivo-grid">
                <div>
                    <label for="esame-polmonare">Polmonare</label>
                    <textarea id="esame-polmonare" name="esame-polmonare" rows="1" placeholder="Esame polmonare">Murmure vescicolare normotrasmesso, non rumori patologici aggiunti, non stasi</textarea>
                </div>
                <div>
                    <label for="esame-cardiaco">Cardiaco</label>
                    <textarea id="esame-cardiaco" name="esame-cardiaco" rows="1" placeholder="Esame cardiaco">Toni cardiaci netti in successione ritmica, pause libere. Buono il compenso emodinamico</textarea>
                </div>
            </div>
            <span class="note">PAO: Vedi sidebar SCORE2.</span>
        </div>

        <div class="section">
            <h2>üìà ECG</h2>
            <textarea id="ecg" name="ecg" rows="1" placeholder="Inserisci il risultato dell'ECG">Ritmo sinusale normofrequente, conduzione AV e IV nei limiti, alterazioni aspecifiche del tratto ST-T</textarea>
        </div>

        <div class="section">
            <h2>ü´Ä Ecocardiogramma Color Doppler</h2>
            <div class="radio-inline-group">
                <div class="radio-item"><input type="radio" id="eco-normale" name="eco-tipo" value="normale"><label for="eco-normale" class="label-inline">Normale</label></div>
                <div class="radio-item"><input type="radio" id="eco-anziano" name="eco-tipo" value="anziano"><label for="eco-anziano" class="label-inline">Anziano</label></div>
                <div class="radio-item"><input type="radio" id="eco-nessuno" name="eco-tipo" value="nessuno" checked=""><label for="eco-nessuno" class="label-inline">Manuale/Vuoto</label></div>
            </div>
            <textarea id="eco-text" name="eco-text" rows="3" placeholder="Seleziona un'opzione o inserisci manualmente il referto..."></textarea>
        </div>

        <div class="section">
            <h2>üèÉ Test da sforzo</h2>
            <div class="radio-inline-group">
                <div class="radio-item"><input type="radio" id="sforzo-normale" name="sforzo-tipo" value="normale"><label for="sforzo-normale" class="label-inline">Normale</label></div>
                <div class="radio-item"><input type="radio" id="sforzo-nessuno" name="sforzo-tipo" value="altro" checked=""><label for="sforzo-nessuno" class="label-inline">Manuale/Vuoto</label></div>
                <div class="checkbox-item"><input type="checkbox" id="copia-template-sforzo-cb"><label for="copia-template-sforzo-cb" class="label-inline">üìã Copia Template</label><span id="copia-sforzo-notification-cb" class="checkbox-notification success">Copiato!</span></div>
            </div>
            <textarea id="sforzo-text" name="sforzo-text" rows="1" placeholder="Inserire breve descrizione o lasciare vuoto..."></textarea>
        </div>

        <div class="section">
            <h2>üß™ Esami Ematochimici</h2>
            <div class="radio-inline-group">
                <div class="radio-item"><input type="radio" id="emato-nei-limiti" name="emato-tipo"><label for="emato-nei-limiti" class="label-inline">Nei limiti</label></div>
                <div class="radio-item"><input type="radio" id="emato-colesterolo" name="emato-tipo"><label for="emato-colesterolo" class="label-inline">Lipidi</label></div>
                <div class="radio-item"><input type="radio" id="emato-non-disponibili" name="emato-tipo" checked=""><label for="emato-non-disponibili" class="label-inline">Manuale</label></div>
            </div>
            <textarea id="emato-text" name="emato-text" rows="2" placeholder="I valori lipidici verranno popolati automaticamente..."></textarea>
        </div>

        <div class="section">
            <h2>üìù Conclusioni e Raccomandazioni</h2>

            <label>Seleziona Scenario Clinico</label>
            <nav class="scenario-tree-menu">
                <ul class="scenario-menu-root">
                    <li><a href="#" onclick="selectScenario('terapia'); return false;">Confermare terapia in atto</a></li>
                    <li><a href="#" onclick="selectScenario('angio-tc'); return false;">Angio-TC coronarica</a></li>
                    <li><a href="#" onclick="selectScenario('holter'); return false;">ECG-Holter 24h</a></li>
                    <li><a href="#" onclick="selectScenario('eco'); return false;">EcocolorDoppler cardiaco</a></li>
                    <li><a href="#" onclick="selectScenario('imaging'); return false;">Test imaging da stress</a></li>
                    <li><a href="#" onclick="selectScenario('ematochimici'); return false;">Esami ematochimici</a></li>
                    <li><a href="#" onclick="selectScenario('no-accertamenti'); return false;">Nessun ulteriore accertamento</a></li>
                    <li><a href="#" onclick="selectScenario('lipidi'); return false;">Consigli Lipidi</a></li>
                    <li><a href="#" onclick="selectLdlAutoScenario(); return false;">LDL elevato (auto da SCORE2)</a></li>
                    <li><a href="#" onclick="selectScenario('ipertensione'); return false;">Ipertensione secondaria</a></li>
                    <li><a href="#" onclick="selectScenario('contatto'); return false;">Info Contatto</a></li>
                    <li class="has-submenu">
                        <span class="menu-parent">Primo riscontro ipertensione &rarr;</span>
                        <ul class="submenu">
                            <li class="has-submenu">
                                <span class="menu-parent">Esami disponibili &rarr;</span>
                                <ul class="submenu">
                                    <li class="has-submenu">
                                        <span class="menu-parent">LDL &lt; 116 &rarr;</span>
                                        <ul class="submenu">
                                            <li class="has-submenu">
                                                <span class="menu-parent">No diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','no','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','no','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','no','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','no','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                            <li class="has-submenu">
                                                <span class="menu-parent">Diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','si','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','si','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','si','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','normale','si','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="has-submenu">
                                        <span class="menu-parent">LDL 116-190 &rarr;</span>
                                        <ul class="submenu">
                                            <li class="has-submenu">
                                                <span class="menu-parent">No diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','no','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','no','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','no','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','no','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                            <li class="has-submenu">
                                                <span class="menu-parent">Diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','si','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','si','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','si','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','elevato','si','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="has-submenu">
                                        <span class="menu-parent">LDL &gt; 190 &rarr;</span>
                                        <ul class="submenu">
                                            <li class="has-submenu">
                                                <span class="menu-parent">No diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','no','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','no','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','no','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','no','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                            <li class="has-submenu">
                                                <span class="menu-parent">Diabete &rarr;</span>
                                                <ul class="submenu">
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','si','basso'); return false;">Rischio Basso</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','si','moderato'); return false;">Rischio Moderato</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','si','alto'); return false;">Rischio Alto</a></li>
                                                    <li><a href="#" onclick="selectHtScenario('disponibili','molto-elevato','si','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="has-submenu">
                                <span class="menu-parent">Esami da richiedere &rarr;</span>
                                <ul class="submenu">
                                    <li><a href="#" onclick="selectHtScenario('da-richiedere','','no',''); return false;">No diabete</a></li>
                                    <li><a href="#" onclick="selectHtScenario('da-richiedere','','si',''); return false;">Diabete</a></li>
                                </ul>
                            </li>
                            <li class="has-submenu">
                                <span class="menu-parent">Esami in attesa di esito &rarr;</span>
                                <ul class="submenu">
                                    <li><a href="#" onclick="selectHtScenario('in-attesa','','no',''); return false;">No diabete</a></li>
                                    <li><a href="#" onclick="selectHtScenario('in-attesa','','si',''); return false;">Diabete</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="has-submenu">
                        <span class="menu-parent">Primo riscontro LDL elevato &rarr;</span>
                        <ul class="submenu">
                            <li class="has-submenu">
                                <span class="menu-parent">LDL 116-190 mg/dL &rarr;</span>
                                <ul class="submenu">
                                    <li><a href="#" onclick="selectLdlScenario('elevato','basso'); return false;">Rischio Basso</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('elevato','moderato'); return false;">Rischio Moderato</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('elevato','alto'); return false;">Rischio Alto</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('elevato','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                </ul>
                            </li>
                            <li class="has-submenu">
                                <span class="menu-parent">LDL &gt; 190 mg/dL &rarr;</span>
                                <ul class="submenu">
                                    <li><a href="#" onclick="selectLdlScenario('molto-elevato','basso'); return false;">Rischio Basso</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('molto-elevato','moderato'); return false;">Rischio Moderato</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('molto-elevato','alto'); return false;">Rischio Alto</a></li>
                                    <li><a href="#" onclick="selectLdlScenario('molto-elevato','molto-alto'); return false;">Rischio Molto Alto</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="has-submenu">
                        <span class="menu-parent">Primo riscontro extrasistole ventricolari &rarr;</span>
                        <ul class="submenu">
                            <li><a href="#" onclick="selectPvcScenario('holter-eco'); return false;">Holter + Ecocardiogramma disponibili</a></li>
                            <li><a href="#" onclick="selectPvcScenario('solo-holter'); return false;">Solo Holter disponibile</a></li>
                            <li><a href="#" onclick="selectPvcScenario('nessuno'); return false;">Nessun esame disponibile</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div id="scenario-selected" class="scenario-selected-badge" style="display: none;"></div>

            <!-- Hidden select to maintain compatibility -->
            <select id="scenario-select" name="scenario-select" style="display: none;">
                <option value=""></option>
                <option value="terapia">terapia</option>
                <option value="angio-tc">angio-tc</option>
                <option value="holter">holter</option>
                <option value="eco">eco</option>
                <option value="imaging">imaging</option>
                <option value="ematochimici">ematochimici</option>
                <option value="no-accertamenti">no-accertamenti</option>
                <option value="lipidi">lipidi</option>
                <option value="ipertensione">ipertensione</option>
                <option value="contatto">contatto</option>
                <option value="primo-riscontro-ht">primo-riscontro-ht</option>
                <option value="primo-riscontro-ldl">primo-riscontro-ldl</option>
                <option value="primo-riscontro-pvc">primo-riscontro-pvc</option>
            </select>

            <!-- Hidden checkboxes to maintain compatibility with existing code -->
            <div style="display: none;">
                <input type="checkbox" id="consiglio-terapia">
                <input type="checkbox" id="consiglio-angio-tc">
                <input type="checkbox" id="consiglio-holter">
                <input type="checkbox" id="consiglio-eco">
                <input type="checkbox" id="consiglio-imaging">
                <input type="checkbox" id="consiglio-ematochimici">
                <input type="checkbox" id="consiglio-no-accertamenti">
                <input type="checkbox" id="aggiungi-consigli-lipidi-cb">
                <input type="checkbox" id="copia-test-secondaria-cb">
                <input type="checkbox" id="include-contact-info-cb">
            </div>
        </div>

        </div><!-- End form-column -->

        <div class="sidebar-column">

        <div class="section">
            <h2>üìä SCORE2 e Lipidi</h2>
            <div class="score-section" style="margin: 0; padding: 12px;">
                <div class="form-group" style="margin-bottom: 8px;">
                    <label for="pao">PAO (Esame Obiettivo)</label>
                    <input type="text" id="pao" name="pao" value="120/80 mmHg" placeholder="Es. 130/85 mmHg">
                    <span class="note">Sistolica auto-popolata in SBP sotto.</span>
                    <div id="bp-category-display" class="info-message" aria-live="polite" role="status" style="margin-top:6px; display:none; padding: 6px; font-size: 0.75em;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <div>
                        <label for="sbp">SBP</label>
                        <input type="number" id="sbp" name="sbp" placeholder="mmHg" readonly>
                    </div>
                    <div>
                        <label for="col-tot">Col Tot</label>
                        <input type="number" id="col-tot" name="col-tot" placeholder="mg/dL">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <div>
                        <label for="col-hdl">HDL</label>
                        <input type="number" id="col-hdl" name="col-hdl" placeholder="mg/dL">
                    </div>
                    <div>
                        <label for="trigliceridi-score">Trigliceridi</label>
                        <input type="number" id="trigliceridi-score" name="trigliceridi-score" placeholder="mg/dL">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 8px;">
                    <label for="ldl-calculated">LDL (calcolato - Friedewald)</label>
                    <input type="text" id="ldl-calculated" name="ldl-calculated" placeholder="Auto" readonly>
                    <span id="ldl-calculation-note" class="note">Valido per Trigliceridi < 400 mg/dL.</span>
                </div>

                <div class="info-message" style="font-size: 0.75em; padding: 6px; margin: 8px 0;">
                    I valori lipidici popoleranno automaticamente la sezione Ematochimici.
                </div>

                <!-- Regione fissa: Moderato (Italia) -->
                <input type="radio" id="region-moderate" name="risk_region" value="2" checked="" style="display: none;">

                <div class="score-result" style="padding: 10px; margin: 8px 0;">
                    <label style="font-size: 0.9em; margin-bottom: 6px; display: block;">Rischio CVD 10y (SCORE2 - Italia)</label>
                    <div>
                        <span id="score2-result-display">-</span>
                    </div>
                    <span class="note">Apparir√† nel report finale.</span>
                </div>

                <div id="score2-error" class="error-message" style="padding: 6px; font-size: 0.75em;"></div>
            </div>
        </div>

        </div><!-- End sidebar-column -->
        </div><!-- End main-layout -->

        <!-- Output Visita Section - Full Width -->
        <div class="output-section-wrapper">
            <h2>üìÑ Output Visita</h2>
            <button type="button" class="main-action" onclick="compilaVisita()" style="margin-bottom: 15px; max-width: 300px;">Compila e Copia</button>
            <textarea id="output-visita" name="output-visita" rows="10" placeholder="L'output della visita verr√† generato qui..."></textarea>
            <div id="copy-notification" class="copy-notification" style="padding: 10px; margin-top: 12px; font-size: 0.95em;">‚úÖ Testo visita copiato negli appunti!</div>
        </div>

    </div><!-- End container -->

    <!-- Editor Scenari Toggle Button -->
    <button id="scenari-editor-toggle" onclick="toggleScenariEditor()">Editor Scenari</button>

    <!-- Editor Overlay -->
    <div id="scenari-editor-overlay" onclick="toggleScenariEditor()"></div>

    <!-- Editor Scenari Panel - Full Modal -->
    <div id="scenari-editor-panel">
        <div class="editor-header">
            <h2>Editor Scenari Clinici</h2>
            <button class="close-btn" onclick="toggleScenariEditor()">&times;</button>
        </div>

        <div class="editor-body">
            <div class="editor-sidebar">
                <div class="github-token-section" id="password-section">
                    <strong>Password Editor</strong>
                    <input type="password" id="editor-password" placeholder="Inserisci password" style="width:100%;">
                    <button onclick="unlockEditor()" class="btn-add" style="width:100%;margin-top:10px;">Sblocca Editor</button>
                </div>
                <div class="github-token-section" id="unlocked-section" style="display:none;background:linear-gradient(135deg, #d1e7dd 0%, #a3cfbb 100%);">
                    <strong style="color:#0f5132;">Editor Sbloccato</strong>
                </div>
                <div id="editor-status"></div>
                <div class="editor-legend" style="margin-top:20px;padding:12px;background:#f8f9fa;border-radius:8px;font-size:12px;">
                    <strong style="display:block;margin-bottom:8px;">Legenda:</strong>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="badge-simple">S</span> Scenario semplice (solo testo)
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="badge-cascading">C</span> Scenario a cascata (con livelli)
                    </div>
                </div>
            </div>

            <div class="editor-main">
                <h3 style="margin-top:0;margin-bottom:20px;color:#495057;">Tutti gli Scenari</h3>
                <div id="scenari-unified-list">
                    <p style="color:#666;">Sblocca l'editor per caricare gli scenari...</p>
                </div>
            </div>
        </div>

        <div class="editor-actions">
            <button class="btn-secondary" onclick="toggleScenariEditor()">Chiudi</button>
            <button class="btn-add" onclick="addNewScenario()">+ Aggiungi Scenario</button>
            <button class="btn-save" onclick="saveScenariToGitHub()">Salva su GitHub</button>
        </div>
    </div>

    <script>
        // ===== EDITOR SCENARI =====
        let scenariData = null;
        let scenariSha = null;
        let editorToken = null;
        const REPO_OWNER = 'bdeornelas';
        const REPO_NAME = 'bdeornelas.github.io';
        const FILE_PATH = 'scenari.json';

        // Token criptato con XOR
        const ENCRYPTED_TOKEN = 'V15AbUVTYWsGc3dLVlt2A2F1WkdkSA5qX3N1YV1DYVRXQANGB1pMBQ==';

        function xorDecrypt(encryptedBase64, password) {
            const encrypted = atob(encryptedBase64);
            let result = '';
            for (let i = 0; i < encrypted.length; i++) {
                result += String.fromCharCode(encrypted.charCodeAt(i) ^ password.charCodeAt(i % password.length));
            }
            return result;
        }

        function unlockEditor() {
            const password = document.getElementById('editor-password').value;
            const decrypted = xorDecrypt(ENCRYPTED_TOKEN, password);
            if (decrypted.startsWith('ghp_')) {
                editorToken = decrypted;
                document.getElementById('password-section').style.display = 'none';
                document.getElementById('unlocked-section').style.display = 'block';
                loadScenari();
            } else {
                alert('Password errata');
            }
        }

        function toggleScenariEditor() {
            const panel = document.getElementById('scenari-editor-panel');
            const overlay = document.getElementById('scenari-editor-overlay');
            panel.classList.toggle('open');
            overlay.classList.toggle('open');
            if (panel.classList.contains('open') && !scenariData) {
                loadScenari();
            }
        }

        async function loadScenari() {
            const statusEl = document.getElementById('editor-status');
            try {
                statusEl.innerHTML = '<p style="color:#666;">Caricamento scenari...</p>';

                // Load from GitHub API to get SHA
                let response;
                if (editorToken) {
                    response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        headers: { 'Authorization': `token ${editorToken}` }
                    });
                } else {
                    // Fallback to direct file load
                    response = await fetch('scenari.json');
                    const data = await response.json();
                    scenariData = data;
                    renderScenariList();
                    statusEl.innerHTML = '<p style="color:#28a745;">Scenari caricati (locale)</p>';
                    return;
                }

                if (response.ok) {
                    const fileData = await response.json();
                    scenariSha = fileData.sha;
                    scenariData = JSON.parse(atob(fileData.content));
                    renderScenariList();
                    statusEl.innerHTML = '<p style="color:#28a745;">Scenari caricati da GitHub</p>';
                } else {
                    // Try direct load
                    const directResponse = await fetch('scenari.json');
                    scenariData = await directResponse.json();
                    renderScenariList();
                    statusEl.innerHTML = '<p style="color:#28a745;">Scenari caricati (locale)</p>';
                }
            } catch (err) {
                statusEl.innerHTML = `<p style="color:red;">Errore: ${err.message}</p>`;
            }
        }

        function renderScenariList() {
            const listEl = document.getElementById('scenari-unified-list');

            if (!scenariData) {
                listEl.innerHTML = '<p>Nessuno scenario trovato</p>';
                return;
            }

            let html = '';

            // Merge all scenarios into a unified list
            const allScenarios = [];

            // Add base scenarios
            if (scenariData.scenari_base) {
                for (const [key, scenario] of Object.entries(scenariData.scenari_base)) {
                    allScenarios.push({ key, scenario, type: 'simple' });
                }
            }

            // Add cascading scenarios
            if (scenariData.scenari_concatenati) {
                for (const [key, scenario] of Object.entries(scenariData.scenari_concatenati)) {
                    allScenarios.push({ key, scenario, type: 'cascading' });
                }
            }

            if (allScenarios.length === 0) {
                listEl.innerHTML = '<p style="color:#666;">Nessuno scenario presente. Clicca "+ Aggiungi Scenario" per iniziare.</p>';
                return;
            }

            // Render unified list
            for (const item of allScenarios) {
                html += renderUnifiedScenario(item.key, item.scenario, item.type);
            }

            listEl.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.unified-scenario-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.closest('.unified-scenario').classList.toggle('expanded');
                });
            });
        }

        function renderUnifiedScenario(key, scenario, type) {
            const isCascading = type === 'cascading' || (scenario.livelli && scenario.livelli.length > 0);
            const numLevels = scenario.livelli ? scenario.livelli.length : 0;
            const numTexts = scenario.testi ? Object.keys(scenario.testi).length : 0;
            const badgeClass = isCascading ? 'badge-cascading' : 'badge-simple';
            const badgeText = isCascading ? 'C' : 'S';
            const badgeTitle = isCascading ? `${numLevels} livelli, ${numTexts} testi` : 'Scenario semplice';

            let html = `
                <div class="unified-scenario ${isCascading ? 'cascading' : 'simple'}" data-key="${key}" data-type="${type}">
                    <div class="unified-scenario-header">
                        <span class="${badgeClass}" title="${badgeTitle}">${badgeText}</span>
                        <h4>${scenario.nome || key}</h4>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="unified-scenario-body">
                        <div class="scenario-field">
                            <label>ID (chiave)</label>
                            <input type="text" value="${key}" readonly style="background:#f0f0f0;">
                        </div>
                        <div class="scenario-field">
                            <label>Nome</label>
                            <input type="text" value="${scenario.nome || ''}" onchange="updateUnifiedField('${key}', '${type}', 'nome', this.value)">
                        </div>
            `;

            // For simple scenarios, show single text field
            if (!isCascading) {
                html += `
                        <div class="scenario-field">
                            <label>Testo</label>
                            <textarea rows="4" onchange="updateUnifiedField('${key}', '${type}', 'testo', this.value)">${scenario.testo || ''}</textarea>
                        </div>
                `;
            }

            // For cascading scenarios, show levels and texts
            if (isCascading) {
                html += `
                        <div class="scenario-field">
                            <label>Descrizione</label>
                            <input type="text" value="${scenario.descrizione || ''}" onchange="updateUnifiedField('${key}', '${type}', 'descrizione', this.value)">
                        </div>
                        <div class="levels-section">
                            <div class="section-header">
                                <strong>Livelli del menu</strong>
                                <button class="btn-small" onclick="addLevelToScenario('${key}')">+ Livello</button>
                            </div>
                `;

                if (scenario.livelli && scenario.livelli.length > 0) {
                    scenario.livelli.forEach((level, idx) => {
                        const options = Array.isArray(level.opzioni)
                            ? level.opzioni.map(o => typeof o === 'object' ? o.label : o).join(', ')
                            : '';
                        html += `
                            <div class="level-item">
                                <div class="level-header">
                                    <span class="level-num">${idx + 1}</span>
                                    <strong>${level.label}</strong>
                                    <code>${level.id}</code>
                                    <button class="btn-delete-small" onclick="removeLevelFromScenario('${key}', ${idx})">&times;</button>
                                </div>
                                <div class="level-options">${options}</div>
                                ${level.condizione ? `<div class="level-condition">Condizione: <code>${level.condizione}</code></div>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<p class="no-items">Nessun livello. Aggiungi livelli per creare un menu a cascata.</p>';
                }

                html += `
                        </div>
                        <div class="texts-section">
                            <div class="section-header">
                                <strong>Testi</strong>
                                <button class="btn-small" onclick="addTextToScenario('${key}')">+ Testo</button>
                            </div>
                `;

                if (scenario.testi && Object.keys(scenario.testi).length > 0) {
                    for (const [textKey, textValue] of Object.entries(scenario.testi)) {
                        html += `
                            <div class="text-item">
                                <div class="text-header">
                                    <code>${textKey}</code>
                                    <button class="btn-delete-small" onclick="removeTextFromScenario('${key}', '${textKey}')">&times;</button>
                                </div>
                                <textarea rows="3" onchange="updateScenarioText('${key}', '${textKey}', this.value)">${textValue}</textarea>
                            </div>
                        `;
                    }
                } else {
                    html += '<p class="no-items">Nessun testo definito.</p>';
                }

                html += '</div>';
            }

            // Action buttons
            html += `
                        <div class="scenario-actions">
                            ${!isCascading ? `<button class="btn-convert" onclick="convertTo–°ascading('${key}')">Converti in Cascata</button>` : ''}
                            <button class="btn-delete" onclick="deleteUnifiedScenario('${key}', '${type}')">Elimina Scenario</button>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function updateUnifiedField(key, type, field, value) {
            const category = type === 'cascading' ? 'scenari_concatenati' : 'scenari_base';
            if (scenariData[category] && scenariData[category][key]) {
                scenariData[category][key][field] = value;
            }
        }

        function updateScenarioText(key, textKey, value) {
            if (scenariData.scenari_concatenati && scenariData.scenari_concatenati[key]) {
                if (!scenariData.scenari_concatenati[key].testi) {
                    scenariData.scenari_concatenati[key].testi = {};
                }
                scenariData.scenari_concatenati[key].testi[textKey] = value;
            }
        }

        function convertTo–°ascading(key) {
            if (!scenariData.scenari_base || !scenariData.scenari_base[key]) return;

            const scenario = scenariData.scenari_base[key];

            // Create cascading version
            if (!scenariData.scenari_concatenati) scenariData.scenari_concatenati = {};
            scenariData.scenari_concatenati[key] = {
                nome: scenario.nome,
                descrizione: '',
                livelli: [],
                testi: scenario.testo ? { base: scenario.testo } : {}
            };

            // Remove from base
            delete scenariData.scenari_base[key];

            renderScenariList();
            setTimeout(() => {
                const item = document.querySelector(`.unified-scenario[data-key="${key}"]`);
                if (item) item.classList.add('expanded');
            }, 100);
        }

        function deleteUnifiedScenario(key, type) {
            if (!confirm(`Eliminare lo scenario "${key}"?`)) return;

            const category = type === 'cascading' ? 'scenari_concatenati' : 'scenari_base';
            if (scenariData[category]) {
                delete scenariData[category][key];
            }
            renderScenariList();
        }

        function addLevelToScenario(scenarioKey) {
            const id = prompt('ID del livello (es: "esami", "rischio"):');
            if (!id) return;
            const label = prompt('Label del livello (es: "Stato esami", "Rischio CV"):');
            if (!label) return;
            const opzioniStr = prompt('Opzioni separate da virgola (es: "basso,moderato,alto"):');
            if (!opzioniStr) return;

            const opzioni = opzioniStr.split(',').map(o => o.trim());

            if (!scenariData.scenari_concatenati[scenarioKey].livelli) {
                scenariData.scenari_concatenati[scenarioKey].livelli = [];
            }
            scenariData.scenari_concatenati[scenarioKey].livelli.push({ id, label, opzioni });
            renderScenariList();

            // Re-expand the item
            setTimeout(() => {
                const item = document.querySelector(`.unified-scenario[data-key="${scenarioKey}"]`);
                if (item) item.classList.add('expanded');
            }, 100);
        }

        function removeLevelFromScenario(scenarioKey, levelIdx) {
            if (!confirm('Rimuovere questo livello?')) return;
            if (scenariData.scenari_concatenati[scenarioKey].livelli) {
                scenariData.scenari_concatenati[scenarioKey].livelli.splice(levelIdx, 1);
            }
            renderScenariList();
            setTimeout(() => {
                const item = document.querySelector(`.unified-scenario[data-key="${scenarioKey}"]`);
                if (item) item.classList.add('expanded');
            }, 100);
        }

        function addTextToScenario(scenarioKey) {
            const textKey = prompt('Chiave del testo (es: "base", "rischio_alto"):');
            if (!textKey) return;

            if (!scenariData.scenari_concatenati[scenarioKey].testi) {
                scenariData.scenari_concatenati[scenarioKey].testi = {};
            }
            scenariData.scenari_concatenati[scenarioKey].testi[textKey] = '';
            renderScenariList();

            setTimeout(() => {
                const item = document.querySelector(`.unified-scenario[data-key="${scenarioKey}"]`);
                if (item) item.classList.add('expanded');
            }, 100);
        }

        function removeTextFromScenario(scenarioKey, textKey) {
            if (!confirm(`Rimuovere il testo "${textKey}"?`)) return;
            if (scenariData.scenari_concatenati[scenarioKey].testi) {
                delete scenariData.scenari_concatenati[scenarioKey].testi[textKey];
            }
            renderScenariList();
            setTimeout(() => {
                const item = document.querySelector(`.unified-scenario[data-key="${scenarioKey}"]`);
                if (item) item.classList.add('expanded');
            }, 100);
        }

        function addNewScenario() {
            const id = prompt('ID del nuovo scenario (es: "nuovo-scenario"):');
            if (!id) return;
            const nome = prompt('Nome visualizzato:');
            if (!nome) return;

            const isCascading = confirm('Creare come scenario a cascata (con livelli)?\n\nOK = Scenario a cascata\nAnnulla = Scenario semplice (solo testo)');

            if (isCascading) {
                if (!scenariData.scenari_concatenati) scenariData.scenari_concatenati = {};
                scenariData.scenari_concatenati[id] = {
                    nome: nome,
                    descrizione: '',
                    livelli: [],
                    testi: {}
                };
            } else {
                if (!scenariData.scenari_base) scenariData.scenari_base = {};
                scenariData.scenari_base[id] = { nome: nome, testo: '' };
            }

            renderScenariList();

            // Expand the new item
            setTimeout(() => {
                const newItem = document.querySelector(`.unified-scenario[data-key="${id}"]`);
                if (newItem) newItem.classList.add('expanded');
            }, 100);
        }

        async function saveScenariToGitHub() {
            const statusEl = document.getElementById('editor-status');

            if (!editorToken) {
                statusEl.innerHTML = '<div class="status-msg error">Editor non sbloccato. Inserire la password.</div>';
                return;
            }

            statusEl.innerHTML = '<div class="status-msg">Salvataggio in corso...</div>';

            try {
                // Get current SHA if we don't have it
                if (!scenariSha) {
                    const shaResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        headers: { 'Authorization': `token ${editorToken}` }
                    });
                    if (shaResponse.ok) {
                        const shaData = await shaResponse.json();
                        scenariSha = shaData.sha;
                    }
                }

                const content = btoa(unescape(encodeURIComponent(JSON.stringify(scenariData, null, 2))));

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${editorToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update scenari.json from web editor',
                        content: content,
                        sha: scenariSha
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    scenariSha = result.content.sha;
                    statusEl.innerHTML = '<div class="status-msg success">Salvato con successo!</div>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
                } else {
                    const err = await response.json();
                    statusEl.innerHTML = `<div class="status-msg error">Errore: ${err.message}</div>`;
                }
            } catch (err) {
                statusEl.innerHTML = `<div class="status-msg error">Errore: ${err.message}</div>`;
            }
        }


    </script>
</body>
</html>
