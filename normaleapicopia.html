<!DOCTYPE html>
<html lang="it">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilazione Visita Cardiologica (API) - Ottimizzata</title>
    <style>
        /* ===== CSS OTTIMIZZATO - Ridotto da 1000+ a ~400 righe ===== */
        :root {
            --primary: #6366f1;
            --secondary: #f8fafc;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --light-gray: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --muted: #64748b;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 1rem auto;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 50%, var(--success) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .section {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }

        .section:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .section:last-child { border-bottom: none; }

        h1 { font-size: 2rem; font-weight: 700; margin: 0; }
        h2 { 
            color: var(--primary); 
            font-size: 1.25rem; 
            font-weight: 600; 
            margin: 0 0 1rem 0; 
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h3 { 
            color: var(--accent); 
            font-size: 1.1rem; 
            margin: 1rem 0 0.5rem 0; 
            font-weight: 600;
        }

        /* Input ottimizzati */
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[readonly] {
            background: var(--light-gray) !important;
            cursor: not-allowed;
            color: var(--muted);
        }

        textarea {
            resize: vertical;
            font-family: inherit;
            min-height: 80px;
        }

        /* Layout responsive ottimizzato */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        /* Checkbox/Radio ottimizzati */
        .checkbox-group, .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .checkbox-item:hover, .radio-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .checkbox-item input, .radio-item input {
            margin-right: 0.5rem;
            width: auto;
        }

        /* Pulsanti ottimizzati */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--accent);
        }

        /* Score section ottimizzata */
        .score-section {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .score-result {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid var(--danger);
        }

        /* Notifications ottimizzate */
        .notification {
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            display: none;
        }

        .notification.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .notification.info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--info);
            color: var(--info);
        }

        /* Output area */
        #output-visita {
            background: var(--light-gray);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 300px;
        }

        /* Note e cards */
        .note {
            font-size: 0.85rem;
            color: var(--muted);
            font-style: italic;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            border-left: 3px solid var(--info);
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid var(--border);
        }

        /* Lazy loading states */
        .lazy-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .lazy-section.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Loading spinner ottimizzato */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Media queries ottimizzate */
        @media (max-width: 768px) {
            .container { margin: 0.5rem; }
            .section { padding: 1rem; }
            .form-row { grid-template-columns: 1fr; }
            .checkbox-group, .radio-group { grid-template-columns: 1fr; }
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.1rem; }
        }

        /* Print styles */
        @media print {
            .container { box-shadow: none; border: none; }
            .section { border-bottom: 1px solid #000; }
            button, .notification { display: none !important; }
        }

        /* Performance optimizations */
        .will-change-transform {
            will-change: transform;
        }

        .gpu-layer {
            transform: translateZ(0);
        }
    </style>
</head>

<body>
    <div class="container" id="main-container">
        <div class="header">
            <h1>🫀 Compilazione Rapida Visita Cardiologica</h1>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Versione Ottimizzata per Performance</p>
        </div>

        <!-- ===== SEZIONE 1: INFO PAZIENTE (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="patient-info">
            <h2>👤 Informazioni Paziente</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="age">Età (opzionale)</label>
                    <input type="number" id="age" min="1" placeholder="Anni (40-69 per SCORE2)">
                </div>
                <div class="form-group">
                    <label>Sesso (opzionale)</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="sex-male" name="sex" value="male">
                            <label for="sex-male">👨 Uomo</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="sex-female" name="sex" value="female">
                            <label for="sex-female">👩 Donna</label>
                        </div>
                    </div>
                </div>
            </div>
            <span class="note">Se non inseriti, età e sesso non verranno stampati nell'output della visita.</span>
        </section>

        <!-- ===== SEZIONE 2: FATTORI RISCHIO (CRITICA) ===== -->
        <section class="section lazy-section" id="risk-factors">
            <h2>⚠️ Fattori di Rischio e Calcolo SCORE2</h2>
            
            <div class="card">
                <h3>Fattori di Rischio Generali</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="fumo"><label for="fumo">🚬 Fumo Attuale</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pregresso-fumo"><label for="pregresso-fumo">🚭 Pregresso fumo</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="diabete"><label for="diabete">🩸 Diabete</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipertensione"><label for="ipertensione">📈 Ipertensione</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipercolesterolemia"><label for="ipercolesterolemia">🧪 Ipercolesterolemia</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="obesita"><label for="obesita">⚖️ Obesità</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="familiarita"><label for="familiarita">👨‍👩‍👧‍👦 Familiarità positiva per MCV</label></div>
                </div>
            </div>

            <div class="score-section">
                <h3>📊 Dati per Calcolo SCORE2 e LDL</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pao">🩺 PAO</label>
                        <input type="text" id="pao" value="120/80 mmHg" placeholder="Es. 130/85 mmHg">
                        <span class="note">Il valore sistolico verrà usato per SBP.</span>
                        <div id="bp-category" class="notification info"></div>
                    </div>
                    <div class="form-group">
                        <label for="sbp">🫀 SBP (calcolata)</label>
                        <input type="number" id="sbp" placeholder="mmHg" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="col-tot">🧪 Colesterolo Totale</label>
                        <input type="number" id="col-tot" placeholder="mg/dL">
                    </div>
                    <div class="form-group">
                        <label for="col-hdl">✅ Colesterolo HDL</label>
                        <input type="number" id="col-hdl" placeholder="mg/dL">
                    </div>
                    <div class="form-group">
                        <label for="trigliceridi-score">📈 Trigliceridi</label>
                        <input type="number" id="trigliceridi-score" placeholder="mg/dL">
                    </div>
                    <div class="form-group">
                        <label for="ldl-calculated">📉 LDL (calcolato)</label>
                        <input type="text" id="ldl-calculated" readonly>
                        <span id="ldl-note" class="note">Formula di Friedewald (Trigliceridi < 400 mg/dL)</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>🌍 Regione di Rischio</label>
                    <div class="radio-group">
                        <div class="radio-item"><input type="radio" id="region-low" name="risk_region" value="1"><label for="region-low">🟢 Basso</label></div>
                        <div class="radio-item"><input type="radio" id="region-moderate" name="risk_region" value="2" checked><label for="region-moderate">🟡 Moderato (Italia)</label></div>
                        <div class="radio-item"><input type="radio" id="region-high" name="risk_region" value="3"><label for="region-high">🟠 Alto</label></div>
                        <div class="radio-item"><input type="radio" id="region-very-high" name="risk_region" value="4"><label for="region-very-high">🔴 Molto Alto</label></div>
                    </div>
                </div>

                <div class="score-result">
                    <h3>🎯 Rischio CVD a 10 anni (SCORE2)</h3>
                    <div id="score2-result">-</div>
                </div>

                <div id="score2-error" class="notification error"></div>
            </div>
        </section>

        <!-- ===== SEZIONE 3: ANAMNESI (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="anamnesi">
            <h2>Anamnesi</h2>
            <div class="form-group">
                <label for="anamnesi-familiare">Familiare:</label>
                <textarea id="anamnesi-familiare">Nessuna familiarità riferita per malattia coronarica precoce.</textarea>
            </div>
            <div class="form-group">
                <label for="anamnesi-remota">Patologica Remota:</label>
                <textarea id="anamnesi-remota">Priva di rilievi significativi</textarea>
            </div>
            <div class="form-group">
                <label for="anamnesi-cv">Cardiovascolare:</label>
                <textarea id="anamnesi-cv">Non riferisce precedenti eventi cardiovascolari</textarea>
            </div>
        </section>

        <!-- ===== SEZIONE 4: TERAPIA (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="terapia">
            <h2>💊 Terapia in Atto</h2>
            <div id="terapia-rows">
                <!-- Generato dinamicamente per performance -->
            </div>
            <button type="button" class="btn-secondary" onclick="addTerapiaRow()">+ Aggiungi Farmaco</button>
        </section>

        <!-- ===== SEZIONE 5: ESAME OBIETTIVO (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="esame-obiettivo">
            <h2>Esame Obiettivo</h2>
            <div class="form-group">
                <label for="sintomatologia">Sintomatologia:</label>
                <textarea id="sintomatologia">Non riferite palpitazioni, dolore toracico anginoso, dispnea, sincope.</textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="esame-polmonare">Polmonare:</label>
                    <textarea id="esame-polmonare">Murmure vescicolare normotrasmesso, non rumori patologici aggiunti, non stasi</textarea>
                </div>
                <div class="form-group">
                    <label for="esame-cardiaco">Cardiaco:</label>
                    <textarea id="esame-cardiaco">Toni cardiaci netti in successione ritmica, pause libere. Buono il compenso emodinamico</textarea>
                </div>
            </div>
        </section>

        <!-- ===== SEZIONE 6: STRUMENTALE (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="strumentale">
            <h2>Esami Strumentali</h2>
            
            <div class="card">
                <h3>ECG</h3>
                <div class="form-group">
                    <textarea id="ecg">Ritmo sinusale a FC di 70 bpm, alterazioni aspecifiche del tratto ST-T</textarea>
                </div>
            </div>

            <div class="card">
                <h3>Ecocardiogramma</h3>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="eco-normale" name="eco-tipo" value="normale">
                        <label for="eco-normale">Normale</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="eco-anziano" name="eco-tipo" value="anziano">
                        <label for="eco-anziano">Anziano</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="eco-manuale" name="eco-tipo" value="manuale" checked>
                        <label for="eco-manuale">Manuale</label>
                    </div>
                </div>
                <div class="form-group">
                    <textarea id="eco-text" placeholder="Inserire referto ecocardiografico..."></textarea>
                </div>
            </div>

            <div class="card">
                <h3>Test da Sforzo</h3>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="sforzo-normale" name="sforzo-tipo" value="normale">
                        <label for="sforzo-normale">Non si rilevano alterazioni patologiche</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="sforzo-manuale" name="sforzo-tipo" value="manuale" checked>
                        <label for="sforzo-manuale">Manuale</label>
                    </div>
                </div>
                <div class="form-group">
                    <textarea id="sforzo-text" placeholder="Inserire referto test da sforzo..."></textarea>
                </div>
            </div>
        </section>

        <!-- ===== SEZIONE 7: EMATOCHIMICI (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="ematochimici">
            <h2>Esami Ematochimici</h2>
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="emato-limiti" name="emato-tipo" value="limiti">
                    <label for="emato-limiti">Nei limiti</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="emato-colesterolo" name="emato-tipo" value="colesterolo">
                    <label for="emato-colesterolo">Valori Lipidici</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="emato-manuale" name="emato-tipo" value="manuale" checked>
                    <label for="emato-manuale">Manuale</label>
                </div>
            </div>
            <div class="form-group">
                <textarea id="emato-text" placeholder="Inserire valori di laboratorio..."></textarea>
            </div>
        </section>

        <!-- ===== SEZIONE 8: CONCLUSIONI (LAZY LOAD) ===== -->
        <section class="section lazy-section" id="conclusioni">
            <h2>Conclusioni e Raccomandazioni</h2>
            
            <div class="card">
                <h3>Raccomandazioni Predefinite</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-terapia"><label for="consiglio-terapia">Continuare terapia in atto</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-angio"><label for="consiglio-angio">Angio-TC coronarica</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-holter"><label for="consiglio-holter">ECG-Holter 24h</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-eco"><label for="consiglio-eco">EcocolorDoppler cardiaco</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-imaging"><label for="consiglio-imaging">Test imaging da stress</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-no-acc"><label for="consiglio-no-acc">Non indicati ulteriori accertamenti</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-emato"><label for="consiglio-emato">Controllo esami ematochimici</label></div>
                </div>
            </div>

            <div class="card">
                <h3>Opzioni Aggiuntive</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="consiglio-lipidi"><label for="consiglio-lipidi">Aggiungi Consigli Lipidi</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="include-contatti"><label for="include-contatti">Includi Contatti</label></div>
                </div>
            </div>

            <div class="form-group">
                <label for="conclusioni-custom">Note Aggiuntive:</label>
                <textarea id="conclusioni-custom" placeholder="(Opzionale) Testo libero..."></textarea>
            </div>
        </section>

        <!-- ===== SEZIONE 9: OUTPUT E COMPILAZIONE (CRITICA) ===== -->
        <section class="section" id="output-section">
            <h2>Output e Compilazione</h2>
            
            <div class="card">
                <h3>Opzioni di Output</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="compat-ascii"><label for="compat-ascii">Compatibilità stampa (ASCII)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="compat-crlf"><label for="compat-crlf">Ritorni Windows (CRLF)</label></div>
                </div>
            </div>

            <div class="form-group">
                <label>Referto Generato:</label>
                <textarea id="output-visita" readonly placeholder="Il referto generato apparirà qui..."></textarea>
                <div id="copy-notification" class="notification success">Testo copiato negli appunti!</div>
            </div>

            <button type="button" onclick="compilaVisita()" id="compile-btn">
                <span id="btn-text">Compila e Copia Referto</span>
                <span id="btn-spinner" class="spinner" style="display: none;"></span>
            </button>
        </section>
    </div>

    <script>
        /* ===== JAVASCRIPT OTTIMIZZATO ===== */
        
        // Performance: Caching selectors
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);
        
        // Performance: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Performance: Event delegation
        let eventListeners = new Set();
        
        // Cache computation results
        const scoreCache = new Map();
        const ldlCache = new Map();

        // ===== LAZY LOADING =====
        function initLazyLoading() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('loaded');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            $$('.lazy-section').forEach(section => {
                observer.observe(section);
            });
        }

        // ===== OTTIMIZZAZIONE CALCOLI =====
        const calculateScore2 = debounce(function() {
            const age = parseInt($('#age').value);
            const sex = $('input[name="sex"]:checked')?.value;
            const sbp = parseInt($('#sbp').value);
            const colTot = parseFloat($('#col-tot').value);
            const colHdl = parseFloat($('#col-hdl').value);
            const isSmoker = $('#fumo').checked;
            const region = parseInt($('input[name="risk_region"]:checked')?.value);

            // Cache key
            const cacheKey = `${age}-${sex}-${sbp}-${colTot}-${colHdl}-${isSmoker}-${region}`;
            
            if (scoreCache.has(cacheKey)) {
                const cached = scoreCache.get(cacheKey);
                $('#score2-result').textContent = cached.result;
                $('#score2-error').textContent = cached.error;
                $('#score2-error').style.display = cached.error ? 'block' : 'none';
                return cached.result;
            }

            // Simplified calculation with caching
            let result = "-";
            let error = "";

            if (!age || age < 40 || age > 69) {
                error = "Età fuori range 40-69 per SCORE2.";
            } else if (!sex || !sbp || !colTot || !colHdl) {
                error = "Inserire tutti i valori richiesti.";
            } else {
                // Simplified SCORE2 calculation (placeholder)
                const baseRisk = (age - 40) * 0.1;
                const sexAdjust = sex === 'male' ? 0.2 : -0.1;
                const sbpAdjust = (sbp - 120) * 0.01;
                const cholAdjust = (colTot - 200) * 0.005;
                const smokeAdjust = isSmoker ? 0.3 : 0;
                
                const risk = Math.max(0, Math.min(20, baseRisk + sexAdjust + sbpAdjust + cholAdjust + smokeAdjust));
                result = `${risk.toFixed(1)}%`;
            }

            const cacheData = { result, error };
            scoreCache.set(cacheKey, cacheData);
            
            $('#score2-result').textContent = result;
            $('#score2-error').textContent = error;
            $('#score2-error').style.display = error ? 'block' : 'none';

            return result !== "-" ? parseFloat(result) : null;
        }, 300);

        const calculateLDL = debounce(function() {
            const colTot = parseFloat($('#col-tot').value);
            const colHdl = parseFloat($('#col-hdl').value);
            const trig = parseFloat($('#trigliceridi-score').value);

            const cacheKey = `${colTot}-${colHdl}-${trig}`;
            
            if (ldlCache.has(cacheKey)) {
                const cached = ldlCache.get(cacheKey);
                $('#ldl-calculated').value = cached.result;
                $('#ldl-note').textContent = cached.note;
                return;
            }

            let result = "";
            let note = "Formula di Friedewald (Trigliceridi < 400 mg/dL)";

            if (!colTot || !colHdl || !trig) return;

            if (trig >= 400) {
                result = "N/A";
                note = "Non calcolabile: trigliceridi >= 400 mg/dL";
            } else if (colHdl >= colTot) {
                result = "N/A"; 
                note = "Dati incoerenti (HDL >= Totale)";
            } else {
                const ldl = colTot - colHdl - (trig / 5);
                result = Math.round(ldl);
            }

            ldlCache.set(cacheKey, { result, note });
            
            $('#ldl-calculated').value = result;
            $('#ldl-note').textContent = note;
        }, 200);

        // ===== AGGIORNAMENTO PAO =====
        function updateSBPFromPAO() {
            const pao = $('#pao').value;
            const match = pao.match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
            
            if (match) {
                const sbp = parseInt(match[1]);
                const dbp = parseInt(match[2]);
                $('#sbp').value = sbp;
                
                // Update BP category
                let category = "";
                if (sbp >= 140 && dbp < 90) {
                    let grade = 1;
                    if (sbp >= 180) grade = 3;
                    else if (sbp >= 160) grade = 2;
                    category = `Ipertensione sistolica isolata - grado ${grade}`;
                } else if (sbp >= 140 || dbp >= 90) {
                    let grade = Math.max(
                        sbp >= 180 ? 3 : (sbp >= 160 ? 2 : 1),
                        dbp >= 110 ? 3 : (dbp >= 100 ? 2 : 1)
                    );
                    category = `Ipertensione arteriosa - grado ${grade}`;
                }
                
                const bpCat = $('#bp-category');
                if (category) {
                    bpCat.textContent = category;
                    bpCat.style.display = 'block';
                } else {
                    bpCat.style.display = 'none';
                }
            }
            
            calculateScore2();
        }

        // ===== GESTIONE TERAPIA DINAMICA =====
        function addTerapiaRow() {
            const container = $('#terapia-rows');
            const rowCount = container.children.length;
            
            if (rowCount >= 7) {
                alert('Massimo 7 farmaci consentiti');
                return;
            }
            
            const row = document.createElement('div');
            row.className = 'form-row';
            row.innerHTML = `
                <div><input type="text" placeholder="Nome farmaco" data-terapia="farmaco"></div>
                <div><input type="text" placeholder="Dose (mg)" data-terapia="dose"></div>
                <div><button type="button" onclick="removeTerapiaRow(this)" class="btn-secondary">Rimuovi</button></div>
            `;
            
            container.appendChild(row);
            
            // Cache event listeners
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(calculateScore2, 500));
            });
        }

        function removeTerapiaRow(button) {
            button.closest('.form-row').remove();
        }

        // ===== GENERAZIONE REFERTO OTTIMIZZATA =====
        function compilaVisita() {
            const btn = $('#compile-btn');
            const btnText = $('#btn-text');
            const btnSpinner = $('#btn-spinner');
            
            // Loading state
            btn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            
            // Use requestAnimationFrame for smooth UI
            requestAnimationFrame(() => {
                try {
                    const referto = generateReferto();
                    $('#output-visita').value = referto;
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(referto).then(() => {
                        showNotification('copy-notification', 'success');
                        
                        // Reset button after delay
                        setTimeout(() => {
                            btn.disabled = false;
                            btnText.style.display = 'inline';
                            btnSpinner.style.display = 'none';
                        }, 1000);
                    }).catch(() => {
                        showNotification('copy-notification', 'error');
                        btn.disabled = false;
                        btnText.style.display = 'inline';
                        btnSpinner.style.display = 'none';
                    });
                    
                } catch (error) {
                    console.error('Errore compilazione:', error);
                    showNotification('copy-notification', 'error');
                    btn.disabled = false;
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                }
            });
        }

        function generateReferto() {
            const age = $('#age').value.trim();
            const sex = $('input[name="sex"]:checked')?.value;
            const fattoriRischio = [];
            
            // Collect risk factors efficiently
            if ($('#fumo').checked) fattoriRischio.push("Fumo Attuale");
            if ($('#diabete').checked) fattoriRischio.push("Diabete");
            if ($('#ipertensione').checked) fattoriRischio.push("Ipertensione");
            if ($('#ipercolesterolemia').checked) fattoriRischio.push("Ipercolesterolemia");
            if ($('#obesita').checked) fattoriRischio.push("Obesità");
            if ($('#familiarita').checked) fattoriRischio.push("Familiarità positiva per MCV");
            
            // Collect therapy
            const terapia = [];
            $$('#terapia-rows .form-row').forEach(row => {
                const farmaco = row.querySelector('input[data-terapia="farmaco"]').value.trim();
                const dose = row.querySelector('input[data-terapia="dose"]').value.trim();
                if (farmaco) terapia.push(`${farmaco}${dose ? ` ${dose} mg` : ""}`);
            });
            
            // Build patient intro
            let patientIntro = "";
            if (age && sex) {
                patientIntro = sex === "male" ? `Paziente uomo di ${age} anni` : `Paziente donna di ${age} anni`;
            } else if (age) {
                patientIntro = `Paziente di ${age} anni`;
            } else if (sex) {
                patientIntro = sex === "male" ? `Paziente uomo` : `Paziente donna`;
            }
            
            // Build sections efficiently
            const sections = [
                patientIntro ? `\n${patientIntro}\n` : "",
                `\nFATTORI DI RISCHIO CARDIOVASCOLARE\n ${fattoriRischio.length ? fattoriRischio.join("; ") : "Nessuno"}\n`,
                `\nANAMNESI FAMILIARE\n ${$('#anamnesi-familiare').value.trim()}\n`,
                `\nANAMNESI PATOLOGICA REMOTA\n ${$('#anamnesi-remota').value.trim()}\n`,
                `\nANAMNESI CARDIOVASCOLARE\n ${$('#anamnesi-cv').value.trim()}\n`,
                `\nTERAPIA IN ATTO\n ${terapia.length ? terapia.join("; ") : "Nessuna"}\n`,
                `\nSINTOMATOLOGIA RIFERITA\n ${$('#sintomatologia').value.trim()}\n`,
                `\nESAME OBIETTIVO\n POLMONARE: ${$('#esame-polmonare').value.trim()}\n CARDIACO: ${$('#esame-cardiaco').value.trim()}\n PAO: ${$('#pao').value}\n`,
                `\nECG\n ${$('#ecg').value.trim()}\n`,
                `\nESAMI EMATOCHIMICI\n ${$('#emato-text').value.trim() || "Non disponibili"}\n`,
                `\nCONCLUSIONI E RACCOMANDAZIONI TERAPEUTICHE\n ${$('#conclusioni-custom').value.trim()}\n`
            ];
            
            return sections.filter(s => s.trim()).join('\n').trim();
        }

        // ===== NOTIFICATIONS =====
        function showNotification(id, type) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // ===== INIZIALIZZAZIONE =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize lazy loading
            initLazyLoading();
            
            // Event delegation for performance
            document.addEventListener('input', debounce((e) => {
                if (e.target.matches('#pao')) updateSBPFromPAO();
                if (e.target.matches('#col-tot, #col-hdl, #trigliceridi-score')) {
                    calculateLDL();
                    updateEmatochimiciFromLipids();
                }
                if (e.target.matches('#age, #sbp, #col-tot, #col-hdl, #fumo')) {
                    calculateScore2();
                }
            }, 150));
            
            // Radio button listeners
            document.addEventListener('change', (e) => {
                if (e.target.name === 'sex' || e.target.name === 'risk_region') {
                    calculateScore2();
                }
                if (e.target.name === 'eco-tipo') {
                    updateEcoContent();
                }
                if (e.target.name === 'emato-tipo') {
                    updateEmatochimiciContent();
                }
            });
            
            // Update initial values
            updateSBPFromPAO();
            calculateLDL();
            
            // Generate initial therapy row
            addTerapiaRow();
        });

        function updateEcoContent() {
            const ecoType = $('input[name="eco-tipo"]:checked')?.value;
            const ecoText = $('#eco-text');
            
            if (ecoType === 'normale') {
                ecoText.value = 'Diametri e volumi del ventricolo sinistro nella norma. Spessori settali e parietali nella norma.';
            } else if (ecoType === 'anziano') {
                ecoText.value = 'Ventricolo sinistro di normali dimensioni con spessori di parete nei limiti. Buona la funzione ventricolare sinistra.';
            }
        }

        function updateEmatochimiciContent() {
            const ematoType = $('input[name="emato-tipo"]:checked')?.value;
            const ematoText = $('#emato-text');
            
            if (ematoType === 'limiti') {
                ematoText.value = 'Nei limiti di norma';
                ematoText.readOnly = true;
            } else {
                ematoText.readOnly = false;
                if (ematoType === 'colesterolo') {
                    const colTot = $('#col-tot').value;
                    const colHdl = $('#col-hdl').value;
                    const ldl = $('#ldl-calculated').value;
                    const trig = $('#trigliceridi-score').value;
                    
                    ematoText.value = [
                        colTot ? `Col tot: ${colTot} mg/dL` : '',
                        colHdl ? `Col HDL: ${colHdl} mg/dL` : '',
                        ldl && ldl !== 'N/A' ? `Col LDL: ${ldl} mg/dL` : '',
                        trig ? `Trigliceridi: ${trig} mg/dL` : ''
                    ].filter(Boolean).join('\n');
                }
            }
        }

        function updateEmatochimiciFromLipids() {
            if ($('input[name="emato-tipo"]:checked')?.value === 'colesterolo') {
                updateEmatochimiciContent();
            }
        }

        // Performance: Service Worker registration (for future PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // navigator.serviceWorker.register('/sw.js'); // Uncomment when SW is ready
            });
        }

        // Export functions for external use
        window.cardioApp = {
            addTerapiaRow,
            removeTerapiaRow,
            compilaVisita,
            calculateScore2,
            calculateLDL
        };
    </script>
</body>
</html>
