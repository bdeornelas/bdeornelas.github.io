<!DOCTYPE html>
<html lang="it">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilazione Visita Cardiologica (API)</title>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-gray: #f4f4f4;
            --border-color: #dee2e6;
            --text-color: #333;
            --text-muted: #6c757d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0;
            background-color: #fff;
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .section {
            margin: 0;
            border: none;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
            transition: all 0.3s ease;
        }

        .section:last-child { border-bottom: none; }

        .section:hover { background-color: #fafbfc; transform: translateY(-1px); }

        h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.4em;
            font-weight: 600;
            margin: 0 0 20px 0;
            padding: 0 0 10px 0;
            border-bottom: 3px solid var(--accent-color);
            position: relative;
        }
        h2::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--success-color);
        }

        h3 { color: var(--accent-color); font-size: 1.2em; margin: 20px 0 15px 0; font-weight: 500; }

        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 0.95em; }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); transform: translateY(-1px);
        }
        input[readonly] { background-color: #e9ecef !important; cursor: not-allowed; }

        textarea { resize: vertical; font-family: inherit; min-height: 80px; }

        .form-group { margin-bottom: 20px; }

        .form-row { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; }
        .form-row>div { flex: 1; min-width: 200px; }

        input[type="checkbox"], input[type="radio"] { margin-right: 8px; transform: scale(1.2); accent-color: var(--accent-color); }

        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 15px 25px; margin: 15px 0; }

        .checkbox-item, .radio-item { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s ease; }
        .checkbox-item:hover, .radio-item:hover { background-color: rgba(0, 123, 255, 0.05); }

        .label-inline { margin: 0; font-weight: 500; cursor: pointer; user-select: none; }

        .checkbox-notification {
            display: none; font-size: 0.85em; font-weight: 600; margin-left: 8px;
            padding: 2px 8px; border-radius: 12px; color: white;
        }
        .checkbox-notification.success { background-color: var(--success-color); }
        .checkbox-notification.info { background-color: var(--info-color); }
        .checkbox-notification.warning { background-color: var(--warning-color); color: var(--text-color); }
        .checkbox-notification.contact { background-color: var(--info-color); }

        .terapia-row { display: flex; align-items: flex-end; gap: 15px; margin-bottom: 15px; }
        .terapia-row>div:first-child { flex: 2; }
        .terapia-row>div:last-child { flex: 1; }
        .terapia-row input { margin-bottom: 0; }

        .score-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px; padding: 20px; margin: 20px 0; border: 2px solid var(--border-color);
        }
        .score-result { background: white; padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0; border: 2px solid var(--danger-color); }

        button.main-action {
            width: 100%; padding: 16px 24px; font-size: 1.1em; font-weight: 600; cursor: pointer;
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white; border: none; border-radius: 10px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: var(--shadow);
        }
        button.main-action:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3); background: linear-gradient(135deg, #218838 0%, #1e7e34 100%); }
        button.main-action:active { transform: translateY(0); }

        .copy-notification {
            display: none; color: var(--success-color); margin-top: 15px; font-weight: 600; text-align: center;
            padding: 10px; background-color: rgba(40, 167, 69, 0.1); border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);
        }

        #score2-result-display {
            font-weight: bold; color: var(--danger-color); font-size: 1.3em;
            padding: 5px 10px; background-color: rgba(220, 53, 69, 0.1); border-radius: 6px; display: inline-block;
        }

        .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 8px; padding: 10px; background-color: rgba(220, 53, 69, 0.1); border-radius: 6px; border-left: 4px solid var(--danger-color); }

        .info-message { color: var(--info-color); background-color: rgba(23, 162, 184, 0.1); border-left: 4px solid var(--info-color); padding: 10px; border-radius: 6px; margin: 10px 0; }

        #output-visita {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-radius: 8px;
            padding: 20px;
        }

        /* Sezione Revisione AI */
        .ai-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 10px 0 15px 0; }
        .ai-input { max-width: 480px; }
        #ai-status { display: none; }
        #ai-italiano, #ai-errori { width: 100%; min-height: 380px; resize: vertical; }
        .btn { display:inline-block; padding:10px 14px; border:2px solid var(--border-color); border-radius:8px; background:#fff; color:var(--text-color); font-weight:600; cursor:pointer; transition:all 0.2s ease; }
        .btn:hover { background-color:#fafbfc; transform:translateY(-1px); }
        .btn:active { transform:translateY(0); }

        /* Sezione Revisione AI */
        .ai-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 10px 0 15px 0; }
        .ai-input { max-width: 420px; }
        #ai-status { display: none; }
        #ai-italiano, #ai-errori { min-height: 160px; }

        .note { font-size: 0.85em; color: var(--text-muted); display: block; margin-top: -10px; margin-bottom: 10px; font-style: italic; }

        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 8px; }
            .section { padding: 20px; }
            .form-row { flex-direction: column; gap: 0; }
            .checkbox-group, .radio-group { flex-direction: column; gap: 10px; }
            .terapia-row { flex-direction: column; gap: 0; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.2em; }
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .options-row { display:flex; gap:20px; align-items:center; flex-wrap:wrap; }
    </style>
    <script>
        let aggiungereConsigliLipidi = false;

        const consigliLipidiText = `Profilo lipidico non ottimale.
Per favorire la riduzione del colesterolo LDL (valori desiderati < 116 mg/dL), Ã¨ consigliabile seguire alcune semplici indicazioni nutrizionali:

Alimenti da Privilegiare nella Dieta Quotidiana:
* Verdura: Consumare porzioni abbondanti ad ogni pasto, variando i tipi e i colori. Sia fresca che surgelata al naturale sono valide scelte.
* Frutta: Includere regolarmente frutta fresca di stagione, importante fonte di vitamine, minerali e fibre.
* Cereali Integrali: Preferire sistematicamente le versioni integrali di pane, pasta, riso. Includere anche avena, orzo, farro per massimizzare l'apporto di fibre benefiche.
* Legumi: Inserire frequentemente lenticchie, ceci, fagioli, piselli. Sono un'ottima fonte di proteine vegetali e fibre che aiutano a controllare il colesterolo.
* Pesce: Consumare pesce 2-3 volte a settimana, privilegiando varietÃ  ricche di Omega-3 (come salmone, sgombro, sardine, acciughe).
* Frutta Secca e Semi Oleosi: Una piccola quantitÃ  giornaliera (es. 30g) di noci, mandorle, nocciole o semi (lino, chia, zucca) apporta grassi sani e fibre (attenzione alle calorie).
* Grassi Sani: Utilizzare Olio Extravergine d'Oliva come condimento principale, preferibilmente a crudo. Altri oli vegetali (es. canola) possono essere usati con moderazione per cucinare. Avocado e olive sono altre buone fonti.
* Fonti Proteiche Magre: Alternare il pesce con pollame senza pelle (pollo, tacchino) e le giÃ  citate proteine vegetali (legumi).
* Latticini (con Moderazione): Se consumati, scegliere versioni a basso contenuto di grassi come yogurt bianco naturale non zuccherato o latte parzialmente scremato.
* Bevande: L'acqua Ã¨ la bevanda principale. TÃ¨ verde e tisane non zuccherate sono valide alternative.

Alimenti da Limitare Significativamente o Evitare:
* Grassi Saturi: Ridurre il consumo di burro, panna, strutto, formaggi grassi e stagionati, oli tropicali (palma, cocco).
* Grassi Trans: Evitare prodotti contenenti "grassi (parzialmente) idrogenati" (controllare attentamente le etichette di prodotti da forno industriali, snack, margarine).
* Carni Rosse: Limitarne il consumo (manzo, maiale) a non piÃ¹ di 1-2 volte a settimana.
* Carni Lavorate: Evitare o consumare solo eccezionalmente insaccati, salumi, wurstel, bacon.
* Alimenti Ultra-Processati: Ridurre al minimo cibi pronti, snack confezionati, patatine, merendine, fast food. Sono spesso ricchi di grassi non sani, zuccheri aggiunti e sale.
* Zuccheri Aggiunti: Limitarne fortemente dolci, dessert, biscotti. Eliminare bevande zuccherate (bibite gassate, succhi di frutta industriali, tÃ¨ freddi zuccherati). Preferire sempre il frutto intero ai succhi, anche se 100% frutta.
* Cibi Fritti: Evitare la frittura come metodo di cottura abituale.
* Alcol: Limitarne fortemente il consumo o, preferibilmente, evitarlo.

Consigli Pratici Quotidiani:
* Metodi di Cottura: Privilegiare cotture semplici (vapore, griglia, forno, bollitura) che richiedono pochi grassi aggiunti.
* Apporto di Fibre: Assicurare un adeguato consumo di fibre attraverso verdura, frutta, legumi e cereali integrali in ogni pasto.
* Leggere le Etichette: Prendere l'abitudine di controllare le informazioni nutrizionali, in particolare il contenuto di grassi saturi, zuccheri e sodio (sale).
* Controllo delle Porzioni: Prestare attenzione alle quantitÃ  consumate, anche per gli alimenti sani.
* Stile di Vita Completo: Ricordare che la dieta Ã¨ piÃ¹ efficace se inserita in uno stile di vita che comprende attivitÃ  fisica regolare e il mantenimento di un peso corporeo sano.`;

        function formatText(text, indent, trim = true) {
            if (!text) return "";
            const cleanedText = trim ? text.trim() : text;
            if (!cleanedText) return "";
            return cleanedText
                .split('\n')
                .map(line => line.trim() ? `${indent}${line.trim()}` : '')
                .filter(line => line)
                .join('\n');
        }

        function formatSection(title, content, indent, separator) {
            if (!content || !content.trim()) return "";
            if (!title) return `${content}\n${separator}`;
            return `${title}\n${content}\n${separator}`;
        }

        // --- Sanitizzazione per stampa ---
        function removeEmojis(str) {
            // Rimuove la maggior parte degli emoji/simboli piktografici
            return str.replace(/[\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{27BF}]/gu, '');
        }
        function toLatin1Safe(str) {
            // Sostituzioni tipografiche "sicure"
            const map = {
                'â':'"', 'â':'"', 'â':'"', 'Â«':'"', 'Â»':'"',
                'â':"'", 'â':"'", 'â':"'", 'Â´':"'", 'Â¸':',',
                'â':'-', 'â':'-', '-':'-', 'â':'-', 'â¢':'-',
                'â¦':'...', 'â':'->', 'â':'<-', 'â':'<->',
                'Ã':'x', 'Ã·':'/', 'Â°':' deg ', 'Âº':' deg ', 'Âª':'a',
                'â¥':'>=', 'â¤':'<=', 'Â±':'+/-', '-':'-',
                '\u00A0':' ' // NBSP
            };
            return removeEmojis(str).replace(/["âââÂ«Â»âââÂ´Â¸ââ-ââ¢â¦âââÃÃ·Â°ÂºÂªâ¥â¤Â±\u00A0]/g, ch => map[ch] || ch);
        }
        function stripAccents(str) {
            // Rimuove i segni diacritici (accenti) dopo normalizzazione
            return str.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
        }
        function sanitizeForPrint(text, mode) {
            let t = toLatin1Safe(text);
            if (mode === 'ascii') {
                t = stripAccents(t);
                // Elimina qualunque carattere non-ASCII rimasto
                t = t.replace(/[^\x00-\x7F]/g, '');
            }
            return t;
        }
        function normalizeLineEndings(text, useCRLF) {
            const t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            return useCRLF ? t.replace(/\n/g, '\r\n') : t;
        }
        // --- Fine sanitizzazione ---
        
        function calculateAndDisplayLdl() {
            const colTotInput = document.getElementById("col-tot");
            const colHdlInput = document.getElementById("col-hdl");
            const trigliceridiInput = document.getElementById("trigliceridi-score");
            const ldlResultInput = document.getElementById("ldl-calculated");
            const ldlNote = document.getElementById("ldl-calculation-note");

            const colTot = parseFloat(colTotInput.value);
            const hdl = parseFloat(colHdlInput.value);
            const trig = parseFloat(trigliceridiInput.value);

            ldlResultInput.value = "";
            ldlNote.textContent = "Calcolato con formula di Friedewald (valido per Trigliceridi < 400 mg/dL).";
            ldlNote.style.color = "var(--text-muted)";

            if (!colTot || !hdl || !trig || colTot <= 0 || hdl <= 0 || trig <= 0) return;

            if (trig >= 400) {
                ldlResultInput.value = "N/A";
                ldlNote.textContent = "Non calcolabile: i trigliceridi devono essere < 400 mg/dL.";
                ldlNote.style.color = "var(--danger-color)";
                return;
            }

            if ((hdl + (trig / 5)) >= colTot) {
                ldlResultInput.value = "N/A";
                ldlNote.textContent = "Dati incoerenti (Totale <= HDL + VLDL).";
                ldlNote.style.color = "var(--danger-color)";
                return;
            }

            const ldl = colTot - hdl - (trig / 5);
            ldlResultInput.value = ldl.toFixed(0);
        }

        function calculateScore2() {
            const ageInput = document.getElementById("age");
            const sexRadio = document.querySelector('input[name="sex"]:checked');
            const sbpInput = document.getElementById("sbp");
            const colTotInput = document.getElementById("col-tot");
            const colHdlInput = document.getElementById("col-hdl");
            const smokerCheckbox = document.getElementById("fumo");
            const regionRadio = document.querySelector('input[name="risk_region"]:checked');
            const resultDisplay = document.getElementById("score2-result-display");
            const errorDisplay = document.getElementById("score2-error");
            resultDisplay.textContent = "-";
            errorDisplay.textContent = "";
            const age = parseInt(ageInput.value, 10);
            if (isNaN(age) || age < 40 || age > 69) {
                errorDisplay.textContent = "EtÃ  non valida o fuori range (SCORE2 Ã¨ per 40-69 anni).";
                return null;
            }
            if (!sexRadio) { errorDisplay.textContent = "Selezionare il sesso."; return null; }
            const sex = sexRadio.value;
            const sbp = parseInt(sbpInput.value, 10);
            if (isNaN(sbp)) { errorDisplay.textContent = "Inserire SBP valida (es. dal campo PAO)."; return null; }
            if (sbp < 100 || sbp > 200) {
                if (!errorDisplay.textContent) errorDisplay.textContent = "Warning: SBP inserita fuori range suggerito (100-200 mmHg).";
            }
            if (sbp <= 0) { errorDisplay.textContent = "Inserire SBP valida (positiva)."; return null; }
            const colTotMgDl = parseFloat(colTotInput.value);
            const colHdlMgDl = parseFloat(colHdlInput.value);
            if (isNaN(colTotMgDl) || colTotMgDl <= 0 || isNaN(colHdlMgDl) || colHdlMgDl <= 0) {
                errorDisplay.textContent = "Inserire valori validi (mg/dL, positivi) per Colesterolo Totale e HDL.";
                return null;
            }
            if (colHdlMgDl >= colTotMgDl) { errorDisplay.textContent = "Colesterolo HDL deve essere minore del Totale."; return null; }
            const isSmoker = smokerCheckbox.checked;
            if (!regionRadio) { errorDisplay.textContent = "Selezionare la regione di rischio."; return null; }
            const region = parseInt(regionRadio.value, 10);
            const conversionFactor = 38.67;
            const coeffs = {
                male: { cage: 0.3742, smoking: 0.6012, csbp: 0.2777, ctchol: 0.1458, chdl: -0.2698, smoking_cage: -0.0755, csbp_cage: -0.0255, ctchol_cage: -0.0281, chdl_cage: 0.0426 },
                female: { cage: 0.4648, smoking: 0.7744, csbp: 0.3131, ctchol: 0.1002, chdl: -0.2606, smoking_cage: -0.1088, csbp_cage: -0.0277, ctchol_cage: -0.0226, chdl_cage: 0.0613 }
            };
            const baseline_survival = { male: 0.9605, female: 0.9776 };
            const calibration_scales = {
                male: { 1: { scale1: -0.5699, scale2: 0.7476 }, 2: { scale1: -0.1565, scale2: 0.8009 }, 3: { scale1: 0.3207, scale2: 0.9360 }, 4: { scale1: 0.5836, scale2: 0.8294 } },
                female: { 1: { scale1: -0.7380, scale2: 0.7019 }, 2: { scale1: -0.3143, scale2: 0.7701 }, 3: { scale1: 0.5710, scale2: 0.9369 }, 4: { scale1: 0.9412, scale2: 0.8329 } }
            };
            const colTotMmolL = colTotMgDl / conversionFactor;
            const colHdlMmolL = colHdlMgDl / conversionFactor;
            const nonHdlMmolL = colTotMmolL - colHdlMmolL;
            if (nonHdlMmolL < 3.0 || nonHdlMmolL > 6.9) {
                if (!errorDisplay.textContent) errorDisplay.textContent = `Warning: Colesterolo non-HDL (${(nonHdlMmolL * conversionFactor).toFixed(0)} mg/dL) fuori range SCORE2 (115-266 mg/dL).`;
            }
            const cage = (age - 60) / 5;
            const smoking_val = isSmoker ? 1 : 0;
            const csbp = (sbp - 120) / 20;
            const ctchol = colTotMmolL - 6;
            const chdl = (colHdlMmolL - 1.3) / 0.5;
            const cf = coeffs[sex];
            let x = cf.cage * cage + cf.smoking * smoking_val + cf.csbp * csbp + cf.ctchol * ctchol + cf.chdl * chdl
                + cf.smoking_cage * smoking_val * cage + cf.csbp_cage * csbp * cage + cf.ctchol_cage * ctchol * cage + cf.chdl_cage * chdl * cage;
            const s0 = baseline_survival[sex];
            let uncalibrated_risk = 1 - Math.pow(s0, Math.exp(x));
            const epsilon = 1e-10;
            uncalibrated_risk = Math.max(epsilon, Math.min(1 - epsilon, uncalibrated_risk));
            const cal = calibration_scales[sex][region];
            if (!cal) { errorDisplay.textContent = "Scale di calibrazione non trovate."; return null; }
            let calibrated_risk_percent;
            try {
                const inner_log = -Math.log(1 - uncalibrated_risk);
                if (inner_log <= 0 || !isFinite(inner_log)) throw new Error("Intermediate log error.");
                const log_inner_log = Math.log(inner_log);
                if (!isFinite(log_inner_log)) throw new Error("Final log error.");
                const calibrated_risk = 1 - Math.exp(-Math.exp(cal.scale1 + cal.scale2 * log_inner_log));
                calibrated_risk_percent = (calibrated_risk * 100).toFixed(1);
            } catch (e) {
                calibrated_risk_percent = uncalibrated_risk < 0.5 ? "0.0" : ">99.9";
                if (!errorDisplay.textContent) errorDisplay.textContent = "Rischio estremo, calcolo al limite.";
                resultDisplay.textContent = `${calibrated_risk_percent}%`;
                return calibrated_risk_percent === ">99.9" ? 99.9 : (calibrated_risk_percent === "0.0" ? 0.0 : null);
            }
            resultDisplay.textContent = `${calibrated_risk_percent}%`;
            return parseFloat(calibrated_risk_percent);
        }

        // === Parsing PAO e commento SOLO per ipertensione (grado 1â3 o ISH) ===
        function parseBPString(paoStr) {
            if (!paoStr) return { sbp: NaN, dbp: NaN };
            const cleaned = String(paoStr).replace(/[^\d\/\-\â\â\s]/g, '').trim();
            let parts = cleaned.split(/[\/\-\â\â]/).map(s => s.trim()).filter(Boolean);
            if (parts.length < 2) {
                const nums = cleaned.match(/\d+/g);
                if (nums && nums.length >= 2) parts = [nums[0], nums[1]];
            }
            const sbp = parts[0] ? parseInt(parts[0], 10) : NaN;
            const dbp = parts[1] ? parseInt(parts[1], 10) : NaN;
            return { sbp, dbp };
        }
        function classifyOfficeBP(sbp, dbp) {
            if (isNaN(sbp) || isNaN(dbp)) return null;
            if (sbp >= 140 && dbp < 90) {
                let grade = 1;
                if (sbp >= 180) grade = 3;
                else if (sbp >= 160) grade = 2;
                return "Ipertensione sistolica isolata - grado " + grade;
            }
            if (sbp >= 140 || dbp >= 90) {
                const gradeFromSBP = sbp >= 180 ? 3 : (sbp >= 160 ? 2 : 1);
                const gradeFromDBP = dbp >= 110 ? 3 : (dbp >= 100 ? 2 : (dbp >= 90 ? 1 : 0));
                const grade = Math.max(gradeFromSBP, gradeFromDBP);
                return "Ipertensione arteriosa - grado " + grade;
            }
            return null;
        }
        // === END ===

        function compilaVisita() {
            const indent = " ";
            const sectionSeparator = "\n\n";
            const ageInput = document.getElementById("age");
            const age = ageInput.value.trim();
            const ageNum = age ? parseInt(age, 10) : NaN;
            const sexRadioChecked = document.querySelector('input[name="sex"]:checked');
            const sexValue = sexRadioChecked ? sexRadioChecked.value : null;

            // Costruisci la riga introduttiva solo se etÃ  o sesso sono presenti
            let patientIntroLine = "";
            if (age && sexValue) {
                patientIntroLine = (sexValue === "male") ? `Paziente uomo di ${age} anni` : `Paziente donna di ${age} anni`;
            } else if (age) {
                patientIntroLine = `Paziente di ${age} anni`;
            } else if (sexValue) {
                patientIntroLine = (sexValue === "male") ? `Paziente uomo` : `Paziente donna`;
            }
            let score2Result = null;
            const score2ErrorDiv = document.getElementById("score2-error");
            const score2ResultDisplay = document.getElementById("score2-result-display");
            score2ErrorDiv.textContent = ""; score2ResultDisplay.textContent = "-";
            if (ageNum >= 40 && ageNum <= 69) score2Result = calculateScore2();
            else score2ErrorDiv.textContent = "Calcolo SCORE2 non applicabile (etÃ  fuori range 40-69 anni).";
            let score2OutputText = "";
            if (score2Result !== null && !isNaN(score2Result)) {
                const regionTextMap = { 1: "Basso", 2: "Moderato", 3: "Alto", 4: "Molto Alto" };
                const regionRadio = document.querySelector('input[name="risk_region"]:checked');
                const regionVal = regionRadio ? regionRadio.value : '2';
                const regionName = regionTextMap[regionVal] || "Non specificata";
                score2OutputText = `Rischio CVD a 10 anni (SCORE2 - Regione ${regionName}): ${score2Result}%`;
            }
            const fattoriRischio = [];
            if (document.getElementById("fumo").checked) fattoriRischio.push("Fumo Attuale");
            if (document.getElementById("pregresso-fumo").checked) fattoriRischio.push("Pregresso fumo di sigaretta");
            if (document.getElementById("diabete").checked) fattoriRischio.push("Diabete");
            if (document.getElementById("ipertensione").checked) fattoriRischio.push("Ipertensione");
            if (document.getElementById("ipercolesterolemia").checked) fattoriRischio.push("Ipercolesterolemia");
            if (document.getElementById("obesita").checked) fattoriRischio.push("ObesitÃ ");
            if (document.getElementById("familiarita").checked) fattoriRischio.push("FamiliaritÃ  positiva per MCV");
            const fattoriRischioRaw = fattoriRischio.length > 0 ? fattoriRischio.join("; ") : "Nessuno";
            const fattoriRischioText = formatText(fattoriRischioRaw + (score2OutputText ? `\n${score2OutputText}` : ""), indent);
            const anamnesiFamiliareRaw = document.getElementById("anamnesi-familiare").value;
            const anamnesiFamiliareDefault = "Nessuna familiaritÃ  riferita per malattia coronarica precoce (M <55, F <65), morte improvvisa o cardiomiopatie ereditarie.";
            const anamnesiFamiliareText = formatText(anamnesiFamiliareRaw || anamnesiFamiliareDefault, indent);
            const anamnesiRemotaRaw = document.getElementById("anamnesi-remota").value;
            const anamnesiRemotaText = formatText(anamnesiRemotaRaw || "Priva di rilievi significativi", indent);
            const anamnesiCvRaw = document.getElementById("anamnesi-cv").value;
            const anamnesiCvText = formatText(anamnesiCvRaw || "Non riferisce precedenti eventi cardiovascolari", indent);
            let terapia = [];
            for (let i = 1; i <= 7; i++) {
                const farmaco = document.getElementById(`farmaco${i}`).value.trim();
                const dose = document.getElementById(`dose${i}`).value.trim();
                if (farmaco) terapia.push(`${farmaco}${dose ? ` ${dose} mg` : ""}`);
            }
            const terapiaRaw = terapia.length > 0 ? terapia.join("; ") : "Nessuna";
            const terapiaText = formatText(terapiaRaw, indent);
            const sintomatologiaRaw = document.getElementById("sintomatologia").value;
            const sintomatologiaText = formatText(sintomatologiaRaw || "Non riferite palpitazioni, dolore toracico anginoso, dispnea, sincope.", indent);
            const esamePolmonareRaw = document.getElementById("esame-polmonare").value;
            const esamePolmonareDefault = "Murmure vescicolare normotrasmesso, non rumori patologici aggiunti, non stasi";
            const esamePolmonareText = formatText(`TORACE: ${esamePolmonareRaw || esamePolmonareDefault}`, indent);
            const esameCardiacoRaw = document.getElementById("esame-cardiaco").value;
            const esameCardiacoDefault = "Toni cardiaci netti in successione ritmica, pause libere. Buono il compenso emodinamico";
            const esameCardiacoText = formatText(`CUORE: ${esameCardiacoRaw || esameCardiacoDefault}`, indent);

            // PAO + commento SOLO in caso di ipertensione (grado 1â3 o ISH) con dash semplice
            const paoRaw = document.getElementById("pao").value.trim();
            const paoVal = paoRaw || "Non rilevata";
            let paoLine = `PAO: ${paoVal}`;
            if (paoRaw) {
                const { sbp: sbpOut, dbp: dbpOut } = parseBPString(paoRaw);
                const catOut = classifyOfficeBP(sbpOut, dbpOut);
                if (catOut) paoLine += ` - ${catOut}`;
            }
            const paoText = formatText(paoLine, indent);

            const eoText = [esamePolmonareText, esameCardiacoText, paoText].filter(text => text).join('\n');
            const ecgInputText = document.getElementById("ecg");
            const ecgRaw = ecgInputText.value.trim();
            const ecgText = formatText(ecgRaw, indent);
            const ecoRaw = document.getElementById("eco-text").value.trim();
            const ecoContent = ecoRaw ? formatText(ecoRaw, indent) : "";
            const ecoSectionOutput = ecoContent ? formatSection("ECOCARDIOGRAMMA COLOR DOPPLER", ecoContent, indent, sectionSeparator) : "";
            const sforzoRaw = document.getElementById("sforzo-text").value.trim();
            const sforzoContent = sforzoRaw ? formatText(sforzoRaw, indent) : "";
            const sforzoSectionOutput = sforzoContent ? formatSection("TEST DA SFORZO", sforzoContent, indent, sectionSeparator) : "";
            let ematochimiciRaw = "Non disponibili.";
            const ematoRadio = document.querySelector('input[name="emato-tipo"]:checked');
            if (ematoRadio) {
                const ematoTextVal = document.getElementById("emato-text").value.trim();
                if (ematoTextVal && ematoTextVal !== "Nei limiti di norma") ematochimiciRaw = ematoTextVal;
                else if (ematoRadio.id === "emato-nei-limiti") ematochimiciRaw = "Nei limiti di norma";
            }
            const formattedEmato = formatText(ematochimiciRaw, indent);
            const ematochimiciText = formattedEmato || formatText("Non disponibili.", indent);
            const consigliCheckboxes = [
                { id: "consiglio-terapia", text: "Continuare la terapia in atto praticata." },
                { id: "consiglio-angio-tc", text: "Utile eseguire angio-TC coronarica." },
                { id: "consiglio-holter", text: "Utile eseguire ECG-Holter delle 24h." },
                { id: "consiglio-eco", text: "Utile eseguire EcocolorDoppler cardiaco." },
                { id: "consiglio-imaging", text: "Utile eseguire test di imaging non invasivo (ecocardiogramma da stress, scintigrafia miocardica, risonanza magnetica cardiaca da stress)." },
                { id: "consiglio-no-accertamenti", text: "In atto non necessari ulteriori accertamenti." },
                { id: "consiglio-ematochimici", text: "Utile eseguire esami ematochimici completi." }
            ];
            const consigliSelezionati = consigliCheckboxes
                .filter(item => document.getElementById(item.id).checked)
                .map(item => item.text.replace(/\.$/, ""));
            
            let conclusioniCustom = document.getElementById("conclusioni-custom").value.trim();
            let conclusioniRaw = "";
            if (consigliSelezionati.length > 0) conclusioniRaw = consigliSelezionati.join(". ") + ".";
            if (conclusioniCustom) conclusioniRaw += (conclusioniRaw ? "\n" : "") + conclusioniCustom;
            if (!conclusioniRaw) conclusioniRaw = "Esame obiettivo e strumentale nei limiti della norma. Non evidenza di patologia cardiovascolare in atto.";
            if (aggiungereConsigliLipidi) conclusioniRaw += "\n" + consigliLipidiText.trim();
            const conclusioniText = formatText(conclusioniRaw, indent);

            const includeContactInfo = document.getElementById("include-contact-info-cb").checked;
            const contattiContent = includeContactInfo ? formatText("Per qualsiasi informazione, domanda o chiarimento scrivere a:\nbenjamin.deornelas@santagostino.it", indent) : "";
            const contattiSectionOutput = contattiContent ? formatSection("", contattiContent, indent, "") : "";
            let output = [
                formatSection("", formatText(patientIntroLine, ""), "", sectionSeparator),
                formatSection("FATTORI DI RISCHIO CARDIOVASCOLARE", fattoriRischioText, indent, sectionSeparator),
                formatSection("ANAMNESI FAMILIARE", anamnesiFamiliareText, indent, sectionSeparator),
                formatSection("ANAMNESI PATOLOGICA REMOTA", anamnesiRemotaText, indent, sectionSeparator),
                formatSection("ANAMNESI CARDIOVASCOLARE", anamnesiCvText, indent, sectionSeparator),
                formatSection("TERAPIA IN ATTO", terapiaText, indent, sectionSeparator),
                formatSection("SINTOMATOLOGIA RIFERITA", sintomatologiaText, indent, sectionSeparator),
                formatSection("ESAME OBIETTIVO", eoText, indent, sectionSeparator),
                formatSection("ECG", ecgText, indent, sectionSeparator),
                ecoSectionOutput,
                sforzoSectionOutput,
                formatSection("ESAMI EMATOCHIMICI", ematochimiciText, indent, sectionSeparator),
                formatSection("CONCLUSIONI E RACCOMANDAZIONI TERAPEUTICHE", conclusioniText, indent, sectionSeparator),
                contattiSectionOutput
            ].filter(section => section && section.trim()).join("");

            // Opzioni compatibilitÃ  stampa
            const asciiMode = document.getElementById("compat-ascii").checked;
            const useCRLF = document.getElementById("compat-crlf").checked;
            const mode = asciiMode ? 'ascii' : 'latin1';
            output = sanitizeForPrint(output, mode);
            output = normalizeLineEndings(output, useCRLF);

            document.getElementById("output-visita").value = output.trim();
            try { if (window.bdoRunAIReview) window.bdoRunAIReview(); } catch(e) {}
            navigator.clipboard.writeText(output.trim()).then(() => {
                showAndHideNotification('copy-notification', true);
                aggiungereConsigliLipidi = false;
                document.getElementById('aggiungi-consigli-lipidi-cb').checked = aggiungereConsigliLipidi;
                document.getElementById('copia-template-sforzo-cb').checked = false;
                document.getElementById('copia-test-secondaria-cb').checked = false;
                document.getElementById('aggiungi-lipidi-notification-cb').style.display = 'none';
                document.getElementById('include-contact-info-notification-cb').style.display = 'none';
            }).catch(err => {
                alert("Non Ã¨ stato possibile copiare il testo automaticamente.");
                document.getElementById('aggiungi-consigli-lipidi-cb').checked = aggiungereConsigliLipidi;
                document.getElementById('copia-template-sforzo-cb').checked = false;
                document.getElementById('copia-test-secondaria-cb').checked = false;
                document.getElementById('aggiungi-lipidi-notification-cb').style.display = 'none';
                document.getElementById('include-contact-info-notification-cb').style.display = 'none';
            });
        }

        function showAndHideNotification(notificationId, isMainNotification = false) {
            const notification = document.getElementById(notificationId);
            if (!notification) return;
            notification.style.display = isMainNotification ? "block" : "inline";
            setTimeout(() => notification.style.display = "none", 3000);
        }

        function copiaTestSecondaria(notificationId) {
            const testoDaCopiare = "Si richiedono esami ematochimici comprensivi di Creatinina, Potassio, Sodio, TSH, rapporto Aldosterone/Renina (ARR). Esame urine completo con rapporto Albumina/Creatinina (ACR). EcoDoppler delle Arterie Renali.";
            navigator.clipboard.writeText(testoDaCopiare).then(() => {
                showAndHideNotification(notificationId);
                setTimeout(() => { document.getElementById('copia-test-secondaria-cb').checked = false; }, 100);
            }).catch(err => {
                alert("Non Ã¨ stato possibile copiare il testo negli appunti.");
            });
        }

        function copiaTemplateSforzo(notificationId) {
            const templateText = `Indicazione al test: valutazione riserva coronarica e capacitÃ  funzionale.
Terapia in corso: nessuna.
ECG basale: ritmo sinusale. Normale conduzione AV e IV. Ripolarizzazione ventricolare normale.
Test eseguito al cicloergometro mediante incremento di carico di watt ogni minuto; interrotto per esaurimento muscolare.
Carico max tollerato: watt, pari al % del teorico max atteso.
Potenza aerobica max: METS.
Risposta cronotropa ai carichi nei limiti; FC max raggiunta pari al % della FC max teorica.
Normale risposta pressoria allo sforzo.
Modificazioni ECG significative: no.
Aritmie: no.
Sintomi: no.
CONCLUSIONI:
Test negativo per ridotta riserva coronarica.
CapacitÃ  funzionale normale.`;
            navigator.clipboard.writeText(templateText).then(() => {
                showAndHideNotification(notificationId);
                setTimeout(() => { document.getElementById('copia-template-sforzo-cb').checked = false; }, 100);
            }).catch(err => {
                alert("Non Ã¨ stato possibile copiare il template negli appunti.");
            });
        }

        function updateSbpFromPao() {
            const paoInput = document.getElementById("pao");
            const sbpInput = document.getElementById("sbp");
            const ageInput = document.getElementById("age");
            const bpBadge = document.getElementById("bp-category-display");

            const paoValue = paoInput.value.trim();
            const { sbp, dbp } = parseBPString(paoValue);

            sbpInput.value = (!isNaN(sbp)) ? sbp : '';

            const category = classifyOfficeBP(sbp, dbp);
            if (category) { bpBadge.style.display = "block"; bpBadge.textContent = category; }
            else { bpBadge.style.display = "none"; bpBadge.textContent = ""; }

            const ageVal = parseInt(ageInput.value, 10);
            if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) calculateScore2();
            else {
                document.getElementById("score2-result-display").textContent = "-";
                const score2ErrorDiv = document.getElementById("score2-error");
                if (isNaN(ageVal) || ageVal < 1) score2ErrorDiv.textContent = "Inserire etÃ  valida.";
                else if (ageVal < 40 || ageVal > 69) score2ErrorDiv.textContent = "EtÃ  fuori range 40-69 per SCORE2.";
                else score2ErrorDiv.textContent = "";
                if (!isNaN(ageVal) && (ageVal >= 40 && ageVal <= 69) && sbpInput.value === '') {
                    score2ErrorDiv.textContent = "Inserire SBP valida (es. dal campo PAO).";
                }
            }
        }

        function aggiornaEco() {
            const ecoNormale = document.getElementById("eco-normale").checked;
            const ecoAnziano = document.getElementById("eco-anziano").checked;
            const ecoText = document.getElementById("eco-text");
            if (ecoNormale) {
                ecoText.value = `Diametri e volumi del ventricolo sinistro nella norma.
Spessori settali e parietali nella norma.
Non si evidenziano alterazioni della cinesi segmentaria.
Conservati gli indici di contrattilitÃ  globale.
Normali dimensioni dell'atrio sinistro.
Morfologia e dinamica dei lembi mitralici nei limiti della norma.
Presenza di minimo jet da rigurgito valvolare mitralico.
Flussimetria transvalvolare indicativa di normali pressioni di riempimento del ventricolo sinistro.
Morfologia e dinamica delle semilunari aortiche nei limiti della norma.
Non jet da insufficienza valvolare ecograficamente visualizzabili.
Nei limiti della norma le velocitÃ  del flusso transvalvolare aortico.
Nei limiti della norma il diametro della radice aortica e dell'aorta ascendente.
Normali morfologia e dimensioni delle camere destre.
Lieve jet da insufficienza tricuspidalica parafisiologico da cui si stima una pressione polmonare nei limiti della norma.
Setto interatriale apparentemente integro.
Non versamento pericardico in atto.`;
            } else if (ecoAnziano) {
                ecoText.value = `Ventricolo sinistro di normali dimensioni con spessori di parete nei limiti.
Buona la funzione ventricolare sinistra: FE 60%.
Non evidenti difetti di cinesi segmentaria.
Atrio sinistro nei limiti, lembi mitralici lievemente ispessiti.
Bulbo aortico di normali dimensioni, valvola aortica tricuspide, semilunari aortiche lievemente ispessite, apertura valvolare conservata, aorta ascendente nei limiti.
Sezioni destre nei limiti con funzione conservata.
VCI di normali dimensioni con escursioni respiratorie conservate.
Pericardio indenne.
Doppler: Pattern transmitralico da alterato rilasciamento.
Insufficienza mitralica lieve.
Insufficienza tricuspidalica lieve con PAPs nei limiti.`;
            }
        }

        function aggiornaEmatochimici() {
            const ematoNeiLimiti = document.getElementById("emato-nei-limiti").checked;
            const ematoColesterolo = document.getElementById("emato-colesterolo").checked;
            const ematoText = document.getElementById("emato-text");
            if (ematoNeiLimiti) {
                ematoText.value = "Nei limiti di norma";
                ematoText.readOnly = true;
            } else if (ematoColesterolo) {
                ematoText.readOnly = false;
                if (!ematoText.value || ematoText.value === "Nei limiti di norma") {
                    ematoText.value = `Col tot: 
Col HDL: 
Col LDL: 
Trigliceridi: `;
                }
            } else { 
                const defaultCholesterolText = `Col tot: 
Col HDL: 
Col LDL: 
Trigliceridi: `;
                if (ematoText.value.trim() === defaultCholesterolText.trim() || ematoText.value === "Nei limiti di norma") {
                    ematoText.value = "";
                }
                ematoText.readOnly = false;
            }
        }
        
        function updateEmatochimiciFromScore() {
            const colTot = document.getElementById("col-tot").value.trim();
            const colHdl = document.getElementById("col-hdl").value.trim();
            const ldlCalculated = document.getElementById("ldl-calculated").value.trim();
            const trigliceridi = document.getElementById("trigliceridi-score").value.trim();
            
            if (!colTot && !colHdl && !trigliceridi) return;
            const ematoColesteroloRadio = document.getElementById("emato-colesterolo");
            const ematoText = document.getElementById("emato-text");
            ematoColesteroloRadio.checked = true;
            aggiornaEmatochimici();
            
            const textLines = [
                `Col tot: ${colTot ? colTot + " mg/dL" : ""}`,
                `Col HDL: ${colHdl ? colHdl + " mg/dL" : ""}`,
                `Col LDL: ${ldlCalculated && ldlCalculated !== "N/A" ? ldlCalculated + " mg/dL" : ""}`,
                `Trigliceridi: ${trigliceridi ? trigliceridi + " mg/dL" : ""}`
            ];
            ematoText.value = textLines.join("\n");
        }

        document.addEventListener("DOMContentLoaded", () => {
            const ageInput = document.getElementById("age");
            const paoInput = document.getElementById("pao");
            
            aggiornaEco();
            aggiornaEmatochimici();
            aggiornaSforzo();
            
            document.querySelectorAll('input[name="eco-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaEco));
            document.querySelectorAll('input[name="emato-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaEmatochimici));
            document.querySelectorAll('input[name="sforzo-tipo"]').forEach(radio => radio.addEventListener("change", aggiornaSforzo));
            
            document.getElementById('copia-template-sforzo-cb').addEventListener('change', (e) => { if (e.target.checked) copiaTemplateSforzo('copia-sforzo-notification-cb'); });
            document.getElementById('copia-test-secondaria-cb').addEventListener('change', (e) => { if (e.target.checked) copiaTestSecondaria('copia-secondaria-notification-cb'); });
            
            const aggiungiLipidiCb = document.getElementById('aggiungi-consigli-lipidi-cb');
            const lipidiNotif = document.getElementById('aggiungi-lipidi-notification-cb');
            aggiungiLipidiCb.addEventListener('change', () => {
                aggiungereConsigliLipidi = aggiungiLipidiCb.checked;
                lipidiNotif.style.display = aggiungereConsigliLipidi ? 'inline' : 'none';
                if (aggiungereConsigliLipidi) setTimeout(() => { lipidiNotif.style.display = 'none'; }, 3000);
            });
            
            const includeContactCb = document.getElementById('include-contact-info-cb');
            const contactNotif = document.getElementById('include-contact-info-notification-cb');
            includeContactCb.addEventListener('change', () => {
                contactNotif.style.display = includeContactCb.checked ? 'inline' : 'none';
                if (includeContactCb.checked) setTimeout(() => { contactNotif.style.display = 'none'; }, 3000);
            });
            
            paoInput.addEventListener('input', updateSbpFromPao);
            
            const scoreInputsIds = ["age", "sbp", "col-tot", "col-hdl", "fumo"];
            scoreInputsIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("input", () => {
                        const ageVal = parseInt(ageInput.value, 10);
                        if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) {
                            calculateScore2();
                        } else {
                            document.getElementById("score2-result-display").textContent = "-";
                            const score2ErrorDiv = document.getElementById("score2-error");
                            if (isNaN(ageVal) || ageVal < 1) score2ErrorDiv.textContent = "Inserire etÃ  valida.";
                            else if (ageVal < 40 || ageVal > 69) score2ErrorDiv.textContent = "EtÃ  fuori range 40-69 per SCORE2.";
                            else score2ErrorDiv.textContent = "";
                        }
                    });
                }
            });
            
            const scoreLipidInputsIds = ["col-tot", "col-hdl", "trigliceridi-score"];
            scoreLipidInputsIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("input", () => {
                        calculateAndDisplayLdl();
                        updateEmatochimiciFromScore();
                    });
                }
            });

            document.querySelectorAll('input[name="sex"], input[name="risk_region"]').forEach(radio => {
                radio.addEventListener("change", () => {
                    const ageVal = parseInt(ageInput.value, 10);
                    if (!isNaN(ageVal) && ageVal >= 40 && ageVal <= 69) {
                        calculateScore2();
                    }
                });
            });
            
            updateSbpFromPao();
            calculateAndDisplayLdl();
            
            const initialAge = parseInt(ageInput.value, 10);
            if (!isNaN(initialAge) && (initialAge < 40 || initialAge > 69)) {
                document.getElementById("score2-error").textContent = "EtÃ  fuori range 40-69 per SCORE2.";
                document.getElementById("score2-result-display").textContent = "-";
            } else if (!isNaN(initialAge)) {
                if (initialAge >= 40 && initialAge <= 69) calculateScore2();
            }
        });

        function aggiornaSforzo() {
            const sforzoNormale = document.getElementById("sforzo-normale").checked;
            const sforzoText = document.getElementById("sforzo-text");
            if (sforzoNormale) {
                sforzoText.value = "Test ergometrico massimale nei limiti della norma, senza evidenza di rilevanti anomalie cliniche o elettrocardiografiche (vedasi referto).";
            }
        }
    </script>
</head>

<body>
    <div class="container fade-in">
        <div class="header">
            <h1>ð« Compilazione Rapida Visita Cardiologica</h1>
        </div>

        <div class="section">
            <h2>ð¤ Informazioni Paziente</h2>
            <div class="form-row">
                <div>
                    <label for="age">EtÃ  (opzionale)</label>
                    <input type="number" id="age" name="age" min="1" placeholder="Anni (40-69 per SCORE2)">
                </div>
                <div>
                    <label>Sesso (opzionale)</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="sex-male" name="sex" value="male">
                            <label for="sex-male" class="label-inline">ð¨ Uomo</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="sex-female" name="sex" value="female">
                            <label for="sex-female" class="label-inline">ð© Donna</label>
                        </div>
                    </div>
                </div>
            </div>
            <span class="note">Se non inseriti, etÃ  e sesso non verranno stampati nell'output della visita.</span>
        </div>

        <div class="section">
            <h2>â ï¸ Fattori di Rischio e Calcolo SCORE2</h2>
            <div class="card">
                <label>Fattori di Rischio Generali</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="fumo" name="fumo"><label for="fumo" class="label-inline">ð¬ Fumo Attuale</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pregresso-fumo" name="pregresso-fumo"><label for="pregresso-fumo" class="label-inline">ð­ Pregresso fumo</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="diabete" name="diabete"><label for="diabete" class="label-inline">ð©¸ Diabete</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipertensione" name="ipertensione"><label for="ipertensione" class="label-inline">ð Ipertensione</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ipercolesterolemia" name="ipercolesterolemia"><label for="ipercolesterolemia" class="label-inline">ð§ª Ipercolesterolemia</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="obesita" name="obesita"><label for="obesita" class="label-inline">âï¸ ObesitÃ </label></div>
                    <div class="checkbox-item"><input type="checkbox" id="familiarita" name="familiarita"><label for="familiarita" class="label-inline">ð¨âð©âð§âð¦ FamiliaritÃ  positiva per MCV</label></div>
                </div>
            </div>

            <div class="score-section">
                <h3>ð Dati per Calcolo SCORE2 e LDL</h3>
                <div class="form-row">
                    <div>
                        <label for="pao">ð©º PAO (Esame Obiettivo)</label>
                        <input type="text" id="pao" name="pao" value="120/80 mmHg" placeholder="Es. 130/85 mmHg">
                        <span class="note">Il valore sistolico verrÃ  usato per SBP.</span>
                        <div id="bp-category-display" class="info-message" aria-live="polite" role="status" style="margin-top:6px; display:none;"></div>
                    </div>
                    <div>
                        <label for="sbp">ð« Pressione Sistemica (SBP)</label>
                        <input type="number" id="sbp" name="sbp" placeholder="mmHg (da PAO)" readonly>
                        <span class="note">Range suggerito: 100-200 mmHg</span>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label for="col-tot">ð§ª Colesterolo Totale</label>
                        <input type="number" id="col-tot" name="col-tot" placeholder="mg/dL">
                    </div>
                    <div>
                        <label for="col-hdl">â Colesterolo HDL</label>
                        <input type="number" id="col-hdl" name="col-hdl" placeholder="mg/dL">
                    </div>
                    <div>
                        <label for="trigliceridi-score">ð Trigliceridi</label>
                        <input type="number" id="trigliceridi-score" name="trigliceridi-score" placeholder="mg/dL">
                    </div>
                     <div>
                        <label for="ldl-calculated">ð Colesterolo LDL (calcolato)</label>
                        <input type="text" id="ldl-calculated" name="ldl-calculated" placeholder="mg/dL" readonly>
                        <span id="ldl-calculation-note" class="note">Calcolato con formula di Friedewald (valido per Trigliceridi < 400 mg/dL).</span>
                    </div>
                </div>

                <div class="info-message">
                    ð¡ I valori lipidici qui inseriti (incluso l'LDL calcolato) popoleranno automaticamente la sezione 'Esami Ematochimici'.
                </div>

                <div class="form-group">
                    <label>ð Regione di Rischio</label>
                    <div class="radio-group">
                        <div class="radio-item"><input type="radio" id="region-low" name="risk_region" value="1"><label for="region-low" class="label-inline">ð¢ Basso</label></div>
                        <div class="radio-item"><input type="radio" id="region-moderate" name="risk_region" value="2" checked=""><label for="region-moderate" class="label-inline">ð¡ Moderato (Italia)</label></div>
                        <div class="radio-item"><input type="radio" id="region-high" name="risk_region" value="3"><label for="region-high" class="label-inline">ð  Alto</label></div>
                        <div class="radio-item"><input type="radio" id="region-very-high" name="risk_region" value="4"><label for="region-very-high" class="label-inline">ð´ Molto Alto</label></div>
                    </div>
                </div>

                <div class="score-result">
                    <label style="font-size: 1.1em; margin-bottom: 10px;">ð¯ Rischio CVD a 10 anni (SCORE2)</label>
                    <div>
                        <span id="score2-result-display">-</span>
                    </div>
                    <span class="note">Questo valore apparirÃ  anche nel testo generato.</span>
                </div>

                <div id="score2-error" class="error-message"></div>
            </div>
        </div>

        <div class="section">
            <h2>ð§ Opzioni di output</h2>
            <div class="options-row">
                <div class="checkbox-item">
                    <input type="checkbox" id="compat-ascii">
                    <label for="compat-ascii" class="label-inline">CompatibilitÃ  stampa (ASCII puro, senza accenti nÃ© simboli)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="compat-crlf">
                    <label for="compat-crlf" class="label-inline">Forza ritorni a capo Windows (CRLF)</label>
                </div>
            </div>
            <span class="note">Se il gestionale stampa caratteri "?" abilita queste opzioni prima di compilare e copiare il testo.</span>
        </div>

        <div class="section">
            <h2>Anamnesi Familiare</h2>
            <textarea id="anamnesi-familiare" name="anamnesi-familiare" rows="3" placeholder="Descrivere anamnesi familiare...">Nessuna familiaritÃ  riferita per malattia coronarica precoce (M <55, F <65), morte improvvisa o cardiomiopatie ereditarie.</textarea>
        </div>

        <div class="section">
            <h2>Anamnesi Patologica Remota e Cardiovascolare</h2>
            <label for="anamnesi-remota">Patologica Remota:</label>
            <textarea id="anamnesi-remota" name="anamnesi-remota" rows="3" placeholder="Inserisci informazioni sull'anamnesi patologica remota">Priva di rilievi significativi</textarea>
            <label for="anamnesi-cv">Cardiovascolare:</label>
            <textarea id="anamnesi-cv" name="anamnesi-cv" rows="3" placeholder="Inserisci informazioni sull'anamnesi cardiovascolare (es. eventi passati)">Non riferisce precedenti eventi cardiovascolari</textarea>
        </div>

        <div class="section">
            <h2>ð Terapia in Atto</h2>
            <div class="terapia-row">
                <div><label>Farmaco 1</label><input type="text" id="farmaco1" placeholder="Nome farmaco"></div>
                <div><label>Dose</label><input type="text" id="dose1" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco2" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose2" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco3" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose3" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco4" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose4" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco5" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose5" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco6" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose6" placeholder="mg"></div>
            </div>
            <div class="terapia-row">
                <div><input type="text" id="farmaco7" placeholder="Nome farmaco"></div>
                <div><input type="text" id="dose7" placeholder="mg"></div>
            </div>
        </div>

        <div class="section">
            <h2>Sintomatologia</h2>
            <textarea id="sintomatologia" name="sintomatologia" rows="3" placeholder="Descrivere la sintomatologia riferita">Non riferite palpitazioni, dolore toracico anginoso, dispnea, sincope.</textarea>
        </div>

        <div class="section">
            <h2>Esame Obiettivo</h2>
            <label for="esame-polmonare">Polmonare:</label>
            <textarea id="esame-polmonare" name="esame-polmonare" rows="2" placeholder="Inserisci il risultato dell'esame polmonare">Murmure vescicolare normotrasmesso, non rumori patologici aggiunti, non stasi</textarea>
            <label for="esame-cardiaco">Cardiaco:</label>
            <textarea id="esame-cardiaco" name="esame-cardiaco" rows="2" placeholder="Inserisci il risultato dell'esame cardiaco">Toni cardiaci netti in successione ritmica, pause libere. Buono il compenso emodinamico</textarea>
            <p style="margin-top:15px;"><b>PAO:</b> Vedi valore inserito nella sezione Fattori di Rischio / SCORE2.</p>
        </div>

        <div class="section">
            <h2>ECG</h2>
            <textarea id="ecg" name="ecg" rows="3" placeholder="Inserisci il risultato dell'ECG">Ritmo sinusale a FC di 70 bpm, alterazioni aspecifiche del tratto ST-T</textarea>
        </div>

        <div class="section">
            <h2>Ecocardiogramma Color Doppler</h2>
            <input type="radio" id="eco-normale" name="eco-tipo" value="normale"><label for="eco-normale" class="label-inline">Normale</label><br>
            <input type="radio" id="eco-anziano" name="eco-tipo" value="anziano"><label for="eco-anziano" class="label-inline">Anziano</label><br>
            <input type="radio" id="eco-nessuno" name="eco-tipo" value="nessuno" checked=""><label for="eco-nessuno" class="label-inline">Manuale / Vuoto</label><br>
            <div id="eco-section" style="margin-top: 10px;">
                <label for="eco-text">Descrizione:</label>
                <textarea id="eco-text" name="eco-text" rows="10" placeholder="Seleziona un'opzione o inserisci manualmente il referto..."></textarea>
            </div>
        </div>

        <div class="section">
            <h2>Test da sforzo massimale cardiologico</h2>
            <input type="radio" id="sforzo-normale" name="sforzo-tipo" value="normale"><label for="sforzo-normale" class="label-inline">Non si rilevano alterazioni patologiche</label><br>
            <input type="radio" id="sforzo-nessuno" name="sforzo-tipo" value="altro" checked=""><label for="sforzo-nessuno" class="label-inline">Manuale / Vuoto</label><br>
            <div style="margin-top: 10px;">
                <label for="sforzo-text">Descrizione (per output visita):</label>
                <textarea id="sforzo-text" name="sforzo-text" rows="4" placeholder="Inserire breve descrizione o lasciare vuoto..."></textarea>
            </div>
            <div style="margin-top: 15px;">
                <input type="checkbox" id="copia-template-sforzo-cb"><label for="copia-template-sforzo-cb" class="label-inline">Copia Template Referto Sforzo</label>
                <span id="copia-sforzo-notification-cb" class="checkbox-notification success">Copiato!</span>
                <span class="note" style="display: block;">(Copia un modello dettagliato negli appunti)</span>
            </div>
        </div>

        <div class="section">
            <h2>Esami Ematochimici</h2>
            <input type="radio" id="emato-nei-limiti" name="emato-tipo"><label for="emato-nei-limiti" class="label-inline">Nei limiti</label><br>
            <input type="radio" id="emato-colesterolo" name="emato-tipo"><label for="emato-colesterolo" class="label-inline">Valori Colesterolo/Trigliceridi</label><br>
            <input type="radio" id="emato-non-disponibili" name="emato-tipo" checked=""><label for="emato-non-disponibili" class="label-inline">Manuale / Non Disponibili</label><br>
            <div style="margin-top: 10px;">
                <label for="emato-text">Valori:</label>
                <textarea id="emato-text" name="emato-text" rows="5" placeholder="I valori lipidici verranno popolati automaticamente..."></textarea>
            </div>
        </div>

        <div class="section">
            <h2>Conclusioni e Raccomandazioni Terapeutiche</h2>
            <input type="checkbox" id="consiglio-terapia"><label for="consiglio-terapia" class="label-inline">Confermare terapia in atto.</label><br>
            <input type="checkbox" id="consiglio-angio-tc"><label for="consiglio-angio-tc" class="label-inline">Indicazione ad angio-TC coronarica.</label><br>
            <input type="checkbox" id="consiglio-holter"><label for="consiglio-holter" class="label-inline">Indicazione ad ECG-Holter 24h.</label><br>
            <input type="checkbox" id="consiglio-eco"><label for="consiglio-eco" class="label-inline">Indicazione ad EcocolorDoppler cardiaco.</label><br>
            <input type="checkbox" id="consiglio-imaging"><label for="consiglio-imaging" class="label-inline">Indicazione a test imaging da stress (eco, scinti, RMN).</label><br>
            <input type="checkbox" id="consiglio-no-accertamenti"><label for="consiglio-no-accertamenti" class="label-inline">Non indicati ulteriori accertamenti.</label><br>
            <input type="checkbox" id="consiglio-ematochimici"><label for="consiglio-ematochimici" class="label-inline">Indicazione a controllo esami ematochimici completi.</label><br>
            <label for="conclusioni-custom" style="margin-top: 15px;">Note Aggiuntive:</label><br>
            <textarea id="conclusioni-custom" rows="3" placeholder="(Opzionale) Aggiungere testo libero..."></textarea>
            <div style="margin-top: 15px;">
                <input type="checkbox" id="aggiungi-consigli-lipidi-cb"><label for="aggiungi-consigli-lipidi-cb" class="label-inline">Aggiungi Consigli Lipidi</label>
                <span id="aggiungi-lipidi-notification-cb" class="checkbox-notification warning">Attivato!</span>
            </div>
            <div style="margin-top: 5px;">
                <input type="checkbox" id="copia-test-secondaria-cb"><label for="copia-test-secondaria-cb" class="label-inline">Copia Richiesta Esami Ipertensione Secondaria</label>
                <span id="copia-secondaria-notification-cb" class="checkbox-notification success">Copiato!</span>
            </div>
            <div style="margin-top: 5px;">
                <input type="checkbox" id="include-contact-info-cb"><label for="include-contact-info-cb" class="label-inline">Includi Contatti a Fine Visita</label>
                <span id="include-contact-info-notification-cb" class="checkbox-notification contact">Attivato!</span>
            </div>
        </div>

        <div class="section" id="output-visita-section">
            <h2>Output Visita (Testo Generato)</h2>
            <textarea id="output-visita" name="output-visita" rows="25" placeholder="L'output della visita verrÃ  generato qui..." readonly></textarea>
            <div id="copy-notification" class="copy-notification">Testo visita copiato negli appunti!</div>
            <div style="margin-top: 14px;">
                <button type="button" class="main-action" onclick="compilaVisita()">Compila Visita e Copia Testo</button>
            </div>
        </div>

        <div class="section" id="ai-review-section">
            <h2>Revisione AI (Italiano e Coerenza Clinica)</h2>
            <div class="ai-controls">
                <div class="ai-input" style="flex:1; min-width:280px;">
                    <label for="ai-api-key">OpenAI API Key</label>
                    <input type="password" id="ai-api-key" placeholder="sk-..." />
                    <span class="note">La chiave resta nel browser (puoi salvarla localmente).</span>
                </div>
                <div>
                    <label class="label-inline" for="ai-save-key"><input type="checkbox" id="ai-save-key" /> Ricorda chiave (localStorage)</label>
                </div>
                <div>
                    <button type="button" id="ai-run-btn" class="main-action" style="min-width:260px;">Analizza con AI</button>
                </div>
            </div>
            <div id="ai-status" class="info-message"></div>
            <div class="card" style="padding:0; border:none; box-shadow:none;">
                <h3 style="margin:0 0 6px 0; color: var(--accent-color);">Italiano corretto</h3>
                <textarea id="ai-italiano" readonly placeholder="Il testo corretto comparirÃ  qui..."></textarea>
                <div style="margin-top:8px; text-align:right;">
                    <button type="button" id="ai-copy-italiano" class="btn">Copia</button>
                </div>
            </div>
            <div class="card" style="padding:0; border:none; box-shadow:none; margin-top:18px;">
                <h3 style="margin:0 0 6px 0; color: var(--accent-color);">Segnalazioni errori e osservazioni cliniche</h3>
                <textarea id="ai-errori" readonly placeholder="Eventuali osservazioni cliniche compariranno qui..."></textarea>
                <div style="margin-top:8px; text-align:right;">
                    <button type="button" id="ai-copy-errori" class="btn">Copia</button>
                </div>
            </div>
        </div>

        
        <script>
        (function(){
          const $ = (sel) => document.querySelector(sel);
          const aiBtn = $('#ai-run-btn');
          const keyInput = $('#ai-api-key');
          const saveKeyCb = $('#ai-save-key');
          const statusEl = $('#ai-status');
          const outItEl = $('#ai-italiano');
          const outErrEl = $('#ai-errori');

          function autoResize(el){
            if (!el) return;
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight + 2) + 'px';
          }

          try {
            const saved = localStorage.getItem('bdo_ai_api_key');
            if (saved) { keyInput.value = saved; saveKeyCb.checked = true; }
          } catch (e) {}

          function setStatus(msg, type='info'){
            statusEl.textContent = msg;
            statusEl.className = type === 'error' ? 'error-message' : 'info-message';
            statusEl.style.display = msg ? 'block' : 'none';
          }

          // Prompt doppio passaggio
          function buildPromptPassA(referto){
            return (
              'Sei un medico cardiologo esperto di linee guida ESC (2021â2024).\n'+
              'Correggi esclusivamente lo stile e la forma del referto seguente, mantenendo titoli e struttura, senza cambiare i dati.\n'+
              'Usa solo testo semplice (plain text), nessun markdown o simboli.\n\n'+
              'OUTPUT OBBLIGATORIO:\n'+
              'REFERT_CORRETTO:\n'+
              referto
            );
          }

          function buildPromptPassB(refertoCorretto){
            return (
              'Sei un revisore clinico ESC.\n'+
              'Analizza il referto seguente e segnala contraddizioni interne o discrepanze rispetto alle linee guida ESC (SCORE2, PAO, lipidi, raccomandazioni).\n'+
              'Usa solo testo semplice (plain text), nessun markdown.\n\n'+
              'OUTPUT OBBLIGATORIO:\n'+
              'OSSERVAZIONI_CLINICHE_AI:\n'+
              '- [punto per ogni incongruenza].\n'+
              '- Se non trovi alcuna discrepanza, scrivi: Nessuna discrepanza rilevata.\n\n'+
              'REFERT_CORRETTO_DI_RIFERIMENTO:\n'+
              refertoCorretto
            );
          }

          function extractRefertoCorretto(text){
            if (!text) return '';
            const re = /REFERT[_\s]*CORRETTO\s*:\s*/i;
            const m = text.match(re);
            if (!m) return text.trim();
            const body = text.slice(m.index + m[0].length);
            const stop = body.search(/\n\s*(OSSERVAZIONI|NOTE|SEGNALAZIONI)[^\n]*\n/i);
            return (stop >= 0 ? body.slice(0, stop) : body).trim();
          }

          function extractOsservazioni(text){
            if (!text) return '';
            const re = /OSSERVAZIONI[_\s]*CLINICHE[_\s]*\(?(AI|IA)\)?\s*:\s*/i;
            const m = text.match(re);
            if (!m) return text.trim();
            const body = text.slice(m.index + m[0].length).trim();
            return body;
          }

          function runLocalConsistencyChecks(referto){
            const bullets = [];
            const t = referto.toLowerCase();
            const hasNoFurther = /(non\s+(necessari|indicati).{0,40}accertamenti)/i.test(referto) || /in\s+atto\s+non\s+necessari\s+ulteriori\s+accertamenti/i.test(referto);
            const hasAdvice = /(utile|indicazione|si\s+consiglia|si\s+raccomanda).{0,100}(esami|holter|angio|tc|risonanza|ecg|eco|test)/i.test(referto);
            if (hasNoFurther && hasAdvice) bullets.push('Contraddizione: dichiarati non necessari ulteriori accertamenti ma presenti raccomandazioni di esami.');

            const terapiaSection = /TERAPIA\s+IN\s+ATTO[\s\S]*?(\n\n|$)/i.exec(referto);
            if (terapiaSection) {
              const content = terapiaSection[0];
              const saysNone = /nessuna/i.test(content);
              const hasDrugs = /(\bmg\b|atorvastatina|rosuvastatina|metoprololo|ramipril|amlodipina|aspirina|ticagrelor|clopidogrel|ezetimibe)/i.test(referto);
              if (saysNone && hasDrugs) bullets.push('Contraddizione: âNessuna terapia in attoâ ma sono elencati farmaci altrove.');
            }

            const paoMatch = /PAO\s*:\s*(\d{2,3})\s*\/\s*(\d{2,3})/i.exec(referto);
            if (paoMatch) {
              const sbp = parseInt(paoMatch[1],10), dbp = parseInt(paoMatch[2],10);
              const saysNorm = /(pao\s+nella\s+norma|pressione\s+nella\s+norma)/i.test(referto);
              if ((sbp>=140 || dbp>=90) && saysNorm) bullets.push('PAO elevata ma definita ânella normaâ. Verificare classificazione ipertensione.');
            }

            const saysNoSymptoms = /(assenza\s+di\s+sintomi|non\s+riferisce\s+sintomi)/i.test(t);
            const mentionsSymptoms = /(dispnea|dolore\s+toracico|sincope|palpitazioni)/i.test(t);
            if (saysNoSymptoms && mentionsSymptoms) bullets.push('Contraddizione tra âassenza di sintomiâ e sintomi riportati altrove.');

            const claimsNormalLipids = /(profilo\s+lipidico\s+normale|lipidi\s+nella\s+norma)/i.test(t);
            const recommendsLipidTx = /(terapia\s+ipolipemizzante|statina|ezetimibe)/i.test(t);
            if (claimsNormalLipids && recommendsLipidTx) bullets.push('Profilo lipidico dichiarato normale ma consigliata terapia ipolipemizzante.');

            return bullets;
          }

          function sanitizeMarkdown(s){
            if (!s) return '';
            let t = s.replace(/\r\n/g,'\n');
            // Remove common Markdown formatting markers
            t = t.replace(/\*\*/g, '');        // bold **
            t = t.replace(/__/g, '');            // bold __
            t = t.replace(/`+/g, '');            // code backticks
            t = t.replace(/^\s*>\s?/gm, '');    // blockquote >
            t = t.replace(/^#{1,6}\s*/gm, '');   // headings #
            t = t.replace(/\u2022\s+/g, '- ');  // bullet â¢ to dash
            // Normalize bullet markers starting with * to "- "
            t = t.replace(/^\s*\*+\s+/gm, '- ');
            // Replace en/em dashes with simple hyphen
            t = t.replace(/[\u2013\u2014]/g, '-');
            // Remove italics underscores around words _text_
            t = t.replace(/_(.*?)_/g, '$1');
            return t.trim();
          }

          async function runAI(){
            const key = (keyInput.value || '').trim();
            if (!key) { setStatus('Inserisci la tua OpenAI API key per procedere.', 'error'); return; }
            if (saveKeyCb.checked) {
              try { localStorage.setItem('bdo_ai_api_key', key); } catch(e){}
            } else {
              try { localStorage.removeItem('bdo_ai_api_key'); } catch(e){}
            }

            const referto = ($('#output-visita')?.value || '').trim();
            if (!referto) { setStatus('Genera prima il referto in "Output Visita".', 'error'); return; }

            setStatus('Analisi in corsoâ¦');
            aiBtn.disabled = true; aiBtn.textContent = 'Analisi in corsoâ¦';
            outItEl.value = ''; outErrEl.value = '';

            try {
              // Passaggio A: correzione linguistica (gpt-4o-mini, temp 0.3)
              const promptA = buildPromptPassA(referto);
              let resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  temperature: 0.3,
                  max_tokens: 3000,
                  presence_penalty: 0,
                  frequency_penalty: 0,
                  top_p: 1.0,
                  messages: [{ role: 'user', content: promptA }]
                })
              });
              if (!resp.ok) {
                // Fallback a modello maggiore
                resp = await fetch('https://api.openai.com/v1/chat/completions', {
                  method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                  body: JSON.stringify({ model: 'gpt-4o', temperature: 0.3, max_tokens: 3000, presence_penalty: 0, frequency_penalty: 0, top_p: 1.0, messages: [{ role:'user', content: promptA }] })
                });
                if (!resp.ok) { const t = await resp.text(); throw new Error(`HTTP ${resp.status}: ${t}`); }
              }
              let data = await resp.json();
              const contentA = data?.choices?.[0]?.message?.content || '';
              if (!contentA) throw new Error('Risposta vuota dal Passaggio A.');
              const refertoCorretto = sanitizeMarkdown(extractRefertoCorretto(contentA));
              outItEl.value = refertoCorretto; autoResize(outItEl);

              // Passaggio B: osservazioni cliniche (gpt-4o, temp 0.0 deterministica)
              const promptB = buildPromptPassB(refertoCorretto);
              resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model:'gpt-4o', temperature:0.0, max_tokens:2000, presence_penalty:0, frequency_penalty:0, top_p: 1.0, messages:[{ role:'user', content: promptB }] })
              });
              if (!resp.ok) {
                resp = await fetch('https://api.openai.com/v1/chat/completions', {
                  method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                  body: JSON.stringify({ model:'gpt-4o-mini', temperature:0.0, max_tokens:2000, presence_penalty:0, frequency_penalty:0, top_p: 1.0, messages:[{ role:'user', content: promptB }] })
                });
                if (!resp.ok) { const t2 = await resp.text(); throw new Error(`HTTP ${resp.status}: ${t2}`); }
              }
              data = await resp.json();
              let osservazioni = sanitizeMarkdown(extractOsservazioni(data?.choices?.[0]?.message?.content || ''));
              const extra = runLocalConsistencyChecks(refertoCorretto);
              if (extra.length) {
                const existing = osservazioni ? osservazioni.split(/\n+/).map(s=>s.trim()).filter(Boolean) : [];
                const merged = new Set(existing.concat(extra.map(b=>`- ${b}`)));
                osservazioni = Array.from(merged).join('\n');
              }
              if (!osservazioni) osservazioni = '- Nessuna discrepanza rilevata';
              outErrEl.value = osservazioni; autoResize(outErrEl);
              setStatus('Analisi completata.', 'info');
            } catch (err) {
              console.error(err);
              setStatus('Errore durante la chiamata API: '+ err.message, 'error');
            } finally {
              aiBtn.disabled = false; aiBtn.textContent = 'Analizza con AI';
            }
          }

          aiBtn?.addEventListener('click', runAI);
          // Esporta per uso da compilaVisita()
          window.bdoRunAIReview = runAI;
          $('#ai-copy-italiano')?.addEventListener('click', ()=>{
            if (outItEl.value) navigator.clipboard.writeText(outItEl.value);
          });
          $('#ai-copy-errori')?.addEventListener('click', ()=>{
            if (outErrEl.value) navigator.clipboard.writeText(outErrEl.value);
          });
        })();
        </script>

        
    </div>
</body>
</html>
